# 3.4.2 Withdraw Registration

## 1. Use Case Description

| Field              | Description                                                                                                                    |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Withdraw Registration                                                                                                          |
| **Description**    | This use case allows the Bidder to delete a Auction Registration information in the system.                                    |
| **Actor**          | Bidder                                                                                                                         |
| **Trigger**        | When the Bidder clicks on the [Icon Delete] button on the right of each item on the RegistrationWithdrawalPage datagrid.       |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.                              |
| **Post-condition** | The Auction Registration information will be removed from the system and display data change on RegistrationListPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "RegistrationWithdrawalPage" as View
control "RegistrationController" as Controller
control "RegistrationService" as Service
database "ParticipantRepository" as ParticipantRepo
database "AuctionRepository" as AuctionRepo

User -> View: Click "Withdraw Registration"
View -> Controller: POST /register-to-bid/withdraw\n{ auctionId }
activate Controller

Controller -> Service: withdrawRegistration(auctionId, userId)
activate Service

Service -> ParticipantRepo: findParticipantAndAuction(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> Service: ParticipantEntity, AuctionEntity
deactivate ParticipantRepo

alt Participant Not Found or Already Withdrawn
    Service --> Controller: Throw NotFoundException/BadRequestException
    Controller --> View: 404/400 Error
    View --> User: Display Error Message
else Participant Found
    Service -> Service: Validate Withdrawal Conditions
    note right: BR-03

    alt Withdrawal Not Allowed
        Service --> Controller: Throw BadRequestException\n("Cannot withdraw at this stage")
        Controller --> View: 400 Bad Request
        View --> User: Display Error Message
    else Withdrawal Allowed
        Service -> ParticipantRepo: updateStatus(\n  { userId, auctionId }, 'WITHDRAWN'\n)
        activate ParticipantRepo
        ParticipantRepo --> Service: UpdatedParticipantEntity
        deactivate ParticipantRepo

        Service --> Controller: SuccessResponse
        Controller --> View: 200 OK (Registration Withdrawn)
        View --> User: Receive Confirmation of Withdrawal
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Bidder|
start
:(1) Initiate Withdrawal;

|RegistrationService|
:(2) Authenticate Requestor;
:(3) Verify Bidder Role;
note right: BR-01

|ParticipantRepository|
:(4) Retrieve AuctionParticipant Record;

|AuctionRepository|
:(5) Retrieve Associated Auction Details;

|RegistrationService|
if (Participant Not Found?) then (Yes)
    :(6.1) Return 404 Not Found;
    |Bidder|
    :(6.2) View Error Message;
    stop
endif

if (Current Status is Already WITHDRAWN?) then (Yes)
    :(7.1) Return 400 Bad Request;
    |Bidder|
    :(7.2) View Error Message;
    stop
endif

|RegistrationService|
:(8) Check Withdrawal Conditions;
note right: BR-03

if (Withdrawal Not Allowed?) then (Yes)
    :(9.1) Return 400 Bad Request;
    |Bidder|
    :(9.2) View Error Message;
    stop
endif

|ParticipantRepository|
:(10) Update AuctionParticipant Status to WITHDRAWN;
note right: BR-04

|RegistrationService|
:(11) Return Success Confirmation;
:(12) Trigger Deposit Refund Process (Async);
note right: BR-05

|Bidder|
:(13) Receive Confirmation of Withdrawal;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                    |
| :------- | :-------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Querying Rule:**<br>System queries data in the table 'AUCTION_PARTICIPANT' in the database (Refer to 'AUCTION_PARTICIPANT' table in 'DB Sheet' file) based on the auction ID and user ID.<br>Call method `displayRegistrationDetails(registration)` to show current status.                                                                  |
| **(1)**  | **BR-02** | **Displaying Rule:**<br>The system displays a 'Confirmation message box' screen. (Refer to View Description) with **MSG 11** (Confirm withdrawal?).<br>Shows current registration status and 'Cancel' / 'Confirm Withdrawal' buttons.                                                                                                          |
| **(1)**  | **BR-03** | **Selecting Rule:**<br>User selects button. If 'Cancel', use `Close()` to end.<br>If 'Confirm Withdrawal', call method `withdrawRegistration(auctionId, userId)`.                                                                                                                                                                              |
| **(8)**  | **BR-04** | **Validation Rule (Withdrawal Window):**<br>System checks withdrawal conditions: auctionStartAt must be in future, bidder must not have checkedInAt.<br>If either fails → display **MSG 18** (Cannot withdraw at this stage), return 400.                                                                                                      |
| **(10)** | **BR-05** | **Validation Rule (Back-end/Save):**<br>The Registration information will be updated in table 'AUCTION_PARTICIPANT' in the database (Refer to 'AUCTION_PARTICIPANT' table in 'DB Sheet' file) to set the status as 'WITHDRAWN'.<br>Trigger async deposit refund process.<br>Show **MSG 7** (Success), use `Close()`, update registration list. |
