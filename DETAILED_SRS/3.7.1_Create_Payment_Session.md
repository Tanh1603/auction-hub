# 3.7.1 Create Payment Session

## 1. Use Case Description

| Field              | Description                                                                                                                                                                           |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Create Payment Session                                                                                                                                                                |
| **Description**    | This use case allows the User to create a Payment Session in the system. This handles the creation of a checkout session for deposits, participation fees, or final winning payments. |
| **Actor**          | Bidder, Winner                                                                                                                                                                        |
| **Trigger**        | When the User initiates payment via other use cases (e.g., "Submit Deposit Payment", "Initiate Winner Payment") or directly via `POST /payments` for generic payment flows.           |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.                                                                                         |
| **Post-condition** | A Payment record is created in the database with status `pending` and a Stripe Checkout Session URL is generated and returned to the User in the system.                              |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "PaymentInitiationPage" as View
control "PaymentController" as Controller
control "PaymentService" as Service
database "AuctionRepository" as AuctionRepo
database "StripeService" as Stripe
database "PaymentRepository" as PaymentRepo

User -> View: Initiate Payment
View -> Controller: POST /payments\n{ auctionId, amount, type }
activate Controller

Controller -> Service: createPaymentSession(dto, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Validate Payment Request
note right: BR-01, BR-02

Service -> Stripe: checkout.sessions.create({...})
activate Stripe
Stripe --> Service: Session Object (id, url)
deactivate Stripe

Service -> PaymentRepo: create({sessionId, amount, status: 'pending', ... })
activate PaymentRepo
PaymentRepo --> Service: PaymentEntity
deactivate PaymentRepo

Service --> Controller: { url: string }
Controller --> View: 200 OK (Redirect JSON)
View --> User: Redirect to Stripe
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Request Payment;

|PaymentService|
:(2) Authenticate Requestor;
:(3) Validate Payment Details (Amount, Type);

if (Validation Failed?) then (Yes)
    :(4.1) Return 400 Bad Request;
    |User|
    :(4.2) View Error Message;
    stop
endif

|PaymentService|
:(5) Prepare Stripe Session Config;
note right: BR-03 (Success/Cancel URLs)

|StripeService|
:(6) Create Checkout Session;
:(7) Return Session ID & URL;

|PaymentRepository|
:(8) Save Pending Payment Record;

|PaymentService|
:(9) Return URL;

|User|
:(10) Redirect to Payment Gateway;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :---------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**     | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “PaymentInitiationPage” screen via `Display_View()`. (Refer to “PaymentInitiationPage” view in “View Description” file).<br>❖ The screen shows the [Payment Amount], a selection for the [Payment Type] (e.g., Deposit, Winning Payment), and a [Pay] button.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(1)**     | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user clicks “Proceed to Payment”, the system triggers a confirmation modal via `Display_Modal('ConfirmationBox')`.<br>❖ It presents **MSG 11** ("Proceed with [type] payment of [amount]?"), awaiting explicit confirmation before creating the payment session.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(2)-(3)** | **BR-03** | **Validation Rules (Back-end):**<br>❖ The system validates the requested `paymentType` by calling `PaymentService.validatePaymentType()`.<br>❖ If the input is not valid:<br>⮚ If the requested [paymentType] is not 'deposit' or 'winning_payment', the system returns a 400 Bad Request.<br>⮚ It displays **MSG 9** (Invalid payment type) on the View.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(3)**     | **BR-04** | **Validation Rules (Back-end):**<br>❖ The system validates the payment [amount] by calling `PaymentService.validateAmount(amount, type, auctionId)`.<br>❖ It checks that the [amount] is positive and matches the expected context.<br>❖ If the [paymentType] is 'deposit', the [amount] must exactly match `Auction.depositAmountRequired`.<br>❖ If the input is not valid, the system returns a 400 Bad Request and displays **MSG 4** (Invalid amount).                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(5)**     | **BR-05** | **Processing Rules (Stripe Configuration):**<br>❖ The system configures the Stripe checkout session by calling `StripeService.createCheckoutSession()`.<br>❖ It sets up `line_items` with the [amount] and currency.<br>❖ The `mode` is set to 'payment', and `success_url` and `cancel_url` are configured for redirects.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(8)**     | **BR-06** | **Storing Rules (Back-end):**<br>❖ The system creates a new record in the “PAYMENT” table via `PaymentRepository.create()`.<br>❖ It records the [sessionId] from Stripe, the [amount], sets the [status] to 'pending', and records the [type] of payment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(10)**    | **BR-07** | **Displaying Rules (Redirect):**<br>❖ The system returns the Stripe Checkout URL to the client.<br>❖ The client’s browser is then redirected to the external payment gateway page.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |