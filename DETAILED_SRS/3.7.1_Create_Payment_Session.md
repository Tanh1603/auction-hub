# 3.7.1 Create Payment Session

## 1. Use Case Description

| Field              | Description                                                                                                                                                                           |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Create Payment Session                                                                                                                                                                |
| **Description**    | This use case allows the User to create a Payment Session in the system. This handles the creation of a checkout session for deposits, participation fees, or final winning payments. |
| **Actor**          | Bidder, Winner                                                                                                                                                                        |
| **Trigger**        | When the User initiates payment via other use cases (e.g., "Submit Deposit Payment", "Initiate Winner Payment") or directly via `POST /payments` for generic payment flows.           |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.                                                                                         |
| **Post-condition** | A Payment record is created in the database with status `pending` and a Stripe Checkout Session URL is generated and returned to the User in the system.                              |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "PaymentInitiationPage" as View
control "PaymentController" as Controller
control "PaymentService" as Service
database "AuctionRepository" as AuctionRepo
database "StripeService" as Stripe
database "PaymentRepository" as PaymentRepo

User -> View: Initiate Payment
View -> Controller: POST /payments\n{ auctionId, amount, type }
activate Controller

Controller -> Service: createPaymentSession(dto, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Validate Payment Request
note right: BR-01, BR-02

Service -> Stripe: checkout.sessions.create({...})
activate Stripe
Stripe --> Service: Session Object (id, url)
deactivate Stripe

Service -> PaymentRepo: create({sessionId, amount, status: 'pending', ... })
activate PaymentRepo
PaymentRepo --> Service: PaymentEntity
deactivate PaymentRepo

Service --> Controller: { url: string }
Controller --> View: 200 OK (Redirect JSON)
View --> User: Redirect to Stripe
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Request Payment;

|PaymentService|
:(2) Authenticate Requestor;
:(3) Validate Payment Details (Amount, Type);

if (Validation Failed?) then (Yes)
    :(4.1) Return 400 Bad Request;
    |User|
    :(4.2) View Error Message;
    stop
endif

|PaymentService|
:(5) Prepare Stripe Session Config;
note right: BR-03 (Success/Cancel URLs)

|StripeService|
:(6) Create Checkout Session;
:(7) Return Session ID & URL;

|PaymentRepository|
:(8) Save Pending Payment Record;

|PaymentService|
:(9) Return URL;

|User|
:(10) Redirect to Payment Gateway;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                          |
| :---------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Displaying Rule (Payment Initiation Page):**<br>When User initiates payment, system displays `PaymentInitiationPage`.<br>System shows payment amount, description, and confirmation button.                                                                        |
| **(1)**     | **BR-02** | **Validation Rule (Confirmation - Front-end):**<br>When User clicks "Proceed to Payment", system displays MSG 11 ("Proceed with [type] payment of [amount]?").<br>System waits for confirmation before creating session.                                             |
| **(2)-(3)** | **BR-03** | **Validation Rule (Payment Type - Back-end):**<br>System validates the requested `paymentType` (e.g., `deposit`, `winning_payment`).<br>If unsupported type:<br>$\rightarrow$ System displays MSG 9 ("Invalid payment type") on the View.                            |
| **(3)**     | **BR-04** | **Validation Rule (Amount - Back-end):**<br>System validates the `amount` field is positive and matches expected context.<br>For deposits: must equal `depositAmountRequired`.<br>If invalid:<br>$\rightarrow$ System displays MSG 4 ("Invalid amount") on the View. |
| **(5)**     | **BR-05** | **Processing Rule (Stripe Configuration):**<br>System configures Stripe checkout session with:<br>- `success_url` (redirect after successful payment)<br>- `cancel_url` (redirect after cancelled payment)<br>- Currency standardization (VND or USD).               |
| **(8)**     | **BR-06** | **Storing Rule:**<br>System creates record in `PAYMENT` table:<br>- `sessionId = [Stripe session ID]`<br>- `amount = [validated amount]`<br>- `status = 'pending'`<br>- `type = [payment type]`                                                                      |
| **(10)**    | **BR-07** | **Displaying Rule (Redirect):**<br>System returns Stripe Checkout URL.<br>System redirects User to external payment gateway page.                                                                                                                                    |
