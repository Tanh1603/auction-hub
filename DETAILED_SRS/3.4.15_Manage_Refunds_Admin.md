# 3.4.15 Manage Refunds (Admin)

## 1. Use Case Description

| Field              | Description                                                                                                                |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Manage Refunds (Admin)                                                                                                     |
| **Description**    | This use case allows the Admin to review, approve, reject, and process refund requests for bidding deposits.               |
| **Actor**          | Admin, Auctioneer                                                                                                          |
| **Trigger**        | When the Admin navigates to the RefundManagementPage.                                                                      |
| **Pre-condition**  | • Admin is signed in with 'admin' or 'auctioneer' role.<br>• Refund requests exist in the system (Pending or Automatable). |
| **Post-condition** | Refund status updated, user notified, and financial record updated.                                                        |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "RefundManagementPage" as View
control "RegistrationController" as Controller
control "RefundService" as Service
entity "ParticipantRepository" as ParticipantRepo
control "EmailService" as Mail

User -> View: Filter by Auction/Status
View -> Controller: GET /register-to-bid/admin/refunds
activate Controller
Controller -> Service: listRefunds(filters)
Service -> ParticipantRepo: findMany(filters)
Service --> Controller: RefundList
Controller --> View: 200 OK (Display List)
deactivate Controller

User -> View: Click "Approve" or "Process"
View -> Controller: PATCH /register-to-bid/admin/refunds/:participantId\n{ action: 'approve' | 'process' | 'reject' }
activate Controller

Controller -> Service: updateRefundStatus(id, action)
activate Service

Service -> ParticipantRepo: findParticipant(id)
Service -> ParticipantRepo: updateStatus(newStatus)
activate ParticipantRepo
ParticipantRepo --> Service: UpdatedParticipant
deactivate ParticipantRepo

Service -> Mail: sendRefundNotification(user, status)
activate Mail
Mail --> Service: Sent
deactivate Mail

Service --> Controller: SuccessResponse
Controller --> View: 200 OK
View --> User: Display Success Confirmation
deactivate Service
deactivate Controller

@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin|
start
:(1) Access Refund Management;
:(2) Review Request Eligibility;
:(3) Select Action (Approve/Reject/Process);

|RefundService|
:(4) Validate Admin Permissions;
note right: BR-01

:(5) Update Participant Refund Status;

|ParticipantRepository|
:(6) Query & Update Record;

|RefundService|
:(7) Trigger Email Notification;
note right: BR-02, BR-03

|EmailService|
:(8) Send Email to Bidder;

|RefundService|
:(9) Return Success;

|Admin|
:(10) View Updated Status in List;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                     |
| :---------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)-(2)** | **BR-01** | **Authorization Rules:**<br>❖ Only users with roles 'admin', 'auctioneer', or 'super_admin' can access this module.<br>❖ Any attempt by regular Bidders to access admin refund endpoints returns 403 Forbidden.                                                                 |
| **(3)**     | **BR-02** | **Validation Rules (Status Change):**<br>❖ **Approve**: Can only be performed on 'PENDING' requests.<br>❖ **Process**: Can only be performed on 'APPROVED' requests (indicates financial transaction completed).<br>❖ **Reject**: Requires a mandatory `reason` to be provided. |
| **(5)-(6)** | **BR-03** | **Eligibility Auto-Check:**<br>❖ The system highlights records that are disqualified (BANNED/FORFEITED) to prevent accidental approval.<br>❖ Winners are automatically excluded from the refund list or marked as 'Ineligible'.                                                 |
| **(7)-(8)** | **BR-04** | **Notification Rules:**<br>❖ Upon status change, an email is sent to the Bidder informing them of the outcome (Approved/Rejected/Processed).<br>❖ Rejection emails must include the `reason` provided by the Admin.                                                             |
| **(Batch)** | **BR-05** | **Batch Processing:**<br>❖ Admin can use "Batch Process" for an auction to move all 'APPROVED' refunds to 'PROCESSED' at once.<br>❖ It can also be used to move non-winners (who haven't requested) to 'APPROVED' status 3 business days after finalization.                    |

## 5. Disqualification Reasons (Reference)

| Reason Code         | Description                              |
| :------------------ | :--------------------------------------- |
| FALSE_INFORMATION   | Providing false information              |
| FORGED_DOCUMENTS    | Using forged documents                   |
| PRICE_RIGGING       | Collusion to rig prices                  |
| AUCTION_OBSTRUCTION | Obstructing the auction                  |
| BID_WITHDRAWAL      | Withdrawing a placed bid                 |
| REFUSED_TO_SIGN     | Refusing to sign auction minutes         |
| REFUSED_RESULT      | Refusing the winning result              |
| PAYMENT_DEFAULT     | Failing to pay within deadline           |
| CONTRACT_DEFAULT    | Failing to sign contract within deadline |
| CHECK_IN_FAILURE    | Failed to check-in before auction ended  |
