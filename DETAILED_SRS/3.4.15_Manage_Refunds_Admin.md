# 3.4.15 Manage Refunds (Admin)

## 1. Use Case Description

| Field              | Description                                                                                 |
| ------------------ | ------------------------------------------------------------------------------------------- |
| **Name**           | Manage Refunds                                                                              |
| **Description**    | Allows Admin/Auctioneer to view, approve, reject, and process deposit refund requests       |
| **Actor**          | Admin, Auctioneer                                                                           |
| **Trigger**        | When Admin navigates to the Refunds Management page or receives refund request notification |
| **Pre-condition**  | • Admin is signed in<br>• User has role admin/auctioneer/super_admin                        |
| **Post-condition** | Refund status is updated and user is notified via email                                     |

## 2. Endpoints

### 2.1 List Refunds

| Method | Endpoint                         | Description                     |
| :----- | :------------------------------- | :------------------------------ |
| GET    | `/register-to-bid/admin/refunds` | List all refunds with filtering |

**Query Parameters:**

- `auctionId` (optional): Filter by auction
- `status` (optional): pending, approved, rejected, processed
- `page` (optional): Page number (default: 1)
- `limit` (optional): Items per page (default: 10)

### 2.2 Get Refund Detail

| Method | Endpoint                                        | Description              |
| :----- | :---------------------------------------------- | :----------------------- |
| GET    | `/register-to-bid/admin/refunds/:participantId` | Get detailed refund info |

**Response includes:**

- Participant info (user, auction, deposit amount)
- Refund status and timestamps
- Eligibility evaluation result
- Disqualification status if applicable

### 2.3 Update Refund Status

| Method | Endpoint                                        | Description            |
| :----- | :---------------------------------------------- | :--------------------- |
| PATCH  | `/register-to-bid/admin/refunds/:participantId` | Approve/reject/process |

**Request Body:**

```typescript
interface UpdateRefundDto {
  action: 'approve' | 'reject' | 'process';
  reason?: string; // Required for reject
}
```

### 2.4 Batch Process Refunds

| Method | Endpoint                                          | Description                  |
| :----- | :------------------------------------------------ | :--------------------------- |
| POST   | `/register-to-bid/admin/refunds/batch/:auctionId` | Process all eligible refunds |

## 3. Business Rules

| BR Code   | Description                                                                                                                                                       |
| :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **BR-01** | **Eligibility Evaluation:**<br>❖ Disqualified users NOT eligible<br>❖ Winners NOT eligible<br>❖ Check-in failures NOT eligible<br>❖ Late withdrawals NOT eligible |
| **BR-02** | **Approve Action:**<br>❖ Sets `refundStatus = 'approved'`<br>❖ Sends email notification to user                                                                   |
| **BR-03** | **Reject Action:**<br>❖ Sets `refundStatus = 'rejected'`<br>❖ Requires reason<br>❖ Sends email to user                                                            |
| **BR-04** | **Process Action:**<br>❖ Can only process approved refunds<br>❖ Sets `refundStatus = 'processed'` and `refundProcessedAt = now()`                                 |
| **BR-05** | **Batch Processing:**<br>❖ Only processes participants without winning bids<br>❖ Skips disqualified participants<br>❖ Refund within 3 working days                |

## 4. Disqualification Reasons

The following reasons result in deposit forfeiture (no refund):

| Reason Code         | Description                              |
| :------------------ | :--------------------------------------- |
| FALSE_INFORMATION   | Providing false information              |
| FORGED_DOCUMENTS    | Using forged documents                   |
| PRICE_RIGGING       | Collusion to rig prices                  |
| AUCTION_OBSTRUCTION | Obstructing the auction                  |
| BID_WITHDRAWAL      | Withdrawing a placed bid                 |
| REFUSED_TO_SIGN     | Refusing to sign auction minutes         |
| REFUSED_RESULT      | Refusing the winning result              |
| PAYMENT_DEFAULT     | Failing to pay within deadline           |
| CONTRACT_DEFAULT    | Failing to sign contract within deadline |
| CHECK_IN_FAILURE    | Failed to check-in before auction ended  |

## 5. Response DTO

```typescript
interface RefundDetailDto {
  participant: {
    id: string;
    userId: string;
    auctionId: string;
    user: { email: string; fullName: string };
    auction: { code: string; name: string };
  };
  deposit: {
    amount: number;
    paidAt: Date;
  };
  refund: {
    status: 'pending' | 'approved' | 'rejected' | 'processed' | null;
    requestedAt: Date | null;
    processedAt: Date | null;
  };
  eligibility: {
    eligible: boolean;
    reason: string;
  };
  disqualification: {
    isDisqualified: boolean;
    reason: string | null;
    disqualifiedAt: Date | null;
  };
}
```
