# 3.5.5 Receive Auction State

## 1. Use Case Description

| Field              | Description                                                                                              |
| ------------------ | -------------------------------------------------------------------------------------------------------- |
| **Name**           | Receive Auction State                                                                                    |
| **Description**    | This use case allows the User to search Auction State information in the system based on input keywords. |
| **Actor**          | User                                                                                                     |
| **Trigger**        | When the User joins an auction room via WebSocket.                                                       |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.            |
| **Post-condition** | The Auction State information will be displayed on the AuctionDetailPage screen.                         |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
control "AuctionService" as Service
entity "AuctionRepository" as AuctionRepo
control "WebSocketGateway" as WSGateway
boundary "WebSocketClient" as WSClient
boundary "AuctionDetailPage" as View

Service -> AuctionRepo: getAuctionDetails(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo
Service --> WSGateway: AuctionStateDto

WSGateway -> WSGateway: Broadcast `auctionState` to room (auctionId)
note right: BR-01, BR-02

WSGateway --> WSClient: Emit `auctionState` (AuctionStateDto)
WSClient -> View: Update UI with AuctionStateDto
View --> User: Display Current Auction State
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:Load Auction Page;

|WebSocketClient|
:Establish WebSocket Connection;
:Emit "joinAuction" Event;

|WebSocketGateway|
:(1) Auction State Change Detected / Join Event;

|AuctionService|
:(2) Retrieve Current Auction State;

|AuctionRepository|
:(3) Query Auction Data;

|WebSocketGateway|
:(4) Format State Data;
note right: BR-02, BR-04

:(5) Broadcast "auctionState" Event;
note right: BR-01

|WebSocketClient|
:(6) Receive "auctionState" Event;

|User|
:(7) Parse Auction State Data;
:(8) Update User Interface;
:(9) View Latest Auction State;
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :---------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Trigger Rules:**<br>❖ The system triggers the dispatch of auction state updates.<br>❖ This occurs either when a client joins an auction room (via `WebSocketGateway.onJoinAuction()`) or when a significant change in the auction’s state is detected (via `WebSocketGateway.onAuctionChange()`), such as a new bid or time update.                                                                                                                              |
| **(2)-(3)** | **BR-02** | **Querying Rules:**<br>❖ The system retrieves the current auction state by calling `AuctionService.getAuctionState(auctionId)`.<br>❖ It queries the “AUCTION” table to obtain up-to-date auction data.<br>❖ The query selects critical fields including: [auctionId], [name], [code], [status], [timeRemaining], and [currentWinningBid].                                                                                                                                |
| **(4)**     | **BR-03** | **Data Filtering Rules:**<br>❖ The system prepares the payload by calling `WebSocketGateway.formatAuctionState(auctionState)`.<br>❖ It carefully filters out sensitive data, such as internal IDs, admin-only fields, and private bidder details, ensuring that only publicly safe information is included in the broadcast.                                                                                                                                   |
| **(5)**     | **BR-04** | **Broadcasting Rules:**<br>❖ The system broadcasts the `auctionState` event to all subscribed clients in the auction-specific room by calling `WebSocketGateway.toRoom(auctionId).emit('auctionState', payload)`.<br>❖ This ensures efficient network usage by targeting only relevant clients.                                                                                                                                                                 |
| **(7)-(9)** | **BR-05** | **Displaying Rules:**<br>❖ Upon receiving the `auctionState` event via WebSocket, the client-side application updates its UI elements.<br>❖ This includes refreshing the highest bid display, synchronizing the countdown timer, and updating the status indicator.<br>❖ The user observes a synchronized and real-time view of the auction’s current state.                                                                                                                    |
