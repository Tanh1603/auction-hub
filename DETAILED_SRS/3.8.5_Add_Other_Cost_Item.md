# 3.8.5 Add Other Cost Item

## 1. Use Case Description

| Field              | Description                                                                                                        |
| ------------------ | ------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Add Other Cost Item                                                                                                |
| **Description**    | This use case allows the Admin to create a new Other Cost Item information in the system.                          |
| **Actor**          | Admin                                                                                                              |
| **Trigger**        | When the Admin clicks on the 'Add Other Cost' button on the AuctionCostPage.                                       |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                    |
| **Post-condition** | The Other Cost Item information will be stored into the system and display new record on AuctionCostPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuctionCostPage" as View
control "AuctionCostController" as Controller
control "AuctionCostService" as Service
database "AuctionCostRepository" as CostRepo

User -> View: Add New "Other Cost" (description, amount)
View -> Controller: POST /auction-costs/auction/:auctionId/other-cost\n{ description, amount }
activate Controller

Controller -> Service: addOtherCost(auctionId, dto, userId)
activate Service

Service -> CostRepo: findByAuctionId(auctionId)
activate CostRepo
CostRepo --> Service: ExistingCosts
deactivate CostRepo

alt Costs Not Found
    Service --> Controller: Throw NotFoundException
    Controller --> View: 404 Not Found
    View --> User: Display Error Message
else Costs Found
    Service -> Service: Add New Item to `otherCosts` Array
    Service -> Service: Recalculate Total Costs
    note right: BR-02

    Service -> CostRepo: update(id, newOtherCostsArray, newTotalCosts)
    activate CostRepo
    CostRepo --> Service: UpdatedCosts
    deactivate CostRepo

    Service --> Controller: AuctionCostResponseDto
    Controller --> View: 200 OK (Other Cost Added)
    View --> User: View Updated Costs
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Input Other Cost Details;
:(2) Submit;

|AuctionCostService|
:(3) Authenticate & Authorize;
note right: BR-01

|AuctionCostRepository|
:(4) Retrieve Existing AuctionCost Record;

|AuctionCostService|
if (Record Exists?) then (No)
    :(5.1) Return 404 Not Found;
    |Admin/Auctioneer|
    :(5.2) View Error Message;
    stop
endif

|AuctionCostService|
:(6) Add New Item to `otherCosts` Array;
:(7) Recalculate `totalCosts`;
note right: BR-02

|AuctionCostRepository|
:(8) Update `AuctionCost` Record (JSONB column);

|AuctionCostService|
:(9) Return Updated Costs;

|Admin/Auctioneer|
:(10) View Updated Cost Breakdown;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                       |
| :------------ | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**       | **BR-01** | **Displaying Rule (Add Other Cost Form):**<br>When Admin/Auctioneer clicks "Add Other Cost", system displays input form.<br>Form includes Description (text) and Amount (number) fields.                                                                                                                          |
| **(1)**       | **BR-02** | **Validation Rule (Required Fields - Front-end):**<br>When Admin submits form, system triggers validation.<br>If `description` is `isEmpty()` or `amount` is empty/invalid:<br>$\rightarrow$ System displays MSG 1 ("Description and Amount are required") adjacent to fields.                                    |
| **(1)**       | **BR-03** | **Validation Rule (Amount - Front-end):**<br>When Admin inputs amount, system triggers `Text_change()` validation.<br>Amount must be a positive number.<br>If invalid:<br>$\rightarrow$ System displays MSG 4 ("Invalid amount") adjacent to field.                                                               |
| **(3)**       | **BR-04** | **Validation Rule (Authorization - Back-end):**<br>System checks if requestor role is `admin` or `auctioneer` in `USERS` table.<br>If unauthorized:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                                                             |
| **(4)-(5.1)** | **BR-05** | **Querying Rule (Existing Record):**<br>System retrieves data from the 'AUCTION_COST' table in the database (Refer to 'AUCTION_COST' table in 'DB Sheet' file) based on the auction ID.<br>If no cost record found:<br>$\rightarrow$ System displays MSG 20 ("Please create base cost record first") on the View. |
| **(6)-(7)**   | **BR-06** | **Processing Rule (Array Append & Recalculate):**<br>System appends new item to `otherCosts` JSON array.<br>System recalculates `totalCosts` including new other cost amount.                                                                                                                                     |
| **(8)**       | **BR-07** | **Storing Rule:**<br>System updates `AUCTION_COST` record:<br>- Updates `otherCosts` JSONB column with appended array<br>- Updates `totalCosts` with recalculated value                                                                                                                                           |
| **(10)**      | **BR-08** | **Displaying Rule (Confirmation):**<br>System displays MSG 7 ("Other cost added successfully") on the View.<br>System displays updated cost breakdown including new other cost item.                                                                                                                              |
