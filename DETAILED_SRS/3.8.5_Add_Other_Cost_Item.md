# 3.8.5 Add Other Cost Item

## 1. Use Case Description

| Field              | Description                                                                                                        |
| ------------------ | ------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Add Other Cost Item                                                                                                |
| **Description**    | This use case allows the Admin to create a new Other Cost Item information in the system.                          |
| **Actor**          | Admin                                                                                                              |
| **Trigger**        | When the Admin clicks on the 'Add Other Cost' button on the AuctionCostPage.                                       |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                    |
| **Post-condition** | The Other Cost Item information will be stored into the system and display new record on AuctionCostPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuctionCostPage" as View
control "AuctionCostController" as Controller
control "AuctionCostService" as Service
database "AuctionCostRepository" as CostRepo

User -> View: Add New "Other Cost" (description, amount)
View -> Controller: POST /auction-costs/auction/:auctionId/other-cost\n{ description, amount }
activate Controller

Controller -> Service: addOtherCost(auctionId, dto, userId)
activate Service

Service -> CostRepo: findByAuctionId(auctionId)
activate CostRepo
CostRepo --> Service: ExistingCosts
deactivate CostRepo

alt Costs Not Found
    Service --> Controller: Throw NotFoundException
    Controller --> View: 404 Not Found
    View --> User: Display Error Message
else Costs Found
    Service -> Service: Add New Item to `otherCosts` Array
    Service -> Service: Recalculate Total Costs
    note right: BR-02

    Service -> CostRepo: update(id, newOtherCostsArray, newTotalCosts)
    activate CostRepo
    CostRepo --> Service: UpdatedCosts
    deactivate CostRepo

    Service --> Controller: AuctionCostResponseDto
    Controller --> View: 200 OK (Other Cost Added)
    View --> User: View Updated Costs
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Input Other Cost Details;
:(2) Submit;

|AuctionCostService|
:(3) Authenticate & Authorize;
note right: BR-01

|AuctionCostRepository|
:(4) Retrieve Existing AuctionCost Record;

|AuctionCostService|
if (Record Exists?) then (No)
    :(5.1) Return 404 Not Found;
    |Admin/Auctioneer|
    :(5.2) View Error Message;
    stop
endif

|AuctionCostService|
:(6) Add New Item to `otherCosts` Array;
:(7) Recalculate `totalCosts`;
note right: BR-02

|AuctionCostRepository|
:(8) Update `AuctionCost` Record (JSONB column);

|AuctionCostService|
:(9) Return Updated Costs;

|Admin/Auctioneer|
:(10) View Updated Cost Breakdown;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**       | **BR-01** | **Displaying Rules:**<br>❖ The system displays an “AddOtherCostItem” modal via `Display_Modal()`.<br>❖ It renders a form with a [Description] text input and an [Amount] number input.<br>❖ The [Add] button is initially disabled until valid input is detected.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **(1)**       | **BR-02** | **Validation Rules (Front-end):**<br>❖ As the user types, the system performs `ValidateInput(description, amount)`.<br>❖ If the input is not valid:<br>⮚ If the [description] is empty or the [amount] is less than or equal to 0, the system keeps the [Add] button disabled.<br>⮚ It displays **MSG 1** (Mandatory Field) or **MSG 4** (Invalid Amount) as appropriate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(3)**       | **BR-03** | **Authorization Rules (Back-end):**<br>❖ The system checks the authenticated user's role via `AuctionCostService.addOtherCost()`.<br>❖ If the input is not valid:<br>⮚ If the user's role is not 'admin' or 'auctioneer', the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(4)-(5.1)** | **BR-04** | **Querying Rules (Back-end):**<br>❖ The system queries the “AUCTION_COST” table via `AuctionCostRepository.findByAuctionId(auctionId)`.<br>❖ If the input is not valid:<br>⮚ If no base cost record exists, the system returns a 404 Not Found error.<br>⮚ It displays **MSG 20** (Create base cost record first).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **(6)-(7)**   | **BR-05** | **Processing Rules (Back-end):**<br>❖ The system calls `AuctionCostService.addOtherCost(auctionId, dto)` to process the new item.<br>❖ It appends the new `{ description, amount }` object to the existing `otherCosts` JSONB array.<br>❖ The system then recalculates the `totalCosts`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(8)**       | **BR-06** | **Storing Rules (Back-end):**<br>❖ The system updates the record in the “AUCTION_COST” table by calling `AuctionCostRepository.update()`.<br>❖ It saves the updated [otherCosts] array and the new [totalCosts] value.<br>❖ System moves to step (10) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(10)**      | **BR-07** | **Displaying Rules (Success):**<br>❖ The system refreshes the cost page via `Refresh_View('AuctionCostPage')`.<br>❖ It updates the display to show the newly added item in the "Other Costs" section and the updated total cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
