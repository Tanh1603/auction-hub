# 3.2.2 Login

## 1. Use Case Description

| Field              | Description                                                                         |
| ------------------ | ----------------------------------------------------------------------------------- |
| **Name**           | Login                                                                               |
| **Description**    | This use case allows the Guest to authenticate and access the system.               |
| **Actor**          | Guest                                                                               |
| **Trigger**        | When the Guest clicks on the 'Login' button on the LoginPage.                       |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the LoginPage. |
| **Post-condition** | The Guest will be authenticated and granted access to the system dashboard.         |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "LoginPage" as View
control "AuthController" as Controller
control "AuthService" as Service
entity "SupabaseService" as Supabase
entity "UserRepository" as Repo

User -> View: Enter Email & Password
View -> Controller: POST /auth/login\n{ email, password }
activate Controller

Controller -> Service: login(LoginDto)
activate Service

Service -> Supabase: signInWithPassword({ email, password })
activate Supabase

alt Authentication Failed (Invalid Creds)
    Supabase --> Service: Error (Invalid credentials)
    Service --> Controller: Throw UnauthorizedException
    Controller --> View: 401 Unauthorized
    View --> User: Show Error Message
else Authentication Success
    Supabase --> Service: AuthResponse (Session, User ID)
    deactivate Supabase

    Service -> Repo: findUserById(userId)
    activate Repo
    Repo --> Service: UserEntity
    deactivate Repo

    Service -> Service: Check User Status
    note right: BR-02, BR-03

    alt User Banned or Unverified
        Service --> Controller: Throw ForbiddenException
        Controller --> View: 403 Forbidden
        View --> User: Show Error Message
    else User Valid
        Service --> Controller: LoginResponse (JWT Token)
        Controller --> View: 200 OK (JWT Token)
        View -> User: Store Token & Access App
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Enter Email and Password;
:(2) Submit Login Request;

|AuthService|
:(3) Receive Login Request;
:(4) Forward Credentials to Auth Provider;

|SupabaseService|
:(5) Verify Email and Password;

if (Credentials Valid?) then (No)
    :(6.1) Return Invalid Credentials Error;
    |AuthService|
    :(6.2) Return 401 Unauthorized;
    |Guest|
    :(6.3) View Error Message;
    stop
else (Yes)
    |SupabaseService|
    :(7) Return Session/User ID;
endif

|AuthService|
:(8) Retrieve User Details from DB (using User ID);
:(9) Check User Verification Status;
note right: BR-02

if (User Email Unverified?) then (Yes)
    :(10.1) Return 403 Forbidden (Email Not Verified);
    |Guest|
    :(10.2) View Error Message;
    stop
endif

|AuthService|
:(11) Check User Banned Status;
note right: BR-03

if (User is Banned?) then (Yes)
    :(12.1) Return 403 Forbidden (User Banned);
    |Guest|
    :(12.2) View Error Message;
    stop
endif

|AuthService|
:(13) Generate JWT Token;
note right: BR-04
:(14) Return JWT Token to Client;

|Guest|
:(15) Store JWT Token;
:(16) Access Protected Resources;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                        |
| :------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “LoginPage” screen. (Refer to “LoginPage” view in “View Description” file).<br>❖ The screen renders input fields for: [email] and [password].                                                                                                                                                                                                                     |
| **(1)**  | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user enters credentials, the system uses the `ValidateInput(LoginDto)` method to check validity.<br>❖ If the input is not valid:<br>⮚ If [email] or [password] is empty, the system displays **MSG 1** (Mandatory Field).<br>⮚ If the [email] format is invalid, the system displays **MSG 4** (Invalid Format).                                                   |
| **(2)**  | **BR-03** | **Authentication Rules (Back-end):**<br>❖ When the user clicks the “Login” button, the system calls `AuthService.login(LoginDto)` to process the request.<br>❖ It attempts authentication by calling `Supabase.signInWithPassword({ email, password })`.<br>❖ If the authentication fails due to invalid credentials, the system returns a 401 Unauthorized error and displays **MSG 3** (Invalid Email/Password). |
| **(9)**  | **BR-04** | **Verification Rules (Back-end):**<br>❖ After successful authentication with Supabase, the system queries the “USERS” table via `UserRepository.findUserById(userId)` to retrieve user details.<br>❖ It checks the [isVerified] status. If the user’s email is not verified, the system returns a 403 Forbidden error and displays **MSG 7** (Email not verified).                                                 |
| **(11)** | **BR-05** | **Access Rules (Back-end):**<br>❖ The system further checks the [isBanned] status from the retrieved user data.<br>❖ If the user is banned, the system returns a 403 Forbidden error and displays **MSG 8** (User banned), preventing login.                                                                                                                                                                       |
| **(15)** | **BR-06** | **Displaying Rules (Success):**<br>❖ Upon successful login and authorization, the system generates and returns a JWT Token to the client.<br>❖ The system calls `Store_JWT(token)` to store the access token locally (e.g., in LocalStorage/Cookie).<br>❖ The user is then redirected to the protected Dashboard.                                                                                                  |
