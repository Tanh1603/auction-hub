# 3.2.4 Resend Verification Email

## 1. Use Case Description

| Field              | Description                                                                                                                   |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Resend Verification Email                                                                                                     |
| **Description**    | This use case allows the Guest to create a new Verification Email Request information in the system.                          |
| **Actor**          | Guest                                                                                                                         |
| **Trigger**        | When the Guest clicks on the 'Resend Verification Email' button on the ResendVerificationPage.                                |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the ResendVerificationPage.                              |
| **Post-condition** | The Verification Email Request information will be stored into the system and a verification email will be sent to the Guest. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "ResendVerificationPage" as View
control "AuthController" as Controller
control "AuthService" as Service
entity "UserRepository" as Repo
entity "SupabaseService" as Supabase

User -> View: Request Resend Verification
View -> Controller: POST /auth/resend-verification-email\n{ email }
activate Controller

Controller -> Service: resendVerificationEmail(email)
activate Service

Service -> Repo: findUserByEmail(email)
activate Repo
Repo --> Service: UserEntity (or null)
deactivate Repo

alt User Not Found
    Service --> Controller: Success (Masked)
    note right: BR-04
else User Found
    alt User Already Verified
        Service --> Controller: Throw BadRequestException\n("User already verified")
        Controller --> View: 400 Bad Request
        View --> User: Display Error Message
    else User Unverified
        Service -> Service: Check Rate Limits
        note right: BR-02

        Service -> Supabase: resend({ type: 'signup', email })
        activate Supabase
        Supabase --> Service: Success
        deactivate Supabase

        Service --> Controller: SuccessResponse
        Controller --> View: 200 OK (Email Sent)
        View --> User: Display Success Message
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Submit Resend Request;

|AuthService|
:(2) Receive Email Address;
:(3) Check Rate Limits;
note right: BR-02

if (Rate Limit Exceeded?) then (Yes)
    :(4.1) Return 429 Too Many Requests;
    |Guest|
    :(4.2) View Error Message;
    stop
endif

|AuthService|
:(5) Retrieve User Status;

if (User Exists?) then (No)
    :(6.1) Return Generic Success;
    note right: BR-04
    |Guest|
    :(6.2) Receive Confirmation;
    stop
endif

if (User Already Verified?) then (Yes)
    |AuthService|
    :(7.1) Return 400 Bad Request;
    note right: BR-01
    |Guest|
    :(7.2) View Error Message;
    stop
endif

|SupabaseService|
:(8) Generate New Verification Token;
:(9) Send Email;

|AuthService|
:(10) Return Success Message;

|Guest|
:(11) Receive Confirmation;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                    |
| :------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rule:**<br>The system displays a 'ResendVerificationPage' screen. (Refer to 'ResendVerificationPage' view in 'View Description' file).<br>The form contains input field for: email address.                                                                                                                                                                                                       |
| **(1)**  | **BR-02** | **Validation Rule (Front-end):**<br>When user enters email, system uses `Text_change()` method.<br>Checks if input is valid (empty, wrong format).<br>If `isEmpty()` on email → display **MSG 1** (Mandatory).<br>If wrong email format → display **MSG 4** (Invalid format).                                                                                                                                  |
| **(3)**  | **BR-03** | **Validation Rule (Rate Limiting):**<br>System checks rate limit for requesting IP or email via `checkRateLimit()` method.<br>If rate limit exceeded → display **MSG 9** (Too many requests), return 429.                                                                                                                                                                                                      |
| **(1)**  | **BR-04** | **Validation Rule (Back-end/Save):**<br>When user clicks 'Resend' button, send request via function `resendVerificationEmail(email)`.<br>Check table `USERS` for user existence and verification status.<br>If user not found → show generic success (security).<br>If already verified → show **MSG 9** (Already verified), return 400.<br>Else, generate new token, send email, show **MSG 7** (Email sent). |
