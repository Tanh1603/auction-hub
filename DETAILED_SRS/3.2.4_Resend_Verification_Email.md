# 3.2.4 Resend Verification Email

## 1. Use Case Description

| Field              | Description                                                                                                                   |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Resend Verification Email                                                                                                     |
| **Description**    | This use case allows the Guest to create a new Verification Email Request information in the system.                          |
| **Actor**          | Guest                                                                                                                         |
| **Trigger**        | When the Guest clicks on the 'Resend Verification Email' button on the ResendVerificationPage.                                |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the ResendVerificationPage.                              |
| **Post-condition** | The Verification Email Request information will be stored into the system and a verification email will be sent to the Guest. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "ResendVerificationPage" as View
control "AuthController" as Controller
control "AuthService" as Service
entity "UserRepository" as Repo
entity "SupabaseService" as Supabase

User -> View: Request Resend Verification
View -> Controller: POST /auth/resend-verification-email\n{ email }
activate Controller

Controller -> Service: resendVerificationEmail(email)
activate Service

Service -> Repo: findUserByEmail(email)
activate Repo
Repo --> Service: UserEntity (or null)
deactivate Repo

alt User Not Found
    Service --> Controller: Success (Masked)
    note right: BR-04
else User Found
    alt User Already Verified
        Service --> Controller: Throw BadRequestException\n("User already verified")
        Controller --> View: 400 Bad Request
        View --> User: Display Error Message
    else User Unverified
        Service -> Service: Check Rate Limits
        note right: BR-02

        Service -> Supabase: resend({ type: 'signup', email })
        activate Supabase
        Supabase --> Service: Success
        deactivate Supabase

        Service --> Controller: SuccessResponse
        Controller --> View: 200 OK (Email Sent)
        View --> User: Display Success Message
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Submit Resend Request;

|AuthService|
:(2) Receive Email Address;
:(3) Check Rate Limits;
note right: BR-02

if (Rate Limit Exceeded?) then (Yes)
    :(4.1) Return 429 Too Many Requests;
    |Guest|
    :(4.2) View Error Message;
    stop
endif

|AuthService|
:(5) Retrieve User Status;

if (User Exists?) then (No)
    :(6.1) Return Generic Success;
    note right: BR-04
    |Guest|
    :(6.2) Receive Confirmation;
    stop
endif

if (User Already Verified?) then (Yes)
    |AuthService|
    :(7.1) Return 400 Bad Request;
    note right: BR-01
    |Guest|
    :(7.2) View Error Message;
    stop
endif

|SupabaseService|
:(8) Generate New Verification Token;
:(9) Send Email;

|AuthService|
:(10) Return Success Message;

|Guest|
:(11) Receive Confirmation;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                   | 
| :------- | :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | 
| **(1)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “ResendVerificationPage” screen. (Refer to “ResendVerificationPage” view in “View Description” file).<br>❖ The screen renders an input field for the user's [email] address.                                                                                                                                                                                                                            | 
| **(1)**  | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user enters their email, the system uses the `ValidateInput(email)` method for validation.<br>❖ If the input is not valid:<br>⮚ If the [email] field is empty, the system displays **MSG 1** (Mandatory Field).<br>⮚ If the [email] format is invalid, the system displays **MSG 4** (Invalid Format).                                                                                                                                                                                                                                                                                            | 
| **(3)**  | **BR-03** | **Rate Limiting Rules (Back-end):**<br>❖ The system calls `AuthService.checkRateLimit(ip, email)` to prevent abuse.<br>❖ It checks the request count for the originating IP address or email within a defined period.<br>❖ If the rate limit is exceeded, the system returns a 429 Too Many Requests error and displays **MSG 9** (Too many requests).                                                                                                                                                                                                                                                                                                   | 
| **(1)**  | **BR-04** | **Processing Rules (Back-end):**<br>❖ When the user clicks “Resend”, the system calls `AuthService.resendVerificationEmail(email)` to process the request.<br>❖ The system checks the “USERS” table for user existence and [isVerified] status.<br>❖ If the user is not found, a generic success message is returned for security reasons.<br>❖ If the user is already verified, a 400 Bad Request is returned.<br>❖ Otherwise, a new verification token is generated, the email is sent via `Supabase.resend()`, and a success message is displayed.                                                                                                                                                                                                                                                         |
