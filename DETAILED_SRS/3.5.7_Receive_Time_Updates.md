# 3.5.7 Receive Time Updates

## 1. Use Case Description

| Field              | Description                                                                                            |
| ------------------ | ------------------------------------------------------------------------------------------------------ |
| **Name**           | Receive Time Updates                                                                                   |
| **Description**    | This use case allows the User to search Time Update information in the system based on input keywords. |
| **Actor**          | User                                                                                                   |
| **Trigger**        | When the server broadcasts time updates to the auction room.                                           |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.          |
| **Post-condition** | The Time Update information will be displayed on the AuctionDetailPage screen.                         |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
control "AuctionTimerService" as TimerService
control "AuctionService" as Service
control "WebSocketGateway" as WSGateway
boundary "WebSocketClient" as WSClient
boundary "AuctionDetailPage" as View

TimerService -> Service: Tick (e.g., every 1 second)
activate Service
Service -> Service: Calculate Time Remaining for Live Auctions
Service --> WSGateway: TimeRemainingDto

WSGateway -> WSGateway: Broadcast `timeUpdate` to relevant rooms
note right: BR-01, BR-02

WSGateway --> WSClient: Emit `timeUpdate` (TimeRemainingDto)
WSClient -> View: Update UI Countdown
View --> User: Observe Live Countdown
deactivate Service
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|AuctionTimerService|
start
:(1) Initiate Timer for Live Auctions;
repeat
    :(2) Tick (e.g., Every Second);

    |AuctionService|
    :(3) Calculate `timeRemaining` for each Live Auction;
    note right: BR-04

    |WebSocketGateway|
    :(4) Prepare `timeUpdate` Event Payload;
    note right: BR-05
    :(5) Broadcast `timeUpdate` Event;
    note right: BR-01, BR-02

    |User|
    :(6) Receive `timeUpdate` Event;
    :(7) Parse `timeRemaining` Data;
    :(8) Update Countdown Timer in UI;
    :(9) Observe Auction Countdown;

    |AuctionTimerService|
backward:Until Auction Ends;
repeat while (Auction Live?)
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                              |
| :---------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)** | **BR-01** | **Processing Rule (Timer Trigger):**<br>Server-side timer ticks every second for each `live` auction.<br>System calculates `timeRemaining` based on `auctionEndAt` timestamp.                                            |
| **(3)**     | **BR-02** | **Processing Rule (Live Auctions Only):**<br>Time updates are generated only for auctions with `status = 'live'`.<br>No updates sent for `scheduled`, `ended`, or `failed` auctions.                                     |
| **(3)**     | **BR-03** | **Processing Rule (Server-Side Authority):**<br>All `timeRemaining` calculations performed on server.<br>Prevents client-side time manipulation.<br>Ensures synchronized countdown across all participants.              |
| **(4)**     | **BR-04** | **Processing Rule (Efficient Payload):**<br>System prepares minimal `timeUpdate` payload:<br>- `auctionId`<br>- `timeRemaining` (in milliseconds or seconds)<br>Conserves bandwidth with small payloads sent frequently. |
| **(5)**     | **BR-05** | **Processing Rule (Targeted Broadcast):**<br>System broadcasts `timeUpdate` event to clients in auction-specific room only.<br>Update frequency: approximately once per second.                                          |
| **(6)-(9)** | **BR-06** | **Displaying Rule (Countdown Update):**<br>Client receives `timeUpdate` event via WebSocket.<br>Client updates countdown timer display in UI.<br>User observes accurate, synchronized auction countdown.                 |
