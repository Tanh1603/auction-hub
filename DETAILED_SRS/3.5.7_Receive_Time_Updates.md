# 3.5.7 Receive Time Updates

## 1. Use Case Description

| Field              | Description                                                                                            |
| ------------------ | ------------------------------------------------------------------------------------------------------ |
| **Name**           | Receive Time Updates                                                                                   |
| **Description**    | This use case allows the User to search Time Update information in the system based on input keywords. |
| **Actor**          | User                                                                                                   |
| **Trigger**        | When the server broadcasts time updates to the auction room.                                           |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.          |
| **Post-condition** | The Time Update information will be displayed on the AuctionDetailPage screen.                         |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
control "AuctionTimerService" as TimerService
control "AuctionService" as Service
control "WebSocketGateway" as WSGateway
boundary "WebSocketClient" as WSClient
boundary "AuctionDetailPage" as View

TimerService -> Service: Tick (e.g., every 1 second)
activate Service
Service -> Service: Calculate Time Remaining for Live Auctions
Service --> WSGateway: TimeRemainingDto

WSGateway -> WSGateway: Broadcast `timeUpdate` to relevant rooms
note right: BR-01, BR-02

WSGateway --> WSClient: Emit `timeUpdate` (TimeRemainingDto)
WSClient -> View: Update UI Countdown
View --> User: Observe Live Countdown
deactivate Service
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|AuctionTimerService|
start
:(1) Initiate Timer for Live Auctions;
repeat
    :(2) Tick (e.g., Every Second);

    |AuctionService|
    :(3) Calculate `timeRemaining` for each Live Auction;
    note right: BR-04

    |WebSocketGateway|
    :(4) Prepare `timeUpdate` Event Payload;
    note right: BR-05
    :(5) Broadcast `timeUpdate` Event;
    note right: BR-01, BR-02

    |User|
    :(6) Receive `timeUpdate` Event;
    :(7) Parse `timeRemaining` Data;
    :(8) Update Countdown Timer in UI;
    :(9) Observe Auction Countdown;

    |AuctionTimerService|
backward:Until Auction Ends;
repeat while (Auction Live?)
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :---------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)** | **BR-01** | **Processing Rules (Timer Trigger):**<br>❖ The system executes `AuctionTimerService.tick()` as a scheduled background task.<br>❖ This task runs approximately every 1 second and identifies all auctions where the [status] is 'live'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(3)**     | **BR-02** | **Processing Rules (Calculation):**<br>❖ For each live auction, the system calls `AuctionService.calculateTimeRemaining(auction)`.<br>❖ It calculates the time remaining as `[auctionEndAt] - NOW()`.<br>❖ If the time remaining is less than or equal to zero, the system automatically triggers the auction end process.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(3)**     | **BR-03** | **Processing Rules (Server Authority):**<br>❖ The system enforces server-side logic as the single source of truth for time.<br>❖ Clients must synchronize their displays to these server updates to prevent client-side time manipulation or desynchronization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(4)**     | **BR-04** | **Processing Rules (Payload):**<br>❖ The system creates a lightweight payload via `Create_TimeUpdate_Payload(auctionId, ms)`.<br>❖ The payload contains only the [auctionId] and the [timeRemainingMs] to minimize bandwidth usage for this high-frequency event.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **(5)**     | **BR-05** | **Processing Rules (Broadcasting):**<br>❖ The system broadcasts the update by calling `WebSocketGateway.emitTimeUpdate(auctionId, payload)`.<br>❖ The `timeUpdate` event is emitted specifically to the WebSocket room corresponding to the [auctionId].                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(6)-(9)** | **BR-06** | **Displaying Rules (Countdown Update):**<br>❖ Upon receiving the event, the client executes `Update_Countdown_Timer(ms)`.<br>❖ It formats the milliseconds into a readable HH:MM:SS format.<br>❖ The system updates the Timer Component on the UI.<br>❖ If the time remaining is zero or less, the display changes to "Ended" or "Calculated".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |