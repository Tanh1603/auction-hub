# 3.5.1 Place Manual Bid

## 1. Use Case Description

| Field              | Description                                                                                        |
| ------------------ | -------------------------------------------------------------------------------------------------- |
| **Name**           | Place Manual Bid                                                                                   |
| **Description**    | This use case allows the Bidder to create a new Bid information in the system.                     |
| **Actor**          | Bidder                                                                                             |
| **Trigger**        | When the Bidder clicks on the 'Place Bid' button on the BiddingPage.                               |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.  |
| **Post-condition** | The Bid information will be stored into the system and display new record on BiddingPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "BiddingPage" as View
control "BiddingController" as Controller
control "BiddingService" as Service
entity "AuctionRepository" as AuctionRepo
entity "ParticipantRepository" as ParticipantRepo
entity "BidRepository" as BidRepo
control "WebSocketGateway" as WSGateway

User -> View: Enter Bid Amount
View -> Controller: POST /manual-bid\n{ auctionId, bidAmount }
activate Controller

Controller -> Service: placeManualBid(auctionId, bidAmount, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> ParticipantRepo: findParticipant(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> Service: ParticipantEntity
deactivate ParticipantRepo

Service -> Service: Validate Bid (all BRs)
note right: BR-01, BR-02, BR-03, BR-04, BR-06

alt Bid Invalid
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Bid Valid
    Service -> Service: Start Transaction
    Service -> BidRepo: create(bidData)
    activate BidRepo
    BidRepo --> Service: NewBidEntity
    deactivate BidRepo
    Service -> AuctionRepo: update(auctionId, { currentHighestBid, winningBidderId })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> Service: Commit Transaction

    Service -> WSGateway: broadcastNewBid(auctionId, newHighestBid)
    activate WSGateway
    WSGateway --> Service: Broadcast Acknowledged
    deactivate WSGateway

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Bid Placed)
    View --> User: Show Bid Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
' Skinparams help ensure high-contrast, readable rendering
skinparam conditionStyle diamond
skinparam monospacedFontName "Consolas"

|Bidder|
start
:"(1) Enter Bid Amount";
:"(2) Submit Bid";

|BiddingService|
:"(3) Authenticate Requestor";

|AuctionRepository|
:"(4) Retrieve Auction";

|ParticipantRepository|
:"(5) Retrieve Participant";

|BiddingService|
' Quote the condition text to prevent parsing errors
if ("Bidder Eligibility Valid?") then (No)
    :"(6.1) Return Error\n(e.g., Not checked in)";
    note right: BR-01
    |Bidder|
    :"(6.2) View Error Message";
    stop
endif

|BiddingService|
' The == symbol can break the parser if not quoted
if ("Auction Status == Live?") then (No)
    :"(7.1) Return Error\n(Auction not live)";
    note right: BR-02
    |Bidder|
    :"(7.2) View Error Message";
    stop
endif

|BiddingService|
if ("Bid Time Within Window?") then (No)
    :"(8.1) Return Error\n(Time expired)";
    note right: BR-06
    |Bidder|
    :"(8.2) View Error Message";
    stop
endif

|BiddingService|
:"(9) Validate Bid Amount";
note right: BR-03, BR-04

if ("Bid Amount Invalid?") then (Yes)
    :"(10.1) Return Error\n(Too Low, Wrong Increment)";
    |Bidder|
    :"(10.2) View Error Message";
    stop
endif

|BidRepository|
:"(11) BEGIN TRANSACTION";
:"(12) Insert New AuctionBid";

|AuctionRepository|
:"(13) Update Auction\n(currentHighestBid, winningBidder)";

|BiddingService|
:"(14) COMMIT TRANSACTION";
note right: BR-05

|WebSocketGateway|
:"(15) Broadcast New Bid Notification";

|BiddingService|
:"(16) Return Success";

|Bidder|
:"(17) Receive Confirmation";
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| :-------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**   | **BR-01** | **Displaying Rule:**<br>The system displays a 'BiddingPage' screen. (Refer to 'BiddingPage' view in 'View Description' file).<br>Screen shows current highest bid, bid increment, input field for bid amount, and 'Place Bid' button.                                                                                                                                                                                                                                   |
| **(1)**   | **BR-02** | **Validation Rule (Front-end):**<br>When user enters bid amount, system uses `Text_change()` method.<br>Checks if input is valid (empty, wrong format).<br>If `isEmpty()` → display **MSG 1** (Mandatory).<br>If amount < startingPrice (first bid) → display **MSG 24** (Bid too low).<br>If amount <= currentHighestBid → display **MSG 24** (Bid must be higher).<br>If (amount - previousBid) not multiple of bidIncrement → display **MSG 4** (Invalid increment). |
| **(6.1)** | **BR-03** | **Validation Rule (Bidder Eligibility):**<br>System checks if bidder is FINAL_APPROVED and has checkedInAt for the auction.<br>If not → display **MSG 19** (Not eligible to bid), return 403.                                                                                                                                                                                                                                                                           |
| **(7.1)** | **BR-04** | **Validation Rule (Auction Status):**<br>System checks if auction status is 'live'.<br>If not live → display **MSG 22** (Auction not active), return 400.                                                                                                                                                                                                                                                                                                               |
| **(2)**   | **BR-05** | **Validation Rule (Back-end/Save):**<br>When user clicks 'Place Bid' button, send data via function `placeManualBid(auctionId, bidAmount, userId)`.<br>Check time is within auctionStartAt and auctionEndAt.<br>Execute in transaction: Insert bid in `AUCTION_BID`, update `AUCTION` with currentHighestBid.<br>Broadcast new bid via WebSocket.<br>Show **MSG 7** (Success).                                                                                          |
| **(15)**  | **BR-06** | **Processing Rule (Anti-sniping):**<br>If bid placed within last 60 seconds before auctionEndAt, system automatically extends auctionEndAt by fixed duration.<br>Prevents sniping, ensures fairness.                                                                                                                                                                                                                                                                    |
