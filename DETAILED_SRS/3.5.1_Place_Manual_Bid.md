# 3.5.1 Place Manual Bid

## 1. Use Case Description

| Field              | Description                                                                                        |
| ------------------ | -------------------------------------------------------------------------------------------------- |
| **Name**           | Place Manual Bid                                                                                   |
| **Description**    | This use case allows the Bidder to create a new Bid information in the system.                     |
| **Actor**          | Bidder                                                                                             |
| **Trigger**        | When the Bidder clicks on the 'Place Bid' button on the BiddingPage.                               |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.  |
| **Post-condition** | The Bid information will be stored into the system and display new record on BiddingPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "BiddingPage" as View
control "BiddingController" as Controller
control "BiddingService" as Service
entity "AuctionRepository" as AuctionRepo
entity "ParticipantRepository" as ParticipantRepo
entity "BidRepository" as BidRepo
control "WebSocketGateway" as WSGateway

User -> View: Enter Bid Amount
View -> Controller: POST /manual-bid\n{ auctionId, bidAmount }
activate Controller

Controller -> Service: placeManualBid(auctionId, bidAmount, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> ParticipantRepo: findParticipant(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> Service: ParticipantEntity
deactivate ParticipantRepo

Service -> Service: Validate Bid (all BRs)
note right: BR-01, BR-02, BR-03, BR-04, BR-06

alt Bid Invalid
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Bid Valid
    Service -> Service: Start Transaction
    Service -> BidRepo: create(bidData)
    activate BidRepo
    BidRepo --> Service: NewBidEntity
    deactivate BidRepo
    Service -> AuctionRepo: update(auctionId, { currentHighestBid, winningBidderId })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> Service: Commit Transaction

    Service -> WSGateway: broadcastNewBid(auctionId, newHighestBid)
    activate WSGateway
    WSGateway --> Service: Broadcast Acknowledged
    deactivate WSGateway

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Bid Placed)
    View --> User: Show Bid Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
' Skinparams help ensure high-contrast, readable rendering
skinparam conditionStyle diamond
skinparam monospacedFontName "Consolas"

|Bidder|
start
:"(1) Enter Bid Amount";
:"(2) Submit Bid";

|BiddingService|
:"(3) Authenticate Requestor";

|AuctionRepository|
:"(4) Retrieve Auction";

|ParticipantRepository|
:"(5) Retrieve Participant";

|BiddingService|
' Quote the condition text to prevent parsing errors
if ("Bidder Eligibility Valid?") then (No)
    :"(6.1) Return Error\n(e.g., Not checked in)";
    note right: BR-01
    |Bidder|
    :"(6.2) View Error Message";
    stop
endif

|BiddingService|
' The == symbol can break the parser if not quoted
if ("Auction Status == Live?") then (No)
    :"(7.1) Return Error\n(Auction not live)";
    note right: BR-02
    |Bidder|
    :"(7.2) View Error Message";
    stop
endif

|BiddingService|
if ("Bid Time Within Window?") then (No)
    :"(8.1) Return Error\n(Time expired)";
    note right: BR-06
    |Bidder|
    :"(8.2) View Error Message";
    stop
endif

|BiddingService|
:"(9) Validate Bid Amount";
note right: BR-03, BR-04

if ("Bid Amount Invalid?") then (Yes)
    :"(10.1) Return Error\n(Too Low, Wrong Increment)";
    |Bidder|
    :"(10.2) View Error Message";
    stop
endif

|BidRepository|
:"(11) BEGIN TRANSACTION";
:"(12) Insert New AuctionBid";

|AuctionRepository|
:"(13) Update Auction\n(currentHighestBid, winningBidder)";

|BiddingService|
:"(14) COMMIT TRANSACTION";
note right: BR-05

|WebSocketGateway|
:"(15) Broadcast New Bid Notification";

|BiddingService|
:"(16) Return Success";

|Bidder|
:"(17) Receive Confirmation";
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :-------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**   | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “BiddingPage” screen via `Display_View(auctionState)`.<br>❖ The screen renders the [CurrentBid], [NextMinimumBid], an input field for the [BidInput], and a [PlaceBidButton].<br>❖ The [PlaceBidButton] is disabled if the bidder is not eligible or if the auction is not live.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(1)**   | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user enters a bid amount, the system performs `ValidateBidInput(amount)` validation.<br>❖ If the input is not valid:<br>⮚ If [amount] is empty, the system displays **MSG 1** (Mandatory Field).<br>⮚ If [amount] is less than [nextMinimumBid], the system displays **MSG 24** (Bid too low).<br>⮚ If the difference between [amount] and [currentHighestBid] is not a multiple of [bidIncrement], the system displays **MSG 4** (Invalid increment).                                                                                                                                                                                                                                                                                                                                                               |
| **(6.1)** | **BR-03** | **Eligibility Rules (Back-end):**<br>❖ The system calls `BiddingService.validateBidderEligibility(auctionId, userId)` to check the bidder’s eligibility.<br>❖ It verifies that the bidder's [status] in the “AUCTION_PARTICIPANT” table is 'FINAL_APPROVED' and that `checkedInAt` is not NULL.<br>❖ If the input is not valid:<br>⮚ If the bidder is not eligible, the system returns a 403 Forbidden status and displays **MSG 19** (Not eligible to bid).                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(7.1)** | **BR-04** | **State Locking Rules (Back-end):**<br>❖ The system calls `BiddingService.validateAuctionState(auctionId)` to verify the auction’s status.<br>❖ It checks if the auction’s [status] in the “AUCTION” table is 'live'.<br>❖ If the input is not valid:<br>⮚ If the auction is not 'live', the system returns a 400 Bad Request and displays **MSG 22** (Auction not active).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(11)-(14)** | **BR-05** | **Storing Rules (Back-end):**<br>❖ When the user clicks “Place Bid”, the system calls `BiddingService.placeManualBid(auctionId, bidAmount, userId)` to save the bid.<br>❖ This operation is executed within a database transaction:<br>⮚ The new bid is inserted into the “AUCTION_BID” table with the [amount], `bidAt` timestamp (NOW()), [bidType] of 'manual', and [participantId].<br>⮚ The “AUCTION” table is updated with the new [currentHighestBid] and [winningBidderId].<br>❖ The transaction is then committed.<br>❖ System moves to step (17) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                          |
| **(15)**  | **BR-06** | **Processing Rules (Anti-sniping):**<br>❖ The system employs an anti-sniping mechanism by calling `AuctionService.extendAuctionTime(auctionId)`.<br>❖ If a bid is placed within the last 60 seconds before `auctionEndAt`, the system automatically extends `auctionEndAt` by a fixed duration (e.g., another 60 seconds).<br>❖ This prevents last-second bidding (sniping) and ensures fairness.                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
