# 3.6.6 Get Winner Payment Requirements

## 1. Use Case Description

| Field              | Description                                                                                                                                                                       |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Get Winner Payment Requirements                                                                                                                                                   |
| **Description**    | This use case allows the Winner to search for Payment Requirements in the system. This includes the final amount due, payment methods, and deadlines.                             |
| **Actor**          | Winner (Bidder)                                                                                                                                                                   |
| **Trigger**        | When the Winner navigates to the details page of an auction they won, triggering `GET /auction-finalization/winner-payment-requirements/:auctionId`.                              |
| **Pre-condition**  | • Winner's device must be connected to the internet.<br>• Winner is signed in with their account and is the confirmed winning bidder for the auction.                             |
| **Post-condition** | The Payment Requirements information (payment amount, available payment methods, and payment instructions/deadlines) will be retrieved and displayed to the Winner in the system. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Winner" as User
boundary "WinnerPaymentPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
entity "AuctionRepository" as AuctionRepo

User -> View: View Won Auction Details
View -> Controller: GET /auction-finalization/winner-payment-requirements/:auctionId
activate Controller

Controller -> Service: getWinnerPaymentRequirements(auctionId, userId)
activate Service

Service -> AuctionRepo: findByIdWithWinningBid(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

alt Not Winner or Auction Not Successful
    Service --> Controller: Throw Forbidden/BadRequest
    Controller --> View: 403/400 Error
    View --> User: Display Error Message
else Winning Bidder and Success Auction
    Service -> Service: Calculate Final Amount Due
    note right: BR-03
    Service --> Controller: WinnerPaymentRequirementsDto
    Controller --> View: 200 OK (Requirements)
    View --> User: Display Payment Requirements
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Winner|
start
:(1) View Won Auction;
:(2) Request Payment Requirements;

|FinalizationService|
:(3) Authenticate Requestor;
:(4) Verify Winner Status;
note right: BR-01

|AuctionRepository|
:(5) Retrieve Finalized Auction Details;

|FinalizationService|
if (Not Winner?) then (Yes)
    :(6.1) Return 403 Forbidden;
    |Winner|
    :(6.2) View Error Message;
    stop
endif

if (Auction Status == SUCCESS?) then (No)
    :(7.1) Return 400 Bad Request\n(Auction not concluded successfully);
    |Winner|
    :(7.2) View Error Message;
    stop
endif

|FinalizationService|
:(8) Calculate Final Amount Due;
note right: BR-03

:(9) Format Payment Instructions;
:(10) Return Requirements DTO;

|Winner|
:(11) View Payment Details;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :---------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)-(2)** | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “WinnerPaymentPage” screen via `Display_View()`. (Refer to “WinnerPaymentPage” view in “View Description” file).<br>❖ It displays a loading indicator while fetching the payment requirements.<br>❖ The system renders the dedicated Payment Requirements section.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(3)-(4)** | **BR-02** | **Authorization Rules (Back-end):**<br>❖ The system verifies the authenticated user’s identity by calling `FinalizationService.getWinnerPaymentRequirements()`.<br>❖ If the input is not valid:<br>⮚ The system checks if the user is the `winningBidderId` in the “AUCTION” table.<br>⮚ If the user is not the winner, the system returns a 403 Forbidden status and displays **MSG 5** (Not the winning bidder).                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(7.1)**   | **BR-03** | **State Locking Rules (Back-end):**<br>❖ The system checks the auction’s status using `AuctionService.isStatus('success')`.<br>❖ If the input is not valid:<br>⮚ If the [status] is not 'success', the system returns a 400 Bad Request.<br>⮚ It displays **MSG 26** (Payment requirements not available).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(8)**     | **BR-04** | **Calculation Rules (Back-end):**<br>❖ The system calculates the final amount due by invoking `FinalizationService.calculateFinalAmountDue()`.<br>❖ The formula used is: `finalAmount = [finalSalePrice] + [saleFee] - [depositAmountSnapshot]`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(9)**     | **BR-05** | **Calculation Rules (Back-end):**<br>❖ The system determines the payment deadline by calling `FinalizationService.calculatePaymentDeadline()`.<br>❖ The deadline is set to `[finalizedAt] + 7 Days` (configurable).<br>❖ If the current time (`NOW()`) exceeds this deadline, the registration is flagged as overdue.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **(11)**    | **BR-06** | **Displaying Rules (Data):**<br>❖ The system displays the payment summary via `Display_Payment_Summary(requirements)`.<br>❖ It shows the [FinalAmountDue] and a detailed breakdown.<br>❖ The [PaymentDeadline] is presented, and a button to “Initiate Payment” is displayed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |