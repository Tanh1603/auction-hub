# 3.2.5 Verify Email (POST)

## 1. Use Case Description

| Field              | Description                                                                                     |
| ------------------ | ----------------------------------------------------------------------------------------------- |
| **Name**           | Verify Email (POST)                                                                             |
| **Description**    | This use case allows the Guest to update existing Email Verification information in the system. |
| **Actor**          | Guest                                                                                           |
| **Trigger**        | When the Guest clicks on the 'Verify' button on the VerificationPage.                           |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the VerificationPage.      |
| **Post-condition** | The Email Verification information will be updated in the system and Guest will be logged in.   |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "VerificationPage" as View
control "AuthController" as Controller
control "AuthService" as Service
entity "SupabaseService" as Supabase
entity "UserRepository" as Repo

User -> View: Enter Verification Code (OTP)
View -> Controller: POST /auth/verify-email\n{ email, token, type: 'signup' }
activate Controller

Controller -> Service: verifyEmail(VerifyEmailDto)
activate Service

Service -> Supabase: verifyOtp({ email, token, type })
activate Supabase

alt Token Invalid or Expired
    Supabase --> Service: Error (Invalid OTP)
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Token Valid
    Supabase --> Service: AuthResponse (Session, User)
    deactivate Supabase

    Service -> Repo: updateUserStatus(email, { isVerified: true })
    activate Repo
    Repo --> Service: UpdatedUserEntity
    deactivate Repo

    Service --> Controller: SuccessResponse (with Session/JWT)
    note right: BR-04
    Controller --> View: 200 OK (Logged In)
    View --> User: Access Dashboard
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Input Verification Code;
:(2) Submit Request;

|AuthService|
:(3) Receive Email & Token;
:(4) Forward to Supabase;

|SupabaseService|
:(5) Validate Token vs Email;
note right: BR-01, BR-02

if (Token Valid?) then (No)
    :(6.1) Return Verification Error;
    |AuthService|
    :(6.2) Return 400 Bad Request;
    |Guest|
    :(6.3) View Error Message;
    stop
else (Yes)
    |SupabaseService|
    :(7) Mark Email as Confirmed;
    :(8) Generate Session (JWT);
    :(9) Return Session Data;
endif

|AuthService|
:(10) Update Local User Record;
note right: BR-03
:(11) Format Response (Login Data);

|Guest|
:(12) Receive Success & Token;
:(13) Access Dashboard;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “VerificationPage” screen. (Refer to “VerificationPage” view in “View Description” file).<br>❖ The screen renders input fields for: [email] (pre-filled and read-only) and [token] for the OTP input.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **(1)**  | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user enters the OTP code, the system uses the `ValidateInput(VerifyEmailDto)` method for validation.<br>❖ If the input is not valid:<br>⮚ If the [token] field is empty, the system displays **MSG 1** (Mandatory Field).<br>⮚ If the [token] format is invalid (e.g., wrong length), the system displays **MSG 4** (Invalid Format).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(2)**  | **BR-03** | **Verification Rules (Back-end):**<br>❖ When the user clicks the “Verify” button, the system calls `AuthService.verifyEmail(VerifyEmailDto)` to submit the email and token.<br>❖ It invokes `Supabase.verifyOtp({ email, token, type: 'signup' })` to validate the token.<br>❖ If the token is invalid or expired, the system returns a 400 Bad Request and displays **MSG 10** (Verification failed).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(10)** | **BR-04** | **Storing Rules (Back-end):**<br>❖ Upon successful token validation by Supabase, the system calls `UserRepository.updateUserStatus()` to update the user’s record.<br>❖ The system updates the table “USERS” to set the [isVerified] field to `true`.<br>❖ A session/JWT token is then generated and returned for immediate login.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **(13)** | **BR-05** | **Displaying Rules (Success):**<br>❖ The system redirects the user to the Dashboard by calling `Redirect('Dashboard')`.<br>❖ The user’s JWT Token is stored locally for future authenticated requests.<br>❖ The system displays **MSG 7** (Verification successful).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |