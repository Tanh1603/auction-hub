# 3.5.2 Deny Bid

## 1. Use Case Description

| Field              | Description                                                                                             |
| ------------------ | ------------------------------------------------------------------------------------------------------- |
| **Name**           | Deny Bid                                                                                                |
| **Description**    | This use case allows the Admin to update existing Bid information in the system.                        |
| **Actor**          | Admin                                                                                                   |
| **Trigger**        | When the Admin clicks on the 'Deny Bid' button on the BidManagementPage.                                |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.         |
| **Post-condition** | The Bid information will be updated in the system and display new record on BidManagementPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "BidManagementPage" as View
control "BiddingController" as Controller
control "BiddingService" as Service
entity "BidRepository" as BidRepo
entity "AuctionRepository" as AuctionRepo
control "WebSocketGateway" as WSGateway

User -> View: Select Bid -> Deny (Reason)
View -> Controller: POST /manual-bid/deny\n{ bidId, reason }
activate Controller

Controller -> Service: denyBid(bidId, reason, requestorId)
activate Service

Service -> BidRepo: findBidWithAuction(bidId)
activate BidRepo
BidRepo --> Service: BidEntity, AuctionEntity
deactivate BidRepo

Service -> Service: Validate Permissions & Bid Status
note right: BR-01, BR-02

alt Not Authorized or Bid Already Denied
    Service --> Controller: Throw Forbidden/BadRequest
    Controller --> View: 403/400 Error
    View --> User: Display Error Message
else Valid Request
    Service -> Service: Start Transaction
    Service -> BidRepo: update({ id: bidId }, { isDenied: true, deniedAt: now(), deniedReason: reason })
    activate BidRepo
    BidRepo --> Service: UpdatedBid
    deactivate BidRepo

    Service -> Service: Recalculate Highest Bid (if current highest denied)
    note right: BR-03
    Service -> AuctionRepo: update(auctionId, { currentHighestBid, winningBidderId })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> Service: Commit Transaction

    Service -> WSGateway: sendBidDeniedNotification(bidderId, auctionId)
    activate WSGateway
    WSGateway --> Service: Notification Acknowledged
    deactivate WSGateway

    alt Highest Bid Changed
        Service -> WSGateway: broadcastAuctionUpdate(auctionId, newHighestBid)
        activate WSGateway
        WSGateway --> Service: Broadcast Acknowledged
        deactivate WSGateway
    end

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Bid Denied)
    View --> User: Show Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Bid to Deny;
:(2) Input Reason (Optional);
:(3) Submit Denial;

|BiddingService|
:(4) Authenticate Requestor;
:(5) Verify Authorization (Admin/Auctioneer);
note right: BR-01

|BidRepository|
:(6) Retrieve Bid;

|AuctionRepository|
:(7) Retrieve Auction Details;

|BiddingService|
if (Bid Not Found?) then (Yes)
    :(8.1) Return 404 Not Found;
    |Admin/Auctioneer|
    :(8.2) View Error Message;
    stop
endif

if (Bid Already Denied?) then (Yes)
    :(9.1) Return 400 Bad Request;
    note right: BR-02
    |Admin/Auctioneer|
    :(9.2) View Error Message;
    stop
endif

|BiddingService|
:(10) Check if Denied Bid is Current Highest;

|BidRepository|
:(11) BEGIN TRANSACTION;
:(12) Update AuctionBid to isDenied=true;
:(13) Record deniedAt & deniedReason;

|BiddingService|
if (Denied Bid was Current Highest?) then (Yes)
    :(14) Find New Highest Valid Bid for Auction;
    note right: BR-03
    |AuctionRepository|
    :(15) Update Auction currentHighestBid, winningBidder;
endif

|BiddingService|
:(16) COMMIT TRANSACTION;
note right: BR-05

|WebSocketGateway|
:(17) Send `bidDenied` Notification to Bidder;
note right: BR-04
:(18) Broadcast `auctionUpdate` to all participants (if highest bid changed);

|BiddingService|
:(19) Return Success;

|Admin/Auctioneer|
:(20) Receive Confirmation;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                              |
| :------------ | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**       | **BR-01** | **Displaying Rule (Bid Management Page):**<br>When Admin/Auctioneer reviews bids, system displays `BidManagementPage`.<br>System displays list of bids with bidder info, amount, timestamp.<br>System displays "Deny" button and optional reason input for each bid.                                                                                                     |
| **(2)-(3)**   | **BR-02** | **Validation Rule (Input - Front-end):**<br>When Admin enters denial reason, system uses `Text_change()` method.<br>On clicking "Deny", system displays MSG 11 ("Are you sure you want to deny this bid?").<br>System waits for confirmation before proceeding.                                                                                                          |
| **(4)-(5)**   | **BR-03** | **Validation Rule (Authorization - Back-end):**<br>System checks if requestor role is `admin`, `super_admin`, or auction owner in `USERS` table.<br>If unauthorized:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                                                                                                   |
| **(6)-(8.1)** | **BR-04** | **Validation Rule (Bid Existence - Back-end):**<br>System retrieves data from the 'AUCTION_BID' table in the database (Refer to 'AUCTION_BID' table in 'DB Sheet' file) based on the bid ID.<br>If bid not found:<br>$\rightarrow$ System displays MSG 20 ("Bid not found") on the View.                                                                                 |
| **(9.1)**     | **BR-05** | **Validation Rule (Already Denied - Back-end):**<br>System checks if `isDenied` flag is already `true`.<br>If already denied:<br>$\rightarrow$ System displays MSG 16 ("Bid already denied") on the View.                                                                                                                                                                |
| **(12)-(13)** | **BR-06** | **Storing Rule:**<br>System saves to `AUCTION_BID` table:<br>- `isDenied = true`<br>- `deniedAt = now()`<br>- `deniedReason = [input reason]`                                                                                                                                                                                                                            |
| **(14)-(15)** | **BR-07** | **Processing Rule (Recalculate Highest Bid):**<br>If denied bid was current highest, system retrieves data from the 'AUCTION_BID' table in the database (Refer to 'AUCTION_BID' table in 'DB Sheet' file) to find the next valid highest bid.<br>The Auction information will be updated in table 'AUCTION' in the database with the new highest bid and winning bidder. |
| **(17)-(18)** | **BR-08** | **Processing Rule (WebSocket Notifications):**<br>System sends `bidDenied` notification to the bidder whose bid was denied.<br>If highest bid changed, system broadcasts `auctionUpdate` to all room participants.                                                                                                                                                       |
| **(20)**      | **BR-09** | **Displaying Rule (Success Confirmation):**<br>System displays MSG 7 ("Bid denied successfully") on the View.<br>System refreshes bid list showing denied status.                                                                                                                                                                                                        |

```

```
