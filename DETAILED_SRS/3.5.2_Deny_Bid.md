# 3.5.2 Deny Bid

## 1. Use Case Description

| Field              | Description                                                                                             |
| ------------------ | ------------------------------------------------------------------------------------------------------- |
| **Name**           | Deny Bid                                                                                                |
| **Description**    | This use case allows the Admin to update existing Bid information in the system.                        |
| **Actor**          | Admin                                                                                                   |
| **Trigger**        | When the Admin clicks on the 'Deny Bid' button on the BidManagementPage.                                |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.         |
| **Post-condition** | The Bid information will be updated in the system and display new record on BidManagementPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "BidManagementPage" as View
control "BiddingController" as Controller
control "BiddingService" as Service
entity "BidRepository" as BidRepo
entity "AuctionRepository" as AuctionRepo
control "WebSocketGateway" as WSGateway

User -> View: Select Bid -> Deny (Reason)
View -> Controller: POST /manual-bid/deny\n{ bidId, reason }
activate Controller

Controller -> Service: denyBid(bidId, reason, requestorId)
activate Service

Service -> BidRepo: findBidWithAuction(bidId)
activate BidRepo
BidRepo --> Service: BidEntity, AuctionEntity
deactivate BidRepo

Service -> Service: Validate Permissions & Bid Status
note right: BR-01, BR-02

alt Not Authorized or Bid Already Denied
    Service --> Controller: Throw Forbidden/BadRequest
    Controller --> View: 403/400 Error
    View --> User: Display Error Message
else Valid Request
    Service -> Service: Start Transaction
    Service -> BidRepo: update({ id: bidId }, { isDenied: true, deniedAt: now(), deniedReason: reason })
    activate BidRepo
    BidRepo --> Service: UpdatedBid
    deactivate BidRepo

    Service -> Service: Recalculate Highest Bid (if current highest denied)
    note right: BR-03
    Service -> AuctionRepo: update(auctionId, { currentHighestBid, winningBidderId })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> Service: Commit Transaction

    Service -> WSGateway: sendBidDeniedNotification(bidderId, auctionId)
    activate WSGateway
    WSGateway --> Service: Notification Acknowledged
    deactivate WSGateway

    alt Highest Bid Changed
        Service -> WSGateway: broadcastAuctionUpdate(auctionId, newHighestBid)
        activate WSGateway
        WSGateway --> Service: Broadcast Acknowledged
        deactivate WSGateway
    end

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Bid Denied)
    View --> User: Show Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Bid to Deny;
:(2) Input Reason (Optional);
:(3) Submit Denial;

|BiddingService|
:(4) Authenticate Requestor;
:(5) Verify Authorization (Admin/Auctioneer);
note right: BR-01

|BidRepository|
:(6) Retrieve Bid;

|AuctionRepository|
:(7) Retrieve Auction Details;

|BiddingService|
if (Bid Not Found?) then (Yes)
    :(8.1) Return 404 Not Found;
    |Admin/Auctioneer|
    :(8.2) View Error Message;
    stop
endif

if (Bid Already Denied?) then (Yes)
    :(9.1) Return 400 Bad Request;
    note right: BR-02
    |Admin/Auctioneer|
    :(9.2) View Error Message;
    stop
endif

|BiddingService|
:(10) Check if Denied Bid is Current Highest;

|BidRepository|
:(11) BEGIN TRANSACTION;
:(12) Update AuctionBid to isDenied=true;
:(13) Record deniedAt & deniedReason;

|BiddingService|
if (Denied Bid was Current Highest?) then (Yes)
    :(14) Find New Highest Valid Bid for Auction;
    note right: BR-03
    |AuctionRepository|
    :(15) Update Auction currentHighestBid, winningBidder;
endif

|BiddingService|
:(16) COMMIT TRANSACTION;
note right: BR-05

|WebSocketGateway|
:(17) Send `bidDenied` Notification to Bidder;
note right: BR-04
:(18) Broadcast `auctionUpdate` to all participants (if highest bid changed);

|BiddingService|
:(19) Return Success;

|Admin/Auctioneer|
:(20) Receive Confirmation;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**       | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “BidManagementPage” screen via `Display_View()`. (Refer to “BidManagementPage” view in “View Description” file).<br>❖ The screen renders a data table listing bids, including Bidder information, [Amount], and [Time].<br>❖ For each bid, a [Deny Bid] button and an optional [Reason] input field are provided.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(2)-(3)**   | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the Admin inputs a denial reason, the system performs `ValidateDenyBid(reason)` validation.<br>❖ If the input is not valid:<br>⮚ If the [reason] field is empty, the system displays **MSG 1** (Mandatory Field).<br>❖ Upon clicking “Deny”, the system displays **MSG 11** ("Confirm bid denial?") and awaits confirmation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **(4)-(5)**   | **BR-03** | **Authorization Rules (Back-end):**<br>❖ The system calls `BiddingService.denyBid(bidId, reason, requestorId)` to process the request.<br>❖ It verifies that the requestor's role is 'admin', 'super_admin', or the 'auctioneer' owning the auction.<br>❖ If the input is not valid:<br>⮚ If the user is unauthorized, the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(6)-(8.1)** | **BR-04** | **Validation Rules (Back-end):**<br>❖ The system calls `BidRepository.findBidWithAuction(bidId)` to retrieve the bid record.<br>❖ If the input is not valid:<br>⮚ If the bid is not found, the system returns a 404 Not Found error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(9.1)**     | **BR-05** | **State Locking Rules (Back-end):**<br>❖ The system calls `BiddingService.denyBid()` and checks the bid's [isDenied] status.<br>❖ If the input is not valid:<br>⮚ If the bid's [isDenied] flag is already `true`, the system returns a 400 Bad Request and displays **MSG 16** (Bid already denied).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(11)-(13)** | **BR-06** | **Storing Rules (Back-end):**<br>❖ This operation is executed within a database transaction:<br>⮚ The system updates the “AUCTION_BID” table, setting [isDenied] to `true`, and recording the `deniedAt` timestamp (NOW()) and the [deniedReason].<br>⮚ If the denied bid was the current highest, the system recalculates the next highest valid bid for the auction and updates the “AUCTION” table accordingly.<br>❖ The transaction is then committed.                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(17)-(18)** | **BR-07** | **Processing Rules (WebSockets):**<br>❖ The system calls `WebSocketGateway.sendBidDeniedNotification()` to notify the affected bidder.<br>❖ It emits a `bidDenied` event specifically to the bidder whose bid was denied.<br>❖ If the highest bid changed as a result of the denial, the system also broadcasts an `auctionUpdate` event to all participants in the auction room.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(20)**      | **BR-08** | **Displaying Rules (Success):**<br>❖ The system displays a success notification via `Refresh_DataTable('Bids')`.<br>❖ It displays **MSG 7** (Bid denied successfully) to the Admin.<br>❖ The data table showing the bids is updated to reflect the denied status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
```