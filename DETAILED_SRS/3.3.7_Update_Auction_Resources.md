# 3.3.5 Update Auction Resources

## 1. Use Case Description

| Field              | Description                                                                                                               |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Update Auction Resources                                                                                                  |
| **Description**    | This use case allows the Auctioneer/Admin to update existing Auction Resource information in the system.                  |
| **Actor**          | Auctioneer/Admin                                                                                                          |
| **Trigger**        | When the Auctioneer/Admin clicks on the [Icon Edit] button on the right of each item on the ManageResourcesPage datagrid. |
| **Pre-condition**  | • Auctioneer/Admin's device must be connected to the internet.<br>• Auctioneer/Admin is signed in with their account.     |
| **Post-condition** | The Auction Resource information will be updated in the system and display new record on ManageResourcesPage datagrid.    |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Auctioneer/Admin" as User
boundary "ManageResourcesPage" as View
control "AuctionController" as Controller
control "AuctionService" as Service
entity "CloudinaryService" as Cloudinary
entity "AuctionRepository" as Repo

User -> View: Manage Auction Resources (Upload/Delete/Order)
View -> Controller: PATCH /auctions/:id/resources\n{ AddResourcesDto, RemoveResourcesDto }
activate Controller

Controller -> Service: updateResources(auctionId, updateResourceDto, userId)
activate Service

Service -> Repo: findUnique(auctionId)
activate Repo
Repo --> Service: existingAuction
deactivate Repo

Service -> Service: Check Auction Status & Permissions
note right: BR-01, BR-02

alt Not Authorized or Immutable State
    Service --> Controller: Throw Forbidden/BadRequest
    Controller --> View: 403/400 Error
    View --> User: Display Error Message
else Authorized and Modifiable
    Service -> Service: Process New Uploads (if any)
    Service -> Cloudinary: Upload Files
    activate Cloudinary
    Cloudinary --> Service: File URLs/Metadata
    deactivate Cloudinary

    Service -> Service: Process Deletions (if any)
    Service -> Cloudinary: Delete Files
    activate Cloudinary
    Cloudinary --> Service: Deletion Status
    deactivate Cloudinary

    Service -> Repo: update({ where: { id: auctionId }, data: { images: newImages, attachments: newAttachments } })
    activate Repo
    Repo --> Service: updatedAuction
    deactivate Repo

    Service --> Controller: AuctionResponseDto
    Controller --> View: 200 OK (Resources Updated)
    View --> User: Show Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Auctioneer/Admin|
start
:(1) Initiate Resource Update;
:(2) Upload New Files / Delete Existing;

|AuctionService|
:(3) Authenticate Requestor;
:(4) Retrieve Auction;

|AuctionRepository|
:(5) Query Auction by ID;

|AuctionService|
if (Authorized & Modifiable State?) then (No)
    :(6.1) Return Error (e.g., 403 Forbidden);
    note right: BR-01, BR-02
    |Auctioneer/Admin|
    :(6.2) View Error Message;
    stop
endif

|AuctionService|
:(7) Process Incoming Resource Changes;

if (New Files to Upload?) then (Yes)
    |Auctioneer/Admin|
    :(8) Provide Files;
    |AuctionService|
    :(9) Receive Files;
    :(10) Validate File Types/Sizes;
    |CloudinaryService|
    :(11) Upload Files;
    :(12) Return URLs/Metadata;
endif

|AuctionService|
if (Files to Delete?) then (Yes)
    :(13) Request Deletion from Cloudinary;
    |CloudinaryService|
    :(14) Delete Files;
endif

|AuctionService|
:(15) Construct New JSONB Structure\n(images, attachments);
:(16) Update Auction Record in DB;

|AuctionRepository|
:(17) Save Updated Auction;

|AuctionService|
:(18) Return Success;

|Auctioneer/Admin|
:(19) View Updated Resources;
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :-------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**   | **BR-01** | **Displaying Rules:**<br>❖ The system renders a “ManageResourcesPage” via `Display_View(auction)` to manage auction-related files.<br>❖ It displays lists of both [Images] (with thumbnails and names) and [Attachments].<br>❖ The interface includes dedicated buttons for [Upload] and [Delete] resources.                                                                                                                                                                                                                                                                                                                                                                    |
| **(2)**   | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the Admin/Auctioneer uploads files, the system validates the file characteristics via `ValidateFile(File)`.<br>❖ If the input is not valid:<br>⮚ If the [FileType] is not JPG, PNG, or PDF, the system displays **MSG 4** (Invalid Type).<br>⮚ If the [FileSize] exceeds 5MB, the system displays **MSG 4** (File too large).                                                                                                                                                                                                                                                                                                                                    |
| **(6.1)** | **BR-03** | **State Locking Rules (Back-end):**<br>❖ The system calls `AuctionService.updateResources()` and checks the auction’s [status].<br>❖ If the input is not valid:<br>⮚ If the [status] is 'live' or 'finalized', the system returns a 400 Bad Request.<br>⮚ The system displays **MSG 13** (Cannot modify resources) to the user.                                                                                                                                                                                                                                                                                                                         |
| **(10)**  | **BR-04** | **Processing Rules (Cloud Upload):**<br>❖ The system initiates file uploads by calling `CloudinaryService.upload()` for any new files.<br>❖ Upon successful upload, Cloudinary returns a secure URL and a Public ID for each file.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **(16)**  | **BR-05** | **Storing Rules (Back-end):**<br>❖ When changes are confirmed, the system calls `AuctionService.updateResources(id, dto)` to update the “AUCTION” table.<br>❖ It updates the [images] and [attachments] JSONB fields with the new array structures.<br>❖ If the cloud operation or database update fails, the system displays **MSG 9** (System Error).<br>❖ System moves to step (19) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                                                                                                                                                                                                   |

