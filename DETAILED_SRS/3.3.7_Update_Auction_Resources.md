# 3.3.5 Update Auction Resources

## 1. Use Case Description

| Field              | Description                                                                                                               |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Update Auction Resources                                                                                                  |
| **Description**    | This use case allows the Auctioneer/Admin to update existing Auction Resource information in the system.                  |
| **Actor**          | Auctioneer/Admin                                                                                                          |
| **Trigger**        | When the Auctioneer/Admin clicks on the [Icon Edit] button on the right of each item on the ManageResourcesPage datagrid. |
| **Pre-condition**  | • Auctioneer/Admin's device must be connected to the internet.<br>• Auctioneer/Admin is signed in with their account.     |
| **Post-condition** | The Auction Resource information will be updated in the system and display new record on ManageResourcesPage datagrid.    |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Auctioneer/Admin" as User
boundary "ManageResourcesPage" as View
control "AuctionController" as Controller
control "AuctionService" as Service
entity "CloudinaryService" as Cloudinary
entity "AuctionRepository" as Repo

User -> View: Manage Auction Resources (Upload/Delete/Order)
View -> Controller: PATCH /auctions/:id/resources\n{ AddResourcesDto, RemoveResourcesDto }
activate Controller

Controller -> Service: updateResources(auctionId, updateResourceDto, userId)
activate Service

Service -> Repo: findUnique(auctionId)
activate Repo
Repo --> Service: existingAuction
deactivate Repo

Service -> Service: Check Auction Status & Permissions
note right: BR-01, BR-02

alt Not Authorized or Immutable State
    Service --> Controller: Throw Forbidden/BadRequest
    Controller --> View: 403/400 Error
    View --> User: Display Error Message
else Authorized and Modifiable
    Service -> Service: Process New Uploads (if any)
    Service -> Cloudinary: Upload Files
    activate Cloudinary
    Cloudinary --> Service: File URLs/Metadata
    deactivate Cloudinary

    Service -> Service: Process Deletions (if any)
    Service -> Cloudinary: Delete Files
    activate Cloudinary
    Cloudinary --> Service: Deletion Status
    deactivate Cloudinary

    Service -> Repo: update({ where: { id: auctionId }, data: { images: newImages, attachments: newAttachments } })
    activate Repo
    Repo --> Service: updatedAuction
    deactivate Repo

    Service --> Controller: AuctionResponseDto
    Controller --> View: 200 OK (Resources Updated)
    View --> User: Show Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Auctioneer/Admin|
start
:(1) Initiate Resource Update;
:(2) Upload New Files / Delete Existing;

|AuctionService|
:(3) Authenticate Requestor;
:(4) Retrieve Auction;

|AuctionRepository|
:(5) Query Auction by ID;

|AuctionService|
if (Authorized & Modifiable State?) then (No)
    :(6.1) Return Error (e.g., 403 Forbidden);
    note right: BR-01, BR-02
    |Auctioneer/Admin|
    :(6.2) View Error Message;
    stop
endif

|AuctionService|
:(7) Process Incoming Resource Changes;

if (New Files to Upload?) then (Yes)
    |Auctioneer/Admin|
    :(8) Provide Files;
    |AuctionService|
    :(9) Receive Files;
    :(10) Validate File Types/Sizes;
    |CloudinaryService|
    :(11) Upload Files;
    :(12) Return URLs/Metadata;
endif

|AuctionService|
if (Files to Delete?) then (Yes)
    :(13) Request Deletion from Cloudinary;
    |CloudinaryService|
    :(14) Delete Files;
endif

|AuctionService|
:(15) Construct New JSONB Structure\n(images, attachments);
:(16) Update Auction Record in DB;

|AuctionRepository|
:(17) Save Updated Auction;

|AuctionService|
:(18) Return Success;

|Auctioneer/Admin|
:(19) View Updated Resources;
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                     |
| :-------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**   | **BR-01** | **Querying Rule:**<br>System queries data in the table 'AUCTION' in the database (Refer to 'AUCTION' table in 'DB Sheet' file) based on the selected auction ID.<br>Call method `displayAuctionResources(images, attachments)` to populate resource management view.                                                                                                            |
| **(2)**   | **BR-02** | **Displaying Rule:**<br>The system displays a 'ManageResourcesPage' screen. (Refer to 'ManageResourcesPage' view in 'View Description' file).<br>Screen is populated with current images and attachments, with options to upload/delete/reorder.                                                                                                                                |
| **(6.1)** | **BR-03** | **Validation Rule (State Locking):**<br>System checks auction status before allowing resource changes.<br>If status is 'live' or 'finalized' → display **MSG 13** (Cannot modify resources), return 400.                                                                                                                                                                        |
| **(10)**  | **BR-04** | **Validation Rule (Front-end - File Constraints):**<br>When user uploads files, system validates file types (JPG, PNG, PDF) and size limits (max 5MB).<br>If invalid file type → display **MSG 4** (Invalid file format).<br>If file too large → display **MSG 4** (File size exceeded).                                                                                        |
| **(16)**  | **BR-05** | **Validation Rule (Back-end/Save):**<br>When user clicks 'Save' button, send data via function `updateResources(auctionId, resourceDto)`.<br>Upload new files to Cloudinary, delete removed files.<br>Update `images` and `attachments` JSONB fields in table `AUCTION`.<br>If success → show **MSG 7**, update view. If cloud operation fails → show **MSG 9** (System Error). |
