# 3.9.4 Create System Variable

## 1. Use Case Description

| Field              | Description                                                                                                     |
| ------------------ | --------------------------------------------------------------------------------------------------------------- |
| **Name**           | Create System Variable                                                                                          |
| **Description**    | This use case allows the Admin to create a new system configuration variable.                                   |
| **Actor**          | Admin, Super Admin                                                                                              |
| **Trigger**        | When the Admin submits a new variable via `POST /system-variables`.                                             |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with `admin` or `super_admin` role. |
| **Post-condition** | The new system configuration variable is created and stored in the database.                                    |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "SystemConfigPage" as View
control "SystemVariablesController" as Controller
control "SystemVariablesService" as Service
entity "SystemVariableRepository" as Repo

User -> View: Fill New Variable Form
View -> Controller: POST /system-variables\n{ category, key, value, dataType, description }
activate Controller

Controller -> Service: create(category, key, value, dataType, description)
activate Service

Service -> Repo: findByKey(category, key)
activate Repo
Repo --> Service: existingVariable (or null)
deactivate Repo

alt Variable Already Exists
    Service --> Controller: Throw ConflictException
    Controller --> View: 409 Conflict
    View --> User: Display Error Message
else Key is Unique
    Service -> Repo: create({ category, key, value, dataType, description })
    activate Repo
    Repo --> Service: NewVariable
    deactivate Repo

    Service --> Controller: SuccessResponse
    Controller --> View: 201 Created
    View --> User: Show Success Message
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin|
start
:(1) Input Variable Details;
:(2) (Category, Key, Value, DataType);
:(3) Submit Creation Request;

|SystemVariablesController|
:(4) Authenticate & Authorize;
note right: BR-01

|SystemVariablesService|
:(5) Validate Input Data;
note right: BR-02

if (Valid Input?) then (No)
    :(6.1) Return 400 Bad Request;
    |Admin|
    :(6.2) View Error Message;
    stop
endif

:(7) Check Key Uniqueness;
note right: BR-03

|SystemVariableRepository|
:(8) Query for Existing Key;

if (Key Exists?) then (Yes)
    |SystemVariablesService|
    :(9.1) Return 409 Conflict;
    |Admin|
    :(9.2) View Error Message;
    stop
endif

|SystemVariableRepository|
:(10) Insert New Variable Record;

|SystemVariablesService|
:(11) Return Success Response;

|Admin|
:(12) View New Variable;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                             |
| :------- | :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rule:**<br><br>Function: `Display_View('CreateSystemVariablePage')`<br><br>Logic:<br>Render form with [Category] dropdown, [Key] input, [Value] input, [DataType] dropdown, [Description] textarea.                         |
| **(2)**  | **BR-02** | **Validation Rule (Front-end):**<br><br>Function: `ValidateInput(form)`<br><br>Logic:<br>Key format: `lowercase.with.dots`.<br>Required fields: [Category], [Key], [Value], [DataType].<br>IF Invalid THEN Display MSG 1.                     |
| **(4)**  | **BR-03** | **Authorization Rule (Back-end):**<br><br>Function: Call `SystemVariablesService.create()`<br><br>Logic:<br>Check Requestor Role.<br>IF Role NOT IN ['admin', 'super_admin'] THEN Return 403 (Forbidden).                                   |
| **(7)**  | **BR-04** | **Uniqueness Rule (Back-end):**<br><br>Function: `SystemVariableRepository.findByKey(category, key)`<br><br>Logic:<br>IF (Category, Key) already exists THEN<br>  Return 409 Conflict<br>  Display MSG 12 (Key already exists).<br>END IF |
| **(10)** | **BR-05** | **Storing Rule (Back-end):**<br><br>Function: `SystemVariableRepository.create()`<br><br>Logic:<br>Insert into `SYSTEM_VARIABLE` table: [category], [key], [value], [dataType], [description], [isActive]=TRUE, [createdAt]=NOW().<br>Display MSG 7 (Success). |
| **(12)** | **BR-06** | **Displaying Rule (Success):**<br><br>Function: `Refresh_View('SystemConfigPage')`<br><br>Logic:<br>Show success notification.<br>Update variable list.                                                                                    |
