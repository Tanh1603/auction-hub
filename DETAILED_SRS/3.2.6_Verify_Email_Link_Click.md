# 3.2.6 Verify Email (Link Click)

## 1. Use Case Description

| Field              | Description                                                                                       |
| ------------------ | ------------------------------------------------------------------------------------------------- |
| **Name**           | Verify Email (Link Click)                                                                         |
| **Description**    | This use case allows the Guest to update existing Email Verification information in the system.   |
| **Actor**          | Guest                                                                                             |
| **Trigger**        | When the Guest clicks on the verification link in the EmailClient.                                |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest has received a verification email. |
| **Post-condition** | The Email Verification information will be updated in the system and Guest will be logged in.     |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "EmailClient" as Email
boundary "Browser" as Browser
control "AuthController" as Controller
control "AuthService" as Service
entity "SupabaseService" as Supabase
entity "UserRepository" as Repo

User -> Email: Receives Verification Email
User -> Browser: Clicks Verification Link
Browser -> Controller: GET /auth/verify?token=xxx&email=yyy
activate Controller

Controller -> Service: verifyEmailLink(token, email)
activate Service

Service -> Supabase: verifyOtp({ token, email, type: 'signup' })
activate Supabase

alt Token Invalid/Expired/Used
    Supabase --> Service: Error (Invalid/Expired token)
    Service --> Controller: Throw UnauthorizedException
    Controller --> Browser: 302 Redirect to Error Page
else Token Valid
    Supabase --> Service: AuthResponse (Session, User)
    deactivate Supabase

    Service -> Repo: updateUserStatus(email, { isVerified: true })
    activate Repo
    Repo --> Service: UpdatedUserEntity
    deactivate Repo

    Service --> Controller: SuccessResponse (with Session/JWT)
    Controller -> Browser: 302 Redirect to App Dashboard\n(with JWT as cookie/param)
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Click Verification Link;

|AuthService|
:(2) Receive GET Request;
:(3) Extract Token and Email from URL;
:(4) Forward to Supabase for Verification;

|SupabaseService|
:(5) Validate Token and Email;
note right: BR-01, BR-02

if (Verification Successful?) then (No)
    :(6.1) Return Error;
    |AuthService|
    :(6.2) Redirect to Verification Failure Page;
    note right: BR-04
    |Guest|
    :(6.3) View Error Page;
    stop
else (Yes)
    |SupabaseService|
    :(7) Mark Email as Confirmed;
    :(8) Generate User Session;
    :(9) Return Session Data;
endif

|AuthService|
:(10) Update Local User Record (isVerified=true);
note right: BR-03
:(11) Prepare Redirect URL with Auth Data;
:(12) Perform HTTP Redirect;

|Guest|
:(13) Browser Redirects to Application;
:(14) User is Logged In;
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :-------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**   | **BR-01** | **Querying Rules:**<br>❖ When the user clicks the verification link, the system calls `AuthController.verifyEmailLink(query)`.<br>❖ It extracts the [token] and [email] from the URL parameters.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(5)**   | **BR-02** | **Verification Rules (Back-end):**<br>❖ The system invokes `AuthService.verifyEmailLink()` to process the verification.<br>❖ It calls `Supabase.verifyOtp({ token, email, type: 'signup' })` to validate the token.<br>❖ If the input is not valid:<br>⮚ If the token is invalid, expired, or has been used, the system redirects to a 'VerificationFailedPage'.<br>⮚ The system displays **MSG 10** (Verification failed) on the error page.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(10)**  | **BR-03** | **Storing Rules (Back-end):**<br>❖ Upon successful verification, the system updates the user’s record by calling `UserRepository.updateUserStatus()`.<br>❖ It sets the [isVerified] field to `true` in the “USERS” table.<br>❖ The system also ensures local database status is synchronized with Supabase.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(6.2)** | **BR-04** | **Displaying Rules (Error):**<br>❖ If the verification fails for any reason, the system redirects the browser to a user-friendly 'Verification Failed' page by calling `Redirect('ErrorPage')`.<br>❖ The user is shown clear instructions, such as options to resend the verification email, rather than raw JSON error messages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **(14)**  | **BR-05** | **Displaying Rules (Success):**<br>❖ If the verification succeeds, the system performs an HTTP 302 redirect to the Application Dashboard by calling `Redirect('Dashboard')`.<br>❖ The JWT token is passed either via a cookie or as a URL parameter.<br>❖ The user is automatically logged in without needing a separate login action.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
