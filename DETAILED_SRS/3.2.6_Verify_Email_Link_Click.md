# 3.2.6 Verify Email (Link Click)

## 1. Use Case Description

| Field              | Description                                                                                       |
| ------------------ | ------------------------------------------------------------------------------------------------- |
| **Name**           | Verify Email (Link Click)                                                                         |
| **Description**    | This use case allows the Guest to update existing Email Verification information in the system.   |
| **Actor**          | Guest                                                                                             |
| **Trigger**        | When the Guest clicks on the verification link in the EmailClient.                                |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest has received a verification email. |
| **Post-condition** | The Email Verification information will be updated in the system and Guest will be logged in.     |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "EmailClient" as Email
boundary "Browser" as Browser
control "AuthController" as Controller
control "AuthService" as Service
entity "SupabaseService" as Supabase
entity "UserRepository" as Repo

User -> Email: Receives Verification Email
User -> Browser: Clicks Verification Link
Browser -> Controller: GET /auth/verify?token=xxx&email=yyy
activate Controller

Controller -> Service: verifyEmailLink(token, email)
activate Service

Service -> Supabase: verifyOtp({ token, email, type: 'signup' })
activate Supabase

alt Token Invalid/Expired/Used
    Supabase --> Service: Error (Invalid/Expired token)
    Service --> Controller: Throw UnauthorizedException
    Controller --> Browser: 302 Redirect to Error Page
else Token Valid
    Supabase --> Service: AuthResponse (Session, User)
    deactivate Supabase

    Service -> Repo: updateUserStatus(email, { isVerified: true })
    activate Repo
    Repo --> Service: UpdatedUserEntity
    deactivate Repo

    Service --> Controller: SuccessResponse (with Session/JWT)
    Controller -> Browser: 302 Redirect to App Dashboard\n(with JWT as cookie/param)
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Click Verification Link;

|AuthService|
:(2) Receive GET Request;
:(3) Extract Token and Email from URL;
:(4) Forward to Supabase for Verification;

|SupabaseService|
:(5) Validate Token and Email;
note right: BR-01, BR-02

if (Verification Successful?) then (No)
    :(6.1) Return Error;
    |AuthService|
    :(6.2) Redirect to Verification Failure Page;
    note right: BR-04
    |Guest|
    :(6.3) View Error Page;
    stop
else (Yes)
    |SupabaseService|
    :(7) Mark Email as Confirmed;
    :(8) Generate User Session;
    :(9) Return Session Data;
endif

|AuthService|
:(10) Update Local User Record (isVerified=true);
note right: BR-03
:(11) Prepare Redirect URL with Auth Data;
:(12) Perform HTTP Redirect;

|Guest|
:(13) Browser Redirects to Application;
:(14) User is Logged In;
stop
@enduml
```

## 4. Business Rules

| Activity  | BR Code   | Description                                                                                                                                                                                                                                                                                      |
| :-------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**   | **BR-01** | **Querying Rule:**<br>When user clicks verification link, system extracts token and email from URL parameters.<br>System queries the authentication provider to verify the OTP token against the email.                                                                                          |
| **(5)**   | **BR-02** | **Validation Rule (Token Integrity):**<br>System validates token signature and expiration against Supabase records.<br>If token invalid, expired, or tampered → redirect to error page with **MSG 10** (Verification failed).<br>If token already used (replay attack) → redirect to error page. |
| **(10)**  | **BR-03** | **Storing Rule:**<br>The User information will be updated in table 'USERS' in the database (Refer to 'USERS' table in 'DB Sheet' file) to set the verification status.<br>Sync local database status with Supabase.                                                                              |
| **(6.2)** | **BR-04** | **Displaying Rule (Error):**<br>If verification fails, system redirects browser to 'Verification Failed' page.<br>User sees friendly error message, not raw JSON error.                                                                                                                          |
| **(14)**  | **BR-05** | **Displaying Rule (Success):**<br>If verification succeeds, system performs HTTP 302 redirect to Application Dashboard.<br>JWT token is passed via cookie or URL parameter.<br>User is automatically logged in without separate login action.                                                    |
