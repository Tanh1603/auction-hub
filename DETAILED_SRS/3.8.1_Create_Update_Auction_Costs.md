# 3.8.1 Create/Update Auction Costs

## 1. Use Case Description

| Field              | Description                                                                                                          |
| ------------------ | -------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Create/Update Auction Costs                                                                                          |
| **Description**    | This use case allows the Admin to create a new or update existing Auction Costs information in the system.           |
| **Actor**          | Admin                                                                                                                |
| **Trigger**        | When the Admin clicks on the 'Save Costs' button on the AuctionCostPage.                                             |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                      |
| **Post-condition** | The Auction Costs information will be stored into the system and display updated record on AuctionCostPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuctionCostPage" as View
control "AuctionCostController" as Controller
control "AuctionCostService" as Service
database "AuctionRepository" as AuctionRepo
database "AuctionCostRepository" as CostRepo

User -> View: Enter Auction Costs (Ads, Rent, etc.)
View -> Controller: POST /auction-costs/auction/:auctionId\n{ advertisingCost, venueRentalCost... }
activate Controller

Controller -> Service: createOrUpdateCosts(auctionId, dto, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Check Permissions & State
note right: BR-01, BR-03

Service -> CostRepo: findByAuctionId(auctionId)
activate CostRepo
CostRepo --> Service: ExistingCosts (or null)
deactivate CostRepo

alt Costs Exist
    Service -> CostRepo: update(existingId, dto)
    activate CostRepo
    CostRepo --> Service: UpdatedCosts
    deactivate CostRepo
else No Costs Exist
    Service -> CostRepo: create({ ...dto, auctionId })
    activate CostRepo
    CostRepo --> Service: NewCosts
    deactivate CostRepo
end

Service --> Controller: AuctionCostResponseDto
Controller --> View: 200 OK (Costs Saved)
View --> User: View Saved Costs
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Auction;
:(2) Input Cost Details;
:(3) Submit Cost Form;

|AuctionCostService|
:(4) Authenticate & Authorize;
note right: BR-01

|AuctionRepository|
:(5) Retrieve Auction Context;

|AuctionCostService|
if (Auction Finalized?) then (Yes)
    :(6.1) Check if Post-Finalization Update Allowed;
    note right: BR-03
endif

|AuctionCostRepository|
:(7) Check for Existing Cost Record;

|AuctionCostService|
if (Record Exists?) then (Yes)
    |AuctionCostRepository|
    :(8.1) Update Existing Record;
else (No)
    |AuctionCostRepository|
    :(8.2) Create New Cost Record;
endif

|AuctionCostService|
:(9) Recalculate Total Costs;
note right: BR-02

:(10) Return Updated Cost Data;

|Admin/Auctioneer|
:(11) View Saved Costs;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                   |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**       | **BR-01** | **Displaying Rule (Auction Cost Page):**<br>When Admin/Auctioneer selects an auction for cost management, system displays `AuctionCostPage`.<br>If costs exist, fields are pre-populated with existing values.                                                                                                                                                |
| **(2)**       | **BR-02** | **Validation Rule (Input Fields - Front-end):**<br>When Admin inputs cost values, system triggers `Text_change()` validation.<br>All cost fields must be non-negative numbers.<br>If invalid:<br>$\rightarrow$ System displays MSG 4 ("Invalid cost value") adjacent to field.                                                                                |
| **(4)**       | **BR-03** | **Validation Rule (Authorization - Back-end):**<br>System checks if requestor role is `admin` or `auctioneer` in `USERS` table.<br>If unauthorized:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                                                                                                         |
| **(6.1)**     | **BR-04** | **Validation Rule (Auction Status - Back-end):**<br>System checks if auction is finalized.<br>Updates generally allowed only for non-finalized auctions.<br>Policy may permit post-finalization corrections.                                                                                                                                                  |
| **(7)-(8.2)** | **BR-05** | **Querying/Storing Rule (Upsert Logic):**<br>System retrieves data from the 'AUCTION_COST' table in the database (Refer to 'AUCTION_COST' table in 'DB Sheet' file) based on the auction ID to check for existing record.<br>If exists: The cost data will be updated in the existing record.<br>If not exists: The cost data will be stored as a new record. |
| **(9)**       | **BR-06** | **Processing Rule (Total Calculation):**<br>System automatically calculates `totalCosts` field:<br>$totalCosts = advertisingCost + venueRentalCost + appraisalCost + ...$                                                                                                                                                                                     |
| **(11)**      | **BR-07** | **Displaying Rule (Confirmation):**<br>System displays MSG 7 ("Auction costs saved successfully") on the View.<br>System displays updated cost breakdown with calculated total.                                                                                                                                                                               |
