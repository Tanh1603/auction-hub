# 3.8.1 Create/Update Auction Costs

## 1. Use Case Description

| Field              | Description                                                                                                          |
| ------------------ | -------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Create/Update Auction Costs                                                                                          |
| **Description**    | This use case allows the Admin to create a new or update existing Auction Costs information in the system.           |
| **Actor**          | Admin                                                                                                                |
| **Trigger**        | When the Admin clicks on the 'Save Costs' button on the AuctionCostPage.                                             |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                      |
| **Post-condition** | The Auction Costs information will be stored into the system and display updated record on AuctionCostPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuctionCostPage" as View
control "AuctionCostController" as Controller
control "AuctionCostService" as Service
database "AuctionRepository" as AuctionRepo
database "AuctionCostRepository" as CostRepo

User -> View: Enter Auction Costs (Ads, Rent, etc.)
View -> Controller: POST /auction-costs/auction/:auctionId\n{ advertisingCost, venueRentalCost... }
activate Controller

Controller -> Service: createOrUpdateCosts(auctionId, dto, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Check Permissions & State
note right: BR-01, BR-03

Service -> CostRepo: findByAuctionId(auctionId)
activate CostRepo
CostRepo --> Service: ExistingCosts (or null)
deactivate CostRepo

alt Costs Exist
    Service -> CostRepo: update(existingId, dto)
    activate CostRepo
    CostRepo --> Service: UpdatedCosts
    deactivate CostRepo
else No Costs Exist
    Service -> CostRepo: create({ ...dto, auctionId })
    activate CostRepo
    CostRepo --> Service: NewCosts
    deactivate CostRepo
end

Service --> Controller: AuctionCostResponseDto
Controller --> View: 200 OK (Costs Saved)
View --> User: View Saved Costs
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Auction;
:(2) Input Cost Details;
:(3) Submit Cost Form;

|AuctionCostService|
:(4) Authenticate & Authorize;
note right: BR-01

|AuctionRepository|
:(5) Retrieve Auction Context;

|AuctionCostService|
if (Auction Finalized?) then (Yes)
    :(6.1) Check if Post-Finalization Update Allowed;
    note right: BR-03
endif

|AuctionCostRepository|
:(7) Check for Existing Cost Record;

|AuctionCostService|
if (Record Exists?) then (Yes)
    |AuctionCostRepository|
    :(8.1) Update Existing Record;
else (No)
    |AuctionCostRepository|
    :(8.2) Create New Cost Record;
endif

|AuctionCostService|
:(9) Recalculate Total Costs;
note right: BR-02

:(10) Return Updated Cost Data;

|Admin/Auctioneer|
:(11) View Saved Costs;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**       | **BR-01** | **Displaying Rules:**<br>❖ The system renders an “AuctionCostPage” via `Display_View(auctionId)`.<br>❖ It displays an input form for cost fields: `advertisingCost`, `venueRentalCost`, `appraisalCost`, etc.<br>❖ If an existing record is found, the fields are pre-populated with current values.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(2)**       | **BR-02** | **Validation Rules (Front-end):**<br>❖ The system validates the input using `ValidateCostInput(value)`.<br>❖ If the input is not valid:<br>⮚ If any cost field is non-numeric or less than 0, the system displays **MSG 4** (Invalid cost value).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **(4)**       | **BR-03** | **Authorization Rules (Back-end):**<br>❖ The system checks the authenticated user's role via `AuctionCostService.createOrUpdateCosts()` to ensure they have the necessary permissions.<br>❖ If the input is not valid:<br>⮚ If the user's role is not 'admin' or 'auctioneer', the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(6.1)**     | **BR-04** | **State Locking Rules (Back-end):**<br>❖ The system checks the auction state via `AuctionService.isFinalized(auctionId)`.<br>❖ If the input is not valid:<br>⮚ If the [status] is 'success' or 'failed', the system prevents modification and returns a 400 Bad Request, unless a specific policy override is active.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **(7)-(8.2)** | **BR-05** | **Storing Rules (Upsert - Back-end):**<br>❖ The system queries the “AUCTION_COST” table by [auctionId].<br>❖ If a record exists, the system calls `CostRepository.update()` to modify it.<br>❖ If no record exists, the system calls `CostRepository.create()` to insert a new one, linking it to the [auctionId].<br>❖ System moves to step (11) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(9)**       | **BR-06** | **Calculation Rules (Back-end):**<br>❖ The system calculates the total costs via `AuctionCostService.calculateTotalCosts(costs)`.<br>❖ The formula is: `totalCosts = sum(all_individual_cost_fields) + sum(otherCosts.amount)`.<br>❖ The calculated `totalCosts` is stored in the “AUCTION_COST” record.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(11)**      | **BR-07** | **Displaying Rules (Success):**<br>❖ The system refreshes the view via `Refresh_View('AuctionCostPage')`.<br>❖ It updates the displayed costs and the newly calculated total.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |