# 3.6.1 Evaluate Auction

## 1. Use Case Description

| Field              | Description                                                                                                    |
| ------------------ | -------------------------------------------------------------------------------------------------------------- |
| **Name**           | Evaluate Auction                                                                                               |
| **Description**    | This use case allows the Admin to search Auction Evaluation information in the system based on input keywords. |
| **Actor**          | Admin                                                                                                          |
| **Trigger**        | When Admin clicks on the 'Evaluate' button on the AuctionEvaluationPage screen.                                |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                |
| **Post-condition** | The Auction Evaluation information will be displayed on the AuctionEvaluationPage screen.                      |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuctionEvaluationPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
entity "AuctionRepository" as AuctionRepo
entity "BidRepository" as BidRepo

User -> View: Select Auction -> Request Evaluation
View -> Controller: GET /auction-finalization/evaluate/:auctionId
activate Controller

Controller -> Service: evaluateAuction(auctionId, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> BidRepo: findValidBidsForAuction(auctionId)
activate BidRepo
BidRepo --> Service: BidEntity[]
deactivate BidRepo

Service -> Service: Perform Evaluation Logic
note right: BR-02, BR-03, BR-04

Service --> Controller: AuctionEvaluationDto
deactivate Service

Controller --> View: 200 OK (JSON)
deactivate Controller

View --> User: Display Evaluation Summary
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Request Auction Evaluation;

|FinalizationService|
:(2) Authenticate & Authorize;
note right: BR-01

|AuctionRepository|
:(3) Retrieve Auction Details;

|BidRepository|
:(4) Retrieve All Valid Bids for Auction;
note right: Exclude denied bids

|FinalizationService|
if (Auction Not Found?) then (No)
    :(5.1) Return 404 Not Found;
    |Admin/Auctioneer|
    :(5.2) View Error Message;
    stop
endif

if (Auction Not Concluded?) then (No)
    ' Allow evaluation before conclusion for specific cases
endif

|FinalizationService|
:(6) Determine Highest Valid Bid;
note right: BR-03

:(7) Check if Reserve Price Met;
note right: BR-04

:(8) Identify Potential Winning Bidder;

:(9) Calculate Preliminary Financials\n(Fees, commission, payout);
note right: BR-05

:(10) Format Evaluation Summary;
:(11) Return Evaluation Report;

|Admin/Auctioneer|
:(12) Review Auction Evaluation;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :---------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Displaying Rules:**<br>❖ The system renders an “AuctionEvaluationPage” via `Display_View()`.<br>❖ It displays the comprehensive [Auction Details].<br>❖ A prominent [Evaluate] button is shown to trigger the evaluation process.<br>❖ A loading indicator is displayed while data is being fetched or processed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(2)**     | **BR-02** | **Authorization Rules (Back-end):**<br>❖ The system checks the user's permissions by calling `FinalizationService.evaluateAuction()`.<br>❖ If the input is not valid:<br>⮚ If the requestor's role is not 'admin' or 'auctioneer', the system denies access.<br>⮚ It returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(3)**     | **BR-03** | **Querying Rules:**<br>❖ The system retrieves the auction record using `AuctionRepository.findById(auctionId)`.<br>❖ If the input is not valid:<br>⮚ If the auction is not found, the system returns a 404 Not Found error.<br>⮚ It displays **MSG 20** (Auction not found).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(4)**     | **BR-04** | **Querying Rules (Bids):**<br>❖ The system fetches valid bids via `BidRepository.findValidBidsForAuction(auctionId)`.<br>❖ It selects bids where the [isDenied] flag is `false`.<br>❖ The results are ordered by [amount] in descending order.<br>❖ The query limits the result to 1 to identify the Highest Bid.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **(6)-(9)** | **BR-05** | **Calculation Rules (Back-end):**<br>❖ The system performs the evaluation calculation via `FinalizationService.calculateEvaluation()`.<br>❖ It identifies the `HighestBid` from the retrieved bids.<br>❖ If `HighestBid` is greater than or equal to the [reservePrice], the [status] is set to 'success'; otherwise, it is set to 'failed'.<br>❖ The system calculates the [commission] based on the `HighestBid` and the applicable rate.<br>❖ It calculates the [payout] as `HighestBid - Fees`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **(12)**    | **BR-06** | **Displaying Rules:**<br>❖ The system presents the evaluation results using `Display_Evaluation_Report(report)`.<br>❖ It shows the [HighestBid] amount.<br>❖ It displays the [Winner], with their identity masked for privacy.<br>❖ It indicates the [Outcome] (Success/Fail).<br>❖ A full financial breakdown, including Fees and Net Payout, is displayed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
