# 3.1.3 Promote User Role

## 1. Use Case Description

| Field              | Description                                                                                                    |
| ------------------ | -------------------------------------------------------------------------------------------------------------- |
| **Name**           | Promote User Role                                                                                              |
| **Description**    | This use case allows the Admin to update existing User Role information in the system.                         |
| **Actor**          | Admin                                                                                                          |
| **Trigger**        | When the Admin clicks on the [Icon Edit] button on the right of each item on the UserManagementPage datagrid.  |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                |
| **Post-condition** | The User Role information will be updated in the system and display new record on UserManagementPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as Admin
boundary "UserManagementPage" as View
control "AdminController" as Controller
control "AdminService" as Service
database "UserRepository" as Repo

Admin -> View: Select User & New Role
View -> Controller: PUT /auth/admin/users/:userId/promote\n{ role: 'new_role' }
activate Controller

Controller -> Service: promoteUser(requestorId, targetUserId, newRole)
activate Service

Service -> Repo: findUserById(requestorId)
activate Repo
Repo --> Service: RequestorEntity
deactivate Repo

Service -> Service: Check Permissions
note right: BR-01, BR-02

alt Insufficient Permissions
    Service --> Controller: Throw ForbiddenException
    Controller --> View: 403 Forbidden
    View --> Admin: Show Error Message
else Permissions Valid
    Service -> Repo: updateUserRole(targetUserId, newRole)
    activate Repo
    Repo --> Service: UpdatedUserEntity
    deactivate Repo
    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Role Updated)
    View --> Admin: Show Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin|
start
:(1) Select Target User;
:(2) Select New Role;
:(3) Submit Promotion Request;

|AdminService|
:(4) Authenticate Requestor;
:(5) Retrieve Requestor's Role;

if (Is Requestor Admin or SuperAdmin?) then (No)
    :(6.1) Return 403 Forbidden;
    |Admin|
    :(6.2) View Error Message;
    stop
endif

|AdminService|
:(7) Check Role Hierarchy;
note right: BR-02, BR-03

if (Requestor is Admin AND\nTarget Role is Admin/SuperAdmin?) then (Yes)
    :(8.1) Return 403 Forbidden\n(Cannot promote to peer/superior);
    |Admin|
    :(8.2) View Error Message;
    stop
else (No)
    :(9) Proceed with Update;
endif

|UserRepository|
:(10) Update User Role;

|AdminService|
:(11) Log Action (Audit);
:(12) Return Success Response;

|Admin|
:(13) Receive Confirmation;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “UserManagementPage” screen in edit mode. (Refer to “UserManagementPage” view in “View Description” file).<br>❖ The system calls `Display_View()` to show the target user's details.<br>❖ The system populates the Role dropdown with available options: [Bidder], [Auctioneer], [Admin], and [Super Admin].                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **(2)**  | **BR-02** | **Validation Rules (Input):**<br>❖ When the Admin selects a role, the system uses the `Selection_change()` method to validate the input.<br>❖ If the input is not valid:<br>⮚ If the [role] field is empty, the system displays **MSG 1** (Mandatory Field).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(7)**  | **BR-03** | **Authorization Rules (Back-end):**<br>❖ When the Admin submits the promotion, the system calls `AdminService.promoteUser(userId, promoteUserDto)`.<br>❖ The system checks the hierarchy constraints between the Requestor and the Target.<br>❖ If the input is not valid:<br>⮚ If an 'admin' tries to promote a user to 'admin' or higher, the system returns a 403 Forbidden status.<br>⮚ The system displays **MSG 6** (Insufficient Permissions).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **(10)** | **BR-04** | **Storing Rules:**<br>❖ The system executes the promotion by updating the table “USERS” in the database.<br>❖ It sets the [role] field to the selected [NewRole].<br>❖ The system logs the action in the audit trail.<br>❖ System moves to step (12) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
