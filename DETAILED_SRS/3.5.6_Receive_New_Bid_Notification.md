# 3.5.6 Receive New Bid Notification

## 1. Use Case Description

| Field              | Description                                                                                                 |
| ------------------ | ----------------------------------------------------------------------------------------------------------- |
| **Name**           | Receive New Bid Notification                                                                                |
| **Description**    | This use case allows the User to search Bid Notification information in the system based on input keywords. |
| **Actor**          | User                                                                                                        |
| **Trigger**        | When a new bid is placed in the auction room.                                                               |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.               |
| **Post-condition** | The Bid Notification information will be displayed on the AuctionDetailPage screen.                         |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
control "BiddingService" as Service
entity "BidRepository" as BidRepo
entity "AuctionRepository" as AuctionRepo
control "WebSocketGateway" as WSGateway
boundary "WebSocketClient" as WSClient
boundary "AuctionDetailPage" as View

Service -> BidRepo: Bid Placed
activate BidRepo
BidRepo --> Service: NewBidEntity
deactivate BidRepo

Service -> AuctionRepo: Auction Updated
activate AuctionRepo
AuctionRepo --> Service: UpdatedAuction
deactivate AuctionRepo

Service -> WSGateway: emitNewBidNotification(auctionId, newBidDetails)
activate WSGateway

WSGateway -> WSGateway: Broadcast `newBid` to room (auctionId)
note right: BR-01, BR-02

WSGateway --> WSClient: Emit `newBid` (NewBidDto)
WSClient -> View: Update UI with NewBidDto
View --> User: Observe New Highest Bid
deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|BiddingService|
start
:(1) New Valid Bid Processed;

|AuctionRepository|
:(2) Auction Highest Bid Updated;

|WebSocketGateway|
:(3) Prepare `newBid` Event Payload;
note right: BR-02, BR-04

:(4) Broadcast `newBid` Event;
note right: BR-01

|User|
:(5) Receive `newBid` Event;
:(6) Parse New Bid Data;
:(7) Update Bid Display in UI;
:(8) Observe New Highest Bid;
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| :---------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)** | **BR-01** | **Processing Rules (Bid Trigger):**<br>❖ The system initiates this workflow via `BiddingService.placeManualBid()`.<br>❖ It is triggered automatically when a new valid bid is successfully saved to the “AUCTION_BID” table and the corresponding auction's highest bid is updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(3)**     | **BR-02** | **Processing Rules (Payload Preparation):**<br>❖ The system constructs the notification payload using `WebSocketGateway.emitNewBidNotification()`.<br>❖ The payload includes the [amount], the [bidderName], the [bidAt] timestamp, and an [isWinningBid] flag.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(3)**     | **BR-03** | **Processing Rules (Privacy Protection):**<br>❖ The system applies privacy filtering using `Mask_Bidder_Identity(name)`.<br>❖ It masks the bidder's name (e.g., converting "John Doe" to "Bidder ****123") for public broadcast.<br>❖ The [isOwnBid] flag is set to `true` only for the socket connection belonging to the bidder who placed the bid, ensuring other participants cannot identify them.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(4)**     | **BR-04** | **Processing Rules (Targeted Broadcast):**<br>❖ The system broadcasts the `newBid` event by calling `WebSocketGateway.toRoom(auctionId).emit('newBid')`.<br>❖ This ensures the notification is sent to all clients currently subscribed to the specific auction room, prioritizing low-latency delivery.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **(5)-(8)** | **BR-05** | **Displaying Rules (UI Update):**<br>❖ Upon receiving the `newBid` event via WebSocket, the client calls `Display_NewBid_Animation(newBidDto)`.<br>❖ The system updates the [CurrentBid] value on the screen.<br>❖ It applies a visual flash or highlight effect to the new value.<br>❖ The new bid is appended to the [BidHistory] list, and a notification toast "New Bid: [Amount]" is displayed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |