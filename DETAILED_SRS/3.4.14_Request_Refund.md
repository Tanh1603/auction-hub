# 3.4.14 Request Refund

## 1. Use Case Description

| Field              | Description                                                                                                           |
| ------------------ | --------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Request Refund                                                                                                        |
| **Description**    | This use case allows the Bidder to manually request a refund for their deposit.                                       |
| **Actor**          | Bidder                                                                                                                |
| **Trigger**        | When the Bidder clicks on the 'Request Refund' button on the MyRegistrationsPage.                                     |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in.<br>• Participant has paid the deposit. |
| **Post-condition** | The Refund Request is recorded, status set to 'PENDING', and Admin is notified for processing.                        |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "MyRegistrationsPage" as View
control "RegistrationController" as Controller
control "RefundService" as Service
entity "ParticipantRepository" as ParticipantRepo

User -> View: Select Registration
User -> View: Click "Request Refund"
View -> Controller: POST /register-to-bid/request-refund\n{ auctionId, reason }
activate Controller

Controller -> Service: requestRefund(auctionId, userId, reason)
activate Service

Service -> ParticipantRepo: findParticipant(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> Service: ParticipantEntity
deactivate ParticipantRepo

alt Not Found / Not Eligible
    Service --> Controller: Throw BadRequestException (Ineligible)
    Controller --> View: 400 Bad Request
    View --> User: Display Error (e.g. Winner/Disqualified)
else Eligible
    Service -> ParticipantRepo: updateParticipant({ \n  refundStatus: 'PENDING', \n  refundRequestedAt: now(), \n  refundReason: reason \n})
    activate ParticipantRepo
    ParticipantRepo --> Service: UpdatedParticipant
    deactivate ParticipantRepo

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK
    View --> User: Display Success Message
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Bidder|
start
:(1) View Own Registrations;
:(2) Identify Refundable Auction;
:(3) Submit Refund Request;

|RefundService|
:(4) Authenticate User;
:(5) Check Eligibility;
note right: BR-01

|ParticipantRepository|
:(6) Retrieve Participant Data;

|RefundService|
if (Eligible for Refund?) then (No)
    :(7.1) Return Ineligible Error;
    |Bidder|
    :(7.2) View Error Message;
    stop
endif

|ParticipantRepository|
:(8) Update refundStatus = 'PENDING';
:(9) Record refundRequestedAt;

|RefundService|
:(10) Return Success;

|Bidder|
:(11) View Status: Pending;
stop
@enduml
```

## 4. Business Rules

| Activity     | BR Code   | Description                                                                                                                                                                                                                                                                                                                                       |
| :----------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)-(2)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays "MyRegistrationsPage" via `Display_View()`.<br>❖ The [Request Refund] button is enabled only if the registration [status] is 'FINAL_APPROVED' and the auction has ended, OR if the user 'WITHDREW' before the sale end time.<br>❖ Winners of the auction will not see the [Request Refund] button. |
| **(3)**      | **BR-02** | **Validation Rules (Front-end):**<br>❖ When clicking "Request Refund", the system prompts for a reason (optional).<br>❖ It displays a warning: "Application Fee is non-refundable. Only the Deposit amount will be returned."                                                                                                                     |
| **(5)**      | **BR-03** | **Eligibility Rules (Back-end):**<br>❖ The system verifies that the participant is NOT the winner.<br>❖ The system verifies that the participant is NOT disqualified (e.g., status is not 'BANNED' or 'FORFEITED').<br>❖ If disqualified, the deposit is forfeited (See Section 5 for forfeiture cases).                                          |
| **(8)-(9)**  | **BR-04** | **Storing Rules (Back-end):**<br>❖ Upon validation, the system updates the `AUCTION_PARTICIPANT` table.<br>❖ Sets `refundStatus` to 'PENDING'.<br>❖ Records the timestamp in `refundRequestedAt`.                                                                                                                                                 |
| **(System)** | **BR-05** | **Auto-Refund System:**<br>❖ A background job runs daily to automatically process refunds for all non-winners 3 business days after auction finalization if they haven't requested manually.<br>❖ Auto-processed refunds are marked as `auto_processed`.                                                                                          |

## 5. Deposit Forfeiture Cases (BR-03 Detail)

| Code                  | Description                                    |
| :-------------------- | :--------------------------------------------- |
| `NO_SHOW`             | Didn't attend auction                          |
| `FALSE_INFORMATION`   | False registration info                        |
| `FORGED_DOCUMENTS`    | Forged documents                               |
| `PRICE_RIGGING`       | Price manipulation/collusion                   |
| `AUCTION_OBSTRUCTION` | Obstructed auction                             |
| `BID_WITHDRAWAL`      | Withdrew placed bid                            |
| `REFUSED_TO_SIGN`     | Refused to sign minutes (2 days deadline)      |
| `REFUSED_RESULT`      | Refused winning result                         |
| `PAYMENT_DEFAULT`     | Winner payment default (3 days after contract) |
| `CONTRACT_DEFAULT`    | Failed to sign contract (7 days)               |
| `CHECK_IN_FAILURE`    | Failed check-in before auction ends            |
| `LATE_WITHDRAWAL`     | Withdrew after `saleEndAt`                     |
