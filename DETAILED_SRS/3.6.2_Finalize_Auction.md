# 3.6.2 Finalize Auction

## 1. Use Case Description

| Field              | Description                                                                                                      |
| ------------------ | ---------------------------------------------------------------------------------------------------------------- |
| **Name**           | Finalize Auction                                                                                                 |
| **Description**    | This use case allows the Admin to update existing Auction information in the system.                             |
| **Actor**          | Admin                                                                                                            |
| **Trigger**        | When the Admin clicks on the 'Finalize Auction' button on the FinalizationPage.                                  |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                  |
| **Post-condition** | The Auction information will be updated in the system and display finalized status on FinalizationPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "FinalizationPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
database "AuctionRepository" as AuctionRepo
database "BidRepository" as BidRepo
database "AuditLogRepository" as AuditLogRepo

User -> View: Select Concluded Auction -> Finalize
View -> Controller: POST /auction-finalization/finalize\n{ auctionId }
activate Controller

Controller -> Service: finalizeAuction(auctionId, userId)
activate Service

Service -> AuctionRepo: findByIdWithBids(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity (with bids)
deactivate AuctionRepo

Service -> Service: Validate Auction State
note right: BR-02

alt Not Concluded or Already Finalized
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Valid for Finalization
    Service -> Service: Determine Outcome (Success/Failed)
    note right: BR-03
    Service -> Service: Calculate Financial Summary
    note right: BR-04

    Service -> Service: Start Transaction
    Service -> AuctionRepo: update(auctionId, { status, finalSalePrice, commissionFee, etc. })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> AuditLogRepo: create({ action: 'AUCTION_FINALIZED', ... })
    activate AuditLogRepo
    AuditLogRepo --> Service: NewAuditLog
    deactivate AuditLogRepo
    Service -> Service: Commit Transaction

    Service --> Controller: SuccessResponse (FinalizedAuctionDto)
    Controller --> View: 200 OK (Auction Finalized)
    View --> User: Show Finalized Status
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Auction;
:(2) Trigger Finalization;

|FinalizationService|
:(3) Authenticate & Authorize;
note right: BR-01

|AuctionRepository|
:(4) Retrieve Auction & Bid Data;

|FinalizationService|
if (Auction Concluded & Not Finalized?) then (No)
    :(5.1) Return 400 Bad Request;
    note right: BR-02
    |Admin/Auctioneer|
    :(5.2) View Error Message;
    stop
endif

|FinalizationService|
:(6) Determine Final Outcome (Winner/No Bid);
note right: BR-03

:(7) Calculate Final Financial Summary;
note right: BR-04

|FinalizationService|
:(8) BEGIN TRANSACTION;

|AuctionRepository|
:(9) Update Auction Status;
:(10) Snapshot Financial Fields;

|AuditLogRepository|
:(11) Log Finalization Action;
note right: BR-06

|FinalizationService|
:(12) COMMIT TRANSACTION;
note right: BR-05

|FinalizationService|
:(13) Return Success Response;
:(14) Trigger Post-Finalization Processes\n(e.g., winner notifications, contract generation preparation);

|Admin/Auctioneer|
:(15) View Finalized Auction Status;
stop
@enduml
```

## 4. Business Rules

| Activity     | BR Code   | Description                                                                                                                                                                                                                                                          |
| :----------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)**  | **BR-01** | **Displaying Rule (Finalization Page):**<br>When Admin selects a concluded auction, system displays `FinalizationPage`.<br>System displays evaluation summary and "Finalize Auction" button.<br>System shows current status and end time.                            |
| **(2)**      | **BR-02** | **Validation Rule (Confirmation - Front-end):**<br>When Admin clicks "Finalize Auction", system displays MSG 11 ("Confirm auction finalization? This action is irreversible.").<br>System waits for confirmation before proceeding.                                  |
| **(3)**      | **BR-03** | **Validation Rule (Authorization - Back-end):**<br>System checks if requestor role is `admin` or `auctioneer` in `USERS` table.<br>If unauthorized:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                |
| **(5.1)**    | **BR-04** | **Validation Rule (Auction State - Back-end):**<br>System checks if `auctionEndAt` has passed AND status is NOT already `success` or `failed`.<br>If invalid state:<br>$\rightarrow$ System displays MSG 25 ("Cannot finalize - invalid auction state") on the View. |
| **(6)**      | **BR-05** | **Processing Rule (Outcome Determination):**<br>System determines final status based on highest valid bid vs `reservePrice`:<br>- If bid >= reservePrice: status = `success`<br>- Otherwise: status = `failed`.                                                      |
| **(9)-(10)** | **BR-06** | **Storing Rule:**<br>System saves to `AUCTION` table:<br>- `status = [success/failed]`<br>- `finalSalePrice = [highest bid amount]`<br>- `commissionFee = [calculated fee]`<br>- `finalizedAt = now()`                                                               |
| **(11)**     | **BR-07** | **Storing Rule (Audit Log):**<br>System creates record in `AUCTION_AUDIT_LOG` table:<br>- `action = 'AUCTION_FINALIZED'`<br>- `adminId = [current user]`<br>- `createdAt = now()`                                                                                    |
| **(15)**     | **BR-08** | **Displaying Rule (Success Confirmation):**<br>System displays MSG 7 ("Auction finalized successfully") on the View.<br>System updates status display to final outcome.                                                                                              |
