# 3.6.2 Finalize Auction

## 1. Use Case Description

| Field              | Description                                                                                                      |
| ------------------ | ---------------------------------------------------------------------------------------------------------------- |
| **Name**           | Finalize Auction                                                                                                 |
| **Description**    | This use case allows the Admin to update existing Auction information in the system.                             |
| **Actor**          | Admin                                                                                                            |
| **Trigger**        | When the Admin clicks on the 'Finalize Auction' button on the FinalizationPage.                                  |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                  |
| **Post-condition** | The Auction information will be updated in the system and display finalized status on FinalizationPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "FinalizationPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
database "AuctionRepository" as AuctionRepo
database "BidRepository" as BidRepo
database "AuditLogRepository" as AuditLogRepo

User -> View: Select Concluded Auction -> Finalize
View -> Controller: POST /auction-finalization/finalize\n{ auctionId }
activate Controller

Controller -> Service: finalizeAuction(auctionId, userId)
activate Service

Service -> AuctionRepo: findByIdWithBids(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity (with bids)
deactivate AuctionRepo

Service -> Service: Validate Auction State
note right: BR-02

alt Not Concluded or Already Finalized
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Valid for Finalization
    Service -> Service: Determine Outcome (Success/Failed)
    note right: BR-03
    Service -> Service: Calculate Financial Summary
    note right: BR-04

    Service -> Service: Start Transaction
    Service -> AuctionRepo: update(auctionId, { status, finalSalePrice, commissionFee, etc. })
    activate AuctionRepo
    AuctionRepo --> Service: UpdatedAuction
    deactivate AuctionRepo
    Service -> AuditLogRepo: create({ action: 'AUCTION_FINALIZED', ... })
    activate AuditLogRepo
    AuditLogRepo --> Service: NewAuditLog
    deactivate AuditLogRepo
    Service -> Service: Commit Transaction

    Service --> Controller: SuccessResponse (FinalizedAuctionDto)
    Controller --> View: 200 OK (Auction Finalized)
    View --> User: Show Finalized Status
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Auction;
:(2) Trigger Finalization;

|FinalizationService|
:(3) Authenticate & Authorize;
note right: BR-01

|AuctionRepository|
:(4) Retrieve Auction & Bid Data;

|FinalizationService|
if (Auction Concluded & Not Finalized?) then (No)
    :(5.1) Return 400 Bad Request;
    note right: BR-02
    |Admin/Auctioneer|
    :(5.2) View Error Message;
    stop
endif

|FinalizationService|
:(6) Determine Final Outcome (Winner/No Bid);
note right: BR-03

:(7) Calculate Final Financial Summary;
note right: BR-04

|FinalizationService|
:(8) BEGIN TRANSACTION;

|AuctionRepository|
:(9) Update Auction Status;
:(10) Snapshot Financial Fields;

|AuditLogRepository|
:(11) Log Finalization Action;
note right: BR-06

|FinalizationService|
:(12) COMMIT TRANSACTION;
note right: BR-05

|FinalizationService|
:(13) Return Success Response;
:(14) Trigger Post-Finalization Processes\n(e.g., winner notifications, contract generation preparation);

|Admin/Auctioneer|
:(15) View Finalized Auction Status;
stop
@enduml
```

## 4. Business Rules

| Activity     | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :----------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “FinalizationPage” screen via `Display_View()`.<br>❖ It renders the Evaluation Summary derived from the previous step.<br>❖ A [Finalize Auction] button is displayed.<br>❖ The system shows a prominent warning: "Irreversible Action" to alert the Admin.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(2)**      | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the Admin clicks "Finalize Auction", the system triggers a confirmation modal via `Display_Modal('ConfirmationBox')`.<br>❖ It displays **MSG 11** ("Confirm finalization?"), requiring the Admin to explicitly confirm the action.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **(3)**      | **BR-03** | **Authorization Rules (Back-end):**<br>❖ The system calls `FinalizationService.finalizeAuction()` and checks the user's role.<br>❖ If the input is not valid:<br>⮚ If the user is not an 'admin' or 'auctioneer', the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(5.1)**    | **BR-04** | **State Locking Rules (Back-end):**<br>❖ The system validates the auction state via `AuctionService.validateState(auctionId)`.<br>❖ If the input is not valid:<br>⮚ If the [status] is already 'success' or 'failed', the system returns a 400 Bad Request (Already Finalized).<br>⮚ If the current time is before [auctionEndAt], the system returns a 400 Bad Request (Not Ended).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **(6)**      | **BR-05** | **Calculation Rules (Back-end):**<br>❖ The system determines the final outcome via `FinalizationService.determineOutcome()`.<br>❖ If the `HighestBid` is greater than or equal to the `ReservePrice`, the status is set to 'success'.<br>❖ Otherwise, the status is set to 'failed'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(9)-(10)** | **BR-06** | **Storing Rules (Back-end):**<br>❖ The system updates the “AUCTION” table by calling `AuctionRepository.update()`.<br>❖ It records the final [status], [finalSalePrice], and [commissionFee].<br>❖ It sets the `finalizedAt` timestamp to the current time.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **(11)**     | **BR-07** | **Audit Rules (Back-end):**<br>❖ The system creates an audit record via `AuditLogRepository.create()`.<br>❖ It inserts a new entry into “AUCTION_AUDIT_LOG” with [action] set to 'AUCTION_FINALIZED' and [adminId] set to the current user's ID.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(15)**     | **BR-08** | **Displaying Rules (Success):**<br>❖ The system refreshes the page via `Refresh_Page('FinalizationPage')`.<br>❖ It displays **MSG 7** ("Auction finalized") to confirm the action.<br>❖ The Status Badge is updated to reflect the final outcome (Success or Failed).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
