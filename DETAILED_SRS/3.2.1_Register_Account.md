# 3.2.1 Register Account

## 1. Use Case Description

| Field              | Description                                                                                                                                |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Register Account                                                                                                                           |
| **Description**    | This use case allows the Guest to create a new Account in the authentication provider and corresponding User record in the local database. |
| **Actor**          | Guest                                                                                                                                      |
| **Trigger**        | When the Guest clicks on the 'Sign Up' button on the RegistrationPage.                                                                     |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the RegistrationPage.                                                 |
| **Post-condition** | The Account is stored in Supabase Auth, the User record is stored in the local database, and a verification email is sent to the Guest.    |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "RegistrationPage" as View
control "AuthController" as Controller
control "AuthService" as Service
entity "SupabaseService" as Supabase
database "UserRepository" as Repo

User -> View: Fill Registration Form\n(email, password, phone, userType, taxId, etc.)
View -> View: Validate Password Strength & Required Fields
View -> Controller: POST /auth/register\n{ email, password, phone, userType, taxId, ... }
activate Controller

Controller -> Service: register(RegisterDto)
activate Service

Service -> Service: Validate DTO & Business Rules
note right: Check taxId for business users (BR-02)

alt Validation Failed
    Service --> Controller: Throw BadRequestException
    Controller --> View: 400 Bad Request
    View --> User: Display Validation Error
else Validation Success
    Service -> Supabase: signUp({ email, password })
    activate Supabase

    alt Email Already Exists
        Supabase --> Service: Error (User already registered)
        Service --> Controller: Throw ConflictException
        Controller --> View: 409 Conflict
        View --> User: Show "Email Already Registered" Error
    else Supabase Success
        Supabase --> Service: AuthResponse (User UID)
        deactivate Supabase

        Service -> Repo: create(uid, email, role='bidder', status='UNVERIFIED', ...)
        activate Repo

        alt DB Creation Success
            Repo --> Service: UserEntity
            deactivate Repo
            Service --> Controller: RegistrationSuccessResponse
            Controller --> View: 201 Created
            View --> User: Show "Check Your Email" Confirmation
        else DB Creation Failed
            Repo --> Service: Error
            deactivate Repo
            Service -> Supabase: deleteUser(uid)
            activate Supabase
            note right: Rollback Supabase account
            Supabase --> Service: Deletion Confirmed
            deactivate Supabase
            Service --> Controller: Throw InternalServerErrorException
            Controller --> View: 500 Internal Server Error
            View --> User: Display System Error
        end
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Fill Registration Form;
:(2) Submit Registration Request;

|AuthService|
:(3) Validate Input Data;
note right: BR-01, BR-02

if (Validation Passed?) then (No)
    :(4.1) Return Validation Error;
    |Guest|
    :(4.2) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(5) Request Account Creation to Supabase;
endif

|SupabaseService|
:(6) Check Email Uniqueness;
:(7) Hash & Store Password;
:(8) Generate User UID;

if (Auth Created?) then (No)
    |AuthService|
    :(9.1) Return Auth Error;
    |Guest|
    :(9.2) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(10) Receive Supabase UID;
    :(11) Prepare Local User Data;
    note right: Set role='bidder', status='UNVERIFIED'
endif

|UserRepository|
:(12) Insert User Record;

if (Insert Success?) then (No)
    |AuthService|
    :(13.1) Rollback Supabase Account;
    :(13.2) Return System Error;
    |Guest|
    :(13.3) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(14) Trigger Verification Email;
    :(15) Return Success Response;
endif

|Guest|
:(16) Receive Confirmation;
:(17) Check Email for Verification;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rules:**<br>❖ The system displays a “RegistrationPage” screen. (Refer to “RegistrationPage” view in “View Description” file).<br>❖ The screen renders input fields for: [email], [password], [confirmPassword], [phone], [userType], and [taxId].                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **(1)**  | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the user enters information, the system uses the `ValidateInput(RegisterDto)` method to check validity.<br>❖ If the input is not valid:<br>⮚ If [email] or [password] is empty, the system displays **MSG 1** (Mandatory Field).<br>⮚ If the [password] does not meet complexity requirements, the system displays **MSG 4** (Weak Password).<br>⮚ If [userType] is “business” and [taxId] is empty, the system displays **MSG 1**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **(2)**  | **BR-03** | **Validation Rules (Back-end):**<br>❖ When the user clicks the “Sign Up” button, the system calls `AuthService.register()` to submit the data.<br>❖ The system attempts to create the account in `Supabase.signUp(email, password)`.<br>❖ If the input is not valid:<br>⮚ If the [email] already exists in Supabase, the system returns a 409 Conflict and displays **MSG 2** (Email already registered).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(12)** | **BR-04** | **Storing Rules (Back-end):**<br>❖ If Supabase account creation is successful, the system inserts a new record into the “USERS” table.<br>❖ It sets the [role] field to 'bidder' and [status] to 'UNVERIFIED'.<br>❖ If the database insertion fails, the system initiates a rollback by calling `deleteUser()` on Supabase to remove the partially created account.<br>❖ The system then returns a 500 Internal Error and displays **MSG 9** (System Error) to the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(14)** | **BR-05** | **Notification Rules:**<br>❖ Upon successful user registration, the system triggers the sending of a verification email via `Supabase.sendVerificationEmail()` method.<br>❖ This email contains a unique verification link that is valid for 24 hours.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(16)** | **BR-06** | **Displaying Rules (Success Confirmation):**<br>❖ The system displays a “RegistrationSuccessPage” screen to the user. (Refer to “RegistrationSuccessPage” view in “View Description” file).<br>❖ The screen shows a confirmation message: "Account created. Please check your email to activate."<br>❖ The system does not automatically log in the user at this stage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
