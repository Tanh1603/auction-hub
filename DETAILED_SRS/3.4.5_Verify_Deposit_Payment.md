# 3.4.5 Verify Deposit Payment

## 1. Use Case Description

| Field              | Description                                                                                                                    |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Verify Deposit Payment                                                                                                         |
| **Description**    | This use case allows the Bidder to update existing Deposit Payment information in the system.                                  |
| **Actor**          | Bidder                                                                                                                         |
| **Trigger**        | When the Bidder is redirected back from Stripe to the PaymentVerificationPage.                                                 |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.                              |
| **Post-condition** | The Deposit Payment information will be updated in the system and display verified status on PaymentVerificationPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "PaymentVerificationPage" as View
control "RegistrationController" as Controller
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "PaymentRepository" as PaymentRepo
control "RegistrationService" as RegService
entity "ParticipantRepository" as ParticipantRepo

User -> View: Completes Payment on Stripe
View -> View: Redirected back to App (with session_id)
View -> Controller: POST /register-to-bid/verify-deposit-payment\n{ sessionId }
activate Controller

Controller -> PayService: verifyDeposit(sessionId, userId)
activate PayService

PayService -> PaymentRepo: findPaymentBySessionId(sessionId)
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity (status: pending)
deactivate PaymentRepo

alt Payment Record Not Found or Already Completed
    PayService --> Controller: Throw BadRequestException/ConflictException
    Controller --> View: 400/409 Error
    View --> User: Display Error Message
else Pending Payment Found
    PayService -> Stripe: retrieveCheckoutSession(sessionId)
    activate Stripe
    Stripe --> PayService: Session Object (status: 'complete')
    deactivate Stripe

    alt Stripe Session Not Complete
        PayService --> Controller: Throw BadRequestException
        Controller --> View: 400 Error (Payment not complete)
        View --> User: Display Error Message
    else Stripe Session Complete
        PayService -> PaymentRepo: updateStatus(paymentId, 'completed')
        activate PaymentRepo
        PaymentRepo --> PayService: UpdatedPayment
        deactivate PaymentRepo

        PayService -> RegService: markDepositPaid(payment.auctionId, payment.userId)
        activate RegService
        RegService -> ParticipantRepo: updateParticipant({ depositPaidAt: now(), status: 'FINAL_APPROVED' })
        activate ParticipantRepo
        ParticipantRepo --> RegService: UpdatedParticipant
        deactivate ParticipantRepo
        RegService --> PayService: Success
        deactivate RegService

        PayService --> Controller: SuccessResponse
        Controller --> View: 200 OK (Payment Verified)
        View --> User: Receive Payment Confirmation
    end
end

deactivate PayService
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Bidder|
start
:(1) Complete Payment on Stripe;
:(2) Browser Redirects to Application;

|PaymentService|
:(3) Receive Verification Request (sessionId);

|PaymentRepository|
:(4) Retrieve Payment Record by sessionId;

|PaymentService|
if (Payment Record Not Found or Already Completed?) then (Yes)
    :(5.1) Return 400/409 Error;
    |Bidder|
    :(5.2) View Error Message;
    stop
endif

|StripeService|
:(6) Query Stripe for Session Status;

|PaymentService|
if (Stripe Session Status == 'complete'?) then (No)
    :(7.1) Return 400 Error\n(Payment still pending);
    |Bidder|
    :(7.2) View Error Message;
    stop
else (Yes)
    |PaymentRepository|
    :(8) Update Payment Record Status to 'completed';
    note right: BR-02
    |RegistrationService|
    :(9) Update AuctionParticipant:\n  - Set depositPaidAt\n  - Set status to FINAL_APPROVED;
    note right: BR-02
endif

|PaymentService|
:(10) Return Success Confirmation;

|Bidder|
:(11) Receive Payment Confirmation;
:(12) View Registration Status as Approved;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :------------ | :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(2)**       | **BR-01** | **Displaying Rule (Payment Verification Page):**<br>When user is redirected back from Stripe, system displays `PaymentVerificationPage`.<br>System shows loading indicator while verification is in progress.                                                                                                                                                                                                                                                                                                               |
| **(3)-(6)**   | **BR-02** | **Validation Rule (Back-end Verification):**<br>System retrieves data from the 'PAYMENT' table in the database (Refer to 'PAYMENT' table in 'DB Sheet' file) based on the session ID.<br>If payment record not found or already `completed`:<br>$\rightarrow$ System displays MSG 9 ("Payment verification failed") on the View.<br>System queries Stripe API to confirm payment status is `complete`.<br>If Stripe session not complete:<br>$\rightarrow$ System displays MSG 9 ("Payment not yet confirmed") on the View. |
| **(6)**       | **BR-03** | **Validation Rule (Amount Matching):**<br>System verifies `amount_total` from Stripe matches `depositAmountRequired` in `AUCTION` table.<br>If mismatch:<br>$\rightarrow$ System displays MSG 9 ("Payment amount mismatch") and flags for admin review.                                                                                                                                                                                                                                                                     |
| **(8), (9)**  | **BR-04** | **Storing Rule:**<br>On successful verification, system saves to `PAYMENT` table: `status = 'completed'`.<br>System saves to `AUCTION_PARTICIPANT` table: `depositPaidAt = now()`, `status = 'FINAL_APPROVED'`.                                                                                                                                                                                                                                                                                                             |
| **(10)-(12)** | **BR-05** | **Displaying Rule (Success Confirmation):**<br>System displays MSG 7 ("Deposit payment verified successfully") on the View.<br>System displays updated registration status showing `FINAL_APPROVED`.<br>User can now proceed to auction check-in.                                                                                                                                                                                                                                                                           |

```

```
