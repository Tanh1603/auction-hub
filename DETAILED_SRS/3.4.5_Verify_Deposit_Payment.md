# 3.4.5 Verify Deposit Payment

## 1. Use Case Description

| Field              | Description                                                                                                                    |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Verify Deposit Payment                                                                                                         |
| **Description**    | This use case allows the Bidder to update existing Deposit Payment information in the system.                                  |
| **Actor**          | Bidder                                                                                                                         |
| **Trigger**        | When the Bidder is redirected back from Stripe to the PaymentVerificationPage.                                                 |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.                              |
| **Post-condition** | The Deposit Payment information will be updated in the system and display verified status on PaymentVerificationPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "PaymentVerificationPage" as View
control "RegistrationController" as Controller
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "PaymentRepository" as PaymentRepo
control "RegistrationService" as RegService
entity "ParticipantRepository" as ParticipantRepo

User -> View: Completes Payment on Stripe
View -> View: Redirected back to App (with session_id)
View -> Controller: POST /register-to-bid/verify-deposit-payment\n{ sessionId }
activate Controller

Controller -> PayService: verifyDeposit(sessionId, userId)
activate PayService

PayService -> PaymentRepo: findPaymentBySessionId(sessionId)
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity (status: pending)
deactivate PaymentRepo

alt Payment Record Not Found or Already Completed
    PayService --> Controller: Throw BadRequestException/ConflictException
    Controller --> View: 400/409 Error
    View --> User: Display Error Message
else Pending Payment Found
    PayService -> Stripe: retrieveCheckoutSession(sessionId)
    activate Stripe
    Stripe --> PayService: Session Object (status: 'complete')
    deactivate Stripe

    alt Stripe Session Not Complete
        PayService --> Controller: Throw BadRequestException
        Controller --> View: 400 Error (Payment not complete)
        View --> User: Display Error Message
    else Stripe Session Complete
        PayService -> PaymentRepo: updateStatus(paymentId, 'completed')
        activate PaymentRepo
        PaymentRepo --> PayService: UpdatedPayment
        deactivate PaymentRepo

        PayService -> RegService: markDepositPaid(payment.auctionId, payment.userId)
        activate RegService
        RegService -> ParticipantRepo: updateParticipant({ depositPaidAt: now(), status: 'FINAL_APPROVED' })
        activate ParticipantRepo
        ParticipantRepo --> RegService: UpdatedParticipant
        deactivate ParticipantRepo
        RegService --> PayService: Success
        deactivate RegService

        PayService --> Controller: SuccessResponse
        Controller --> View: 200 OK (Payment Verified)
        View --> User: Receive Payment Confirmation
    end
end

deactivate PayService
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Bidder|
start
:(1) Complete Payment on Stripe;
:(2) Browser Redirects to Application;

|PaymentService|
:(3) Receive Verification Request (sessionId);

|PaymentRepository|
:(4) Retrieve Payment Record by sessionId;

|PaymentService|
if (Payment Record Not Found or Already Completed?) then (Yes)
    :(5.1) Return 400/409 Error;
    |Bidder|
    :(5.2) View Error Message;
    stop
endif

|StripeService|
:(6) Query Stripe for Session Status;

|PaymentService|
if (Stripe Session Status == 'complete'?) then (No)
    :(7.1) Return 400 Error\n(Payment still pending);
    |Bidder|
    :(7.2) View Error Message;
    stop
else (Yes)
    |PaymentRepository|
    :(8) Update Payment Record Status to 'completed';
    note right: BR-02
    |RegistrationService|
    :(9) Update AuctionParticipant:\n  - Set depositPaidAt\n  - Set status to FINAL_APPROVED;
    note right: BR-02
endif

|PaymentService|
:(10) Return Success Confirmation;

|Bidder|
:(11) Receive Payment Confirmation;
:(12) View Registration Status as Approved;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(2)**       | **BR-01** | **Displaying Rules:**<br>❖ The system renders a “PaymentVerificationPage” via `Display_View()` upon return from the payment gateway.<br>❖ It displays a loading indicator and a message: "Verifying your payment...".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **(3)**       | **BR-02** | **Verification Rules (Back-end):**<br>❖ The system calls `PaymentService.verifyDeposit(sessionId, userId)` to verify the transaction.<br>❖ It retrieves the `PAYMENT` record using the [sessionId].<br>❖ If the input is not valid:<br>⮚ If the record is not found or the [status] is not 'pending', the system returns a 400 Bad Request.<br>⮚ It then queries Stripe to confirm the session status.<br>⮚ If the Stripe status is not 'complete', the system returns a 400 error (Payment not complete).                                                                                                                                                                                                                                                                                                                                                                  |
| **(6)**       | **BR-03** | **Financial Rules (Back-end):**<br>❖ The system performs a financial check via `PaymentService.verifyDeposit()`.<br>❖ It compares `Stripe.amount_total` with `Auction.depositAmountRequired`.<br>❖ If there is a mismatch, the system logs a warning for admin review and returns a 400 Bad Request error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **(8), (9)**  | **BR-04** | **Storing Rules (Back-end):**<br>❖ Upon successful verification, the system calls `PaymentService.verifyDeposit()` to update the database.<br>❖ It updates the `PAYMENT` table, setting the [status] to 'completed'.<br>❖ It also updates the “AUCTION_PARTICIPANT” table, setting the [depositPaidAt] timestamp to now and the [status] to 'FINAL_APPROVED'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **(11)-(12)** | **BR-05** | **Displaying Rules (Success):**<br>❖ The system redirects the user to the Registration Details Page via `Redirect('RegistrationDetailsPage', { success: true })`.<br>❖ It displays **MSG 7** ("Deposit payment verified successfully.") to the user.<br>❖ The registration [status] is updated to show 'FINAL_APPROVED'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
