# 3.3.6 Update Auction Relations

## 1. Use Case Description

| Field              | Description                                                                                                                                |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **Name**           | Update Auction Relations                                                                                                                   |
| **Description**    | This use case allows the Auctioneer/Admin to update related auctions for a specific auction.                                               |
| **Actor**          | Auctioneer, Admin                                                                                                                          |
| **Trigger**        | When the Auctioneer/Admin submits related auction updates via `PATCH /auctions/:id/relations`.                                             |
| **Pre-condition**  | • Auctioneer/Admin's device must be connected to the internet.<br>• Auctioneer/Admin is signed in with their account.<br>• Auction exists. |
| **Post-condition** | The auction's relations are updated in the database.                                                                                       |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Auctioneer/Admin" as User
boundary "EditAuctionPage" as View
control "AuctionController" as Controller
control "AuctionService" as Service
entity "AuctionRelationRepository" as RelationRepo

User -> View: Select Related Auctions
View -> Controller: PATCH /auctions/:id/relations\n{ relatedIds: [] }
activate Controller

Controller -> Service: updateRelations(id, relatedIds)
activate Service

Service -> Service: Validate Auction Exists
Service -> RelationRepo: deleteByAuctionId(id)
activate RelationRepo
RelationRepo --> Service: Deleted
deactivate RelationRepo

Service -> RelationRepo: createMany(relations)
activate RelationRepo
RelationRepo --> Service: NewRelations
deactivate RelationRepo

Service --> Controller: AuctionDto
Controller --> View: 200 OK (Updated)
View --> User: Show Success Message

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Auctioneer/Admin|
start
:(1) Open Related Auctions Section;
:(2) Select/Deselect Related Auctions;
:(3) Submit Relations;

|AuctionController|
:(4) Authenticate & Authorize;
note right: BR-01

|AuctionService|
:(5) Verify Auction Exists;

if (Auction Found?) then (No)
    :(6.1) Return 404 Not Found;
    |Auctioneer/Admin|
    :(6.2) View Error Message;
    stop
endif

|AuctionRelationRepository|
:(7) Delete Existing Relations;
note right: BR-02

:(8) Create New Relations;
note right: BR-03

|AuctionService|
:(9) Return Success Response;

|Admin|
:(10) View Updated Relations;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**  | **BR-01** | **Displaying Rules (Relations Section):**<br>❖ The system renders a “UpdateRelationsModal” via `Display_Modal()` to allow editing of related auctions.<br>❖ It displays a multi-select list of all auctions (excluding the current one).<br>❖ Any currently related auctions are pre-selected in the list.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **(4)**  | **BR-02** | **Authorization Rules (Back-end):**<br>❖ The system checks the authenticated user's role via `AuctionService.updateRelations()` to ensure they have the necessary permissions.<br>❖ If the input is not valid:<br>⮚ If the user's role is not 'auctioneer', 'admin', or 'super_admin', the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(7)**  | **BR-03** | **Processing Rules (Replace Strategy):**<br>❖ The system employs a “replace strategy” for managing auction relations.<br>❖ It first deletes all existing records from the “AUCTION_RELATION” table associated with the `auctionId` by calling `AuctionRelationRepository.deleteByAuctionId(id)`.<br>❖ Then, it proceeds to create new relation entries based on the provided list of related auction IDs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **(8)**  | **BR-04** | **Storing Rules (Back-end):**<br>❖ For each [relatedId] in the submitted list, the system inserts a new record into the “AUCTION_RELATION” table.<br>❖ It specifies the `auctionId` (current auction) and `relatedAuctionId`.<br>❖ The system supports bidirectional linking for related auctions.<br>❖ System moves to step (10) and displays successful notification (Refer to **MSG 7**).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(10)** | **BR-05** | **Displaying Rules (Success Confirmation):**<br>❖ The system refreshes the related auctions section on the page by calling `Refresh_Component('RelatedAuctions')`.<br>❖ A success toast notification confirms that the relations have been updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |