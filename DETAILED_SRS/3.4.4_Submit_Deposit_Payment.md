# 3.4.4 Submit Deposit Payment

## 1. Use Case Description

| Field              | Description                                                                                                       |
| ------------------ | ----------------------------------------------------------------------------------------------------------------- |
| **Name**           | Submit Deposit Payment                                                                                            |
| **Description**    | This use case allows the Bidder to create a new Deposit Payment information in the system.                        |
| **Actor**          | Bidder                                                                                                            |
| **Trigger**        | When the Bidder clicks on the 'Pay Deposit' button on the DepositPaymentPage.                                     |
| **Pre-condition**  | • Bidder's device must be connected to the internet.<br>• Bidder is signed in with their account.                 |
| **Post-condition** | The Deposit Payment information will be stored into the system and display payment session on DepositPaymentPage. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Bidder" as User
boundary "DepositPaymentPage" as View
control "RegistrationController" as Controller
control "RegistrationService" as RegService
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "ParticipantRepository" as ParticipantRepo
entity "AuctionRepository" as AuctionRepo
entity "PaymentRepository" as PaymentRepo

User -> View: Click "Pay Deposit"
View -> Controller: POST /register-to-bid/submit-deposit\n{ auctionId }
activate Controller

Controller -> RegService: initiateDeposit(auctionId, userId)
activate RegService

RegService -> ParticipantRepo: findParticipant(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> RegService: Participant (Status: DOCS_VERIFIED)
deactivate ParticipantRepo

RegService -> RegService: Validate Status & Deadline
note right: BR-01, BR-02

alt Validation Failed
    RegService --> Controller: Throw Forbidden/BadRequest
    Controller --> View: Error
    View --> User: Display Error Message
else Validation Success
    RegService -> PayService: createPaymentSession(user, auction, 'deposit')
    activate PayService

    PayService -> Stripe: sessions.create({ amount, currency, ... })
    activate Stripe
    Stripe --> PayService: Session Object (url, id)
    deactivate Stripe

    PayService -> PaymentRepo: create({ status: 'pending', sessionId... })
    activate PaymentRepo
    PaymentRepo --> PayService: PaymentEntity
    deactivate PaymentRepo

    PayService --> RegService: PaymentUrl
    deactivate PayService

    RegService --> Controller: { url: string }
    Controller --> View: 200 OK (Redirect JSON)
    View --> User: Redirect to Stripe Checkout
end

deactivate RegService
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Bidder|
start
:(1) Request Deposit Payment;

|RegistrationService|
:(2) Retrieve Registration Status;

|ParticipantRepository|
:(3) Query Participant;

|RegistrationService|
if (Status == DOCUMENTS_VERIFIED?) then (No)
    :(4.1) Return 403 Forbidden\n(Docs not verified yet);
    note right: BR-01
    |Bidder|
    :(4.2) View Error Message;
    stop
endif

|AuctionRepository|
:(5) Check Deposit Deadline;
note right: BR-02

|RegistrationService|
if (Current Time > depositEndAt?) then (Yes)
    :(6.1) Return 400 Bad Request\n(Deposit period ended);
    |Bidder|
    :(6.2) View Error Message;
    stop
endif

|RegistrationService|
:(7) Calculate Deposit Amount;
note right: BR-03
:(8) Initiate Payment Session;

|StripeService|
:(9) Create Session;
:(10) Return Session URL;

|PaymentRepository|
:(11) Record Pending Payment in DB;

|RegistrationService|
:(12) Return URL to Client;

|Bidder|
:(13) Browser Redirects to Payment Page;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                |
| :------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rule:**<br><br>Function: `Display_View('DepositPaymentPage', auction, participant)`<br><br>Logic:<br>Render [Auction Details].<br>Render required [depositAmount].<br>Render [Pay Deposit] button (enabled/disabled by status/deadline).                                                                           |
| **(1)**  | **BR-02** | **Validation Rule (Front-end):**<br><br>Function: `ValidateDepositEligibility()`<br><br>Logic:<br>IF [Participant.status] != 'DOCUMENTS_VERIFIED' THEN<br>  Disable [Pay Deposit] button<br>  Display MSG 21 (Documents not verified).<br>ELSE IF NOW > [Auction.depositEndAt] THEN<br>  Disable [Pay Deposit] button<br>  Display MSG 15 (Deposit period ended).<br>END IF | 
| **(1)**  | **BR-03** | **Idempotency Rule (Back-end):**<br><br>Function: Call `RegistrationService.initiateDeposit()`<br><br>Logic:<br>Check for existing `PAYMENT` record for this (auctionId, userId, type='deposit', status='pending').<br>IF Exists THEN Return existing Stripe Session URL.<br>END IF                                          |
| **(11)** | **BR-04** | **Storing Rule (Back-end):**<br><br>Function: Call `PaymentService.createPaymentSession()`<br><br>Logic:<br>Insert into `PAYMENT` table ([status]='pending', [type]='deposit', [sessionId]).<br>Return Stripe Session URL.                                                                                                    |
| **(13)** | **BR-05** | **Displaying Rule (Redirect):**<br><br>Function: `Redirect_External(stripeSessionUrl)`<br><br>Logic:<br>Redirect user browser to Stripe Checkout Page.                                                                                                                                                                      |