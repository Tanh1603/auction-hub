# 3.9.3 Update System Variable

## 1. Use Case Description

| Field              | Description                                                                                                                                         |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Update System Variable                                                                                                                              |
| **Description**    | This use case allows the Admin to update an existing system configuration variable value.                                                           |
| **Actor**          | Admin, Super Admin                                                                                                                                  |
| **Trigger**        | When the Admin submits an updated value via `PATCH /system-variables/:category/:key`.                                                               |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with `admin` or `super_admin` role.<br>• Variable exists in the system. |
| **Post-condition** | The system configuration variable is updated and cache is cleared.                                                                                  |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "SystemConfigPage" as View
control "SystemVariablesController" as Controller
control "SystemVariablesService" as Service
entity "SystemVariableRepository" as Repo

User -> View: Update Variable Value
View -> Controller: PATCH /system-variables/:category/:key\n{ value }
activate Controller

Controller -> Service: update(category, key, value, userId)
activate Service

Service -> Repo: findByKey(category, key)
activate Repo
Repo --> Service: SystemVariable
deactivate Repo

alt Variable Found
    Service -> Repo: update({ value, updatedBy })
    activate Repo
    Repo --> Service: UpdatedVariable
    deactivate Repo

    Service -> Service: clearCache()
    note right: BR-03

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Variable Updated)
    View --> User: Show Success Message
else Variable Not Found
    Service --> Controller: Throw NotFoundException
    Controller --> View: 404 Not Found
    View --> User: Display Error Message
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin|
start
:(1) Input New Variable Value;
:(2) Submit Update Request;

|SystemVariablesController|
:(3) Authenticate & Authorize;
note right: BR-01

|SystemVariablesService|
:(4) Validate Value Type;
note right: BR-02

if (Valid Value?) then (No)
    :(5.1) Return 400 Bad Request;
    |Admin|
    :(5.2) View Error Message;
    stop
endif

|SystemVariableRepository|
:(6) Update Variable Record;

|SystemVariablesService|
:(7) Clear Cache;
note right: BR-03

:(8) Return Success Response;

|Admin|
:(9) View Updated Value;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                      |
| :------- | :-------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rule:**<br><br>Function: `Display_View('EditSystemVariablePage')`<br><br>Logic:<br>Render input field for [Value] (type-specific: text, checkbox, number).<br>Display current [Value], [DataType]. |
| **(3)**  | **BR-02** | **Authorization Rule (Back-end):**<br><br>Function: Call `SystemVariablesService.update()`<br><br>Logic:<br>Check Requestor Role.<br>IF Role NOT IN ['admin', 'super_admin'] THEN Return 403 (Forbidden).            |
| **(4)**  | **BR-03** | **Validation Rule (Back-end):**<br><br>Function: `SystemVariablesService.validateValue(value, dataType)`<br><br>Logic:<br>Validate input [value] against [dataType].<br>IF Type Mismatch THEN Return 400 (Invalid format). |
| **(6)**  | **BR-04** | **Storing Rule (Back-end):**<br><br>Function: `SystemVariableRepository.update()`<br><br>Logic:<br>Update `SYSTEM_VARIABLE` SET [value]=newValue, [updatedBy]=UserId, [updatedAt]=NOW().<br>Display MSG 7 (Success). |
| **(7)**  | **BR-05** | **Processing Rule (Cache):**<br><br>Function: `CacheService.clear()`<br><br>Logic:<br>Invalidate relevant cache entries (e.g., specific variable or entire cache).                                                  |
| **(9)**  | **BR-06** | **Displaying Rule (Success):**<br><br>Function: `Refresh_View('SystemVariableDetailsPage')`<br><br>Logic:<br>Update displayed value.<br>Show success notification.                                                  |
