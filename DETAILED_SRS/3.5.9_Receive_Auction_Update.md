# 3.5.9 Receive Auction Update

## 1. Use Case Description

| Field              | Description                                                                                                                                                                                                                                                                                                                      |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Receive Auction Update                                                                                                                                                                                                                                                                                                           |
| **Description**    | This use case allows the System to broadcast auction updates to subscribed clients in the system. This event encompasses changes beyond new bids or time updates, such as status transitions (e.g., `scheduled` to `live`), manual extensions of `auctionEndAt`, or administrative adjustments to other core auction properties. |
| **Actor**          | Bidder (and any other subscribed user, e.g., Guest, Auctioneer)                                                                                                                                                                                                                                                                  |
| **Trigger**        | When the AuctionService modifies auction data (e.g., status, end time) and emits an `auctionUpdate` event via WebSocket.                                                                                                                                                                                                         |
| **Pre-condition**  | • Client's device must be connected to the internet.<br>• Client has an active WebSocket connection and is subscribed to the specific auction's WebSocket room.                                                                                                                                                                  |
| **Post-condition** | The client receives a `WebSocket: auctionUpdate` event containing the updated auction details and the client's UI is updated to reflect the new state or properties of the auction.                                                                                                                                              |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
control "AuctionService" as Service
control "WebSocketGateway" as WSGateway
boundary "WebSocketClient" as WSClient
boundary "AuctionDetailPage" as View

Service -> Service: Auction data modified (e.g., status, end time)
Service -> WSGateway: emitAuctionUpdate(auctionId, updatedDetails)
activate WSGateway

WSGateway -> WSGateway: Broadcast `auctionUpdate` to room (auctionId)
note right: BR-01, BR-02

WSGateway --> WSClient: Emit `auctionUpdate` (AuctionUpdateDto)
WSClient -> View: Update UI elements
View --> User: Observe Auction Changes
deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|AuctionService|
start
:(1) Auction Data is Modified;
:(2) Determine Scope of Change;

|WebSocketGateway|
:(3) Prepare `auctionUpdate` Event Payload;
note right: BR-02

:(4) Broadcast `auctionUpdate` Event;
note right: BR-01

|User|
:(5) Receive `auctionUpdate` Event;
:(6) Parse Updated Data;
:(7) Identify Changed Properties;
:(8) Update Relevant UI Elements;
:(9) Observe Changes in Auction;
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                 |
| :---------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Processing Rule (Update Trigger):**<br>System detects significant auction change:<br>- Status transition (e.g., `scheduled` → `live`, `live` → `ended`)<br>- `auctionEndAt` modified (time extension)<br>- Administrative adjustments to core properties. |
| **(2)**     | **BR-02** | **Processing Rule (Scope Determination):**<br>System determines scope of change to include in payload.<br>Avoids redundant updates already covered by `newBid` or `timeUpdate` events.                                                                      |
| **(3)**     | **BR-03** | **Processing Rule (Payload Preparation):**<br>System prepares `auctionUpdate` event payload with:<br>- Changed fields or full current auction state<br>- New status value (if changed)<br>- Updated timestamps.                                             |
| **(4)**     | **BR-04** | **Processing Rule (Targeted Broadcast):**<br>System broadcasts `auctionUpdate` event to clients in auction-specific room only.<br>Ensures data relevance and efficient network usage.                                                                       |
| **(4)**     | **BR-05** | **Processing Rule (Real-Time Delivery):**<br>Critical `auctionUpdate` notifications delivered in near real-time.<br>Ensures participants always have current auction information.                                                                           |
| **(5)-(9)** | **BR-06** | **Displaying Rule (UI Update):**<br>Client receives `auctionUpdate` event via WebSocket.<br>Client identifies changed properties and updates relevant UI elements.<br>User observes changes: status badge, extended time, modified rules.                   |
