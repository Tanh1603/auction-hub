# 3.6.5 Get Audit Logs

## 1. Use Case Description

| Field              | Description                                                                                                                                                                                                               |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Get Audit Logs                                                                                                                                                                                                            |
| **Description**    | This use case allows the Admin to search for Audit Logs in the system. This includes status overrides, bid denials, registration approvals/rejections, and finalization events, ensuring accountability and traceability. |
| **Actor**          | Admin, Auctioneer                                                                                                                                                                                                         |
| **Trigger**        | When the Admin navigates to the "Audit Log" tab of an auction, triggering `GET /auction-finalization/audit-logs/:auctionId`.                                                                                              |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account and has `admin` or `auctioneer` role.                                                                                      |
| **Post-condition** | The Audit Logs information will be retrieved and displayed to the Admin in the system, sorted by timestamp (newest first).                                                                                                |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "AuditLogPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
entity "AuditLogRepository" as AuditLogRepo

User -> View: Request Audit Logs
View -> Controller: GET /auction-finalization/audit-logs/:auctionId
activate Controller

Controller -> Service: getAuditLogs(auctionId, userId)
activate Service

Service -> AuditLogRepo: findMany({ where: { auctionId }, orderBy: { createdAt: 'desc' }, include: { user } })
activate AuditLogRepo
AuditLogRepo --> Service: LogEntity[]
deactivate AuditLogRepo

Service --> Controller: AuditLogDto[]
deactivate Service

Controller --> View: 200 OK (JSON)
deactivate Controller

View --> User: Display Audit Timeline
@endumal
```

<h2>3. Activities Flow (Swimlanes)</h2>

```plantuml
@startuml
|Admin/Auctioneer|
start
:(1) Select Auction;
:(2) Open Audit Tab;

|FinalizationService|
:(3) Authenticate & Authorize;
note right: BR-01

|AuditLogRepository|
:(4) Query Audit Logs for Auction;
:(5) Include Actor Details (Name/Role);

|FinalizationService|
:(6) Format Response List;
:(7) Return Logs;

|Admin/Auctioneer|
:(8) Review Action History;
stop
@endumal
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :---------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)** | **BR-01** | **Displaying Rules:**<br>❖ The system renders an “AuditLogPage” via `Display_View()`.<br>❖ It displays a container for the timeline.<br>❖ A loading spinner is shown while the data is being fetched.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **(3)**     | **BR-02** | **Authorization Rules (Back-end):**<br>❖ The system calls `FinalizationService.getAuditLogs()` and checks the requestor's role.<br>❖ If the input is not valid:<br>⮚ If the user is not an 'admin' or 'auctioneer', the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **(4)-(5)** | **BR-03** | **Querying Rules:**<br>❖ The system executes `AuditLogRepository.findMany(query)` to retrieve the logs.<br>❖ It selects records from the “AUCTION_AUDIT_LOG” table where the [auctionId] matches.<br>❖ The query includes the related `User` to fetch Admin details.<br>❖ The results are ordered by [createdAt] in descending order.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(4)**     | **BR-04** | **Immutability Rules:**<br>❖ The database constraint ensures that Audit Logs are Append-Only.<br>❖ There are no update or delete endpoints exposed for this resource, ensuring the integrity of the audit trail.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(8)**     | **BR-05** | **Displaying Rules (Timeline):**<br>❖ The system renders the timeline using `Display_Timeline('AuditLogs', logs)`.<br>❖ It lists the events formatted as: "[Date] - [ActorName]: [Action] ([Reason])".<br>❖ Metadata, such as state transitions (OldStatus -> NewStatus), is also displayed for context.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
