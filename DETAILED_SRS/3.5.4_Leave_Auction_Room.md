# 3.5.4 Leave Auction Room

## 1. Use Case Description

| Field              | Description                                                                                      |
| ------------------ | ------------------------------------------------------------------------------------------------ |
| **Name**           | Leave Auction Room                                                                               |
| **Description**    | This use case allows the User to delete a WebSocket Connection information in the system.        |
| **Actor**          | User                                                                                             |
| **Trigger**        | When the User navigates away from the AuctionDetailPage screen.                                  |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.    |
| **Post-condition** | The WebSocket Connection information will be removed from the system and stop receiving updates. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "AuctionDetailPage" as View
boundary "WebSocketClient" as WSClient
control "WebSocketGateway" as WSGateway

User -> View: Navigate Away from Auction
View -> WSClient: Trigger Cleanup
WSClient -> WSGateway: Emit `leaveAuction` (auctionId)
activate WSGateway

WSGateway -> WSGateway: Remove Client from Room (auctionId)
note right: BR-01

WSGateway --> WSClient: Acknowledge (Optional)
deactivate WSGateway
WSClient -> View: Stop Listening for Events
View --> User: Stop Receiving Updates

deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Navigate Away / Close Auction View;

|WebSocketClient|
:(2) Detect Navigation Event;
:(3) Emit "leaveAuction" Event;

|WebSocketGateway|
:(4) Receive "leaveAuction" Event;
:(5) Identify Client Socket;
:(6) Identify Target Room (Auction ID);

:(7) Unsubscribe Client from Room;
note right: BR-01

|WebSocketClient|
:(8) Stop Listening for Auction Events;

|User|
:(9) Stop Receiving Updates;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                 |
| :---------- | :-------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Displaying Rule (Navigation Away):**<br>When user navigates away from auction page, system triggers cleanup.<br>System prepares to emit `leaveAuction` WebSocket event.                                                                                   |
| **(2)-(3)** | **BR-02** | **Processing Rule (Emit Leave Event - Front-end):**<br>System emits `leaveAuction` event with `auctionId` parameter.<br>Client stops listening for auction-specific WebSocket events.                                                                       |
| **(7)**     | **BR-03** | **Processing Rule (Unsubscribe from Room - Back-end):**<br>System receives `leaveAuction` event.<br>System unsubscribes client socket from auction-specific room.<br>Client stops receiving `newBid`, `timeUpdate`, `auctionState` events for this auction. |
| **(7)**     | **BR-04** | **Processing Rule (Automatic Cleanup):**<br>If client disconnects abruptly (browser crash, network loss):<br>$\rightarrow$ System automatically removes client from all joined rooms.<br>System optimizes resources by cleaning up orphaned connections.    |
| **(9)**     | **BR-05** | **Displaying Rule (Stop Updates):**<br>User no longer receives real-time auction updates on the View.<br>If user returns to auction page, they must rejoin the room (3.5.3).                                                                                |
