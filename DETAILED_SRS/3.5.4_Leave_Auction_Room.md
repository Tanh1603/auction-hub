# 3.5.4 Leave Auction Room

## 1. Use Case Description

| Field              | Description                                                                                      |
| ------------------ | ------------------------------------------------------------------------------------------------ |
| **Name**           | Leave Auction Room                                                                               |
| **Description**    | This use case allows the User to delete a WebSocket Connection information in the system.        |
| **Actor**          | User                                                                                             |
| **Trigger**        | When the User navigates away from the AuctionDetailPage screen.                                  |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.    |
| **Post-condition** | The WebSocket Connection information will be removed from the system and stop receiving updates. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "AuctionDetailPage" as View
boundary "WebSocketClient" as WSClient
control "WebSocketGateway" as WSGateway

User -> View: Navigate Away from Auction
View -> WSClient: Trigger Cleanup
WSClient -> WSGateway: Emit `leaveAuction` (auctionId)
activate WSGateway

WSGateway -> WSGateway: Remove Client from Room (auctionId)
note right: BR-01

WSGateway --> WSClient: Acknowledge (Optional)
deactivate WSGateway
WSClient -> View: Stop Listening for Events
View --> User: Stop Receiving Updates

deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Navigate Away / Close Auction View;

|WebSocketClient|
:(2) Detect Navigation Event;
:(3) Emit "leaveAuction" Event;

|WebSocketGateway|
:(4) Receive "leaveAuction" Event;
:(5) Identify Client Socket;
:(6) Identify Target Room (Auction ID);

:(7) Unsubscribe Client from Room;
note right: BR-01

|WebSocketClient|
:(8) Stop Listening for Auction Events;

|User|
:(9) Stop Receiving Updates;
stop
@enduml
```

## 4. Business Rules

| Activity    | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :---------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**     | **BR-01** | **Displaying Rules (Navigation Away):**<br>❖ When the user navigates away from the auction page, the system triggers a cleanup process.<br>❖ The system prepares to emit a `leaveAuction` WebSocket event.                                                                                                                                                                                                                                                        |
| **(2)-(3)** | **BR-02** | **Processing Rules (Front-end):**<br>❖ The client-side application detects the navigation event and emits a `leaveAuction` event with the `auctionId` parameter.<br>❖ The client then ceases to listen for auction-specific WebSocket events.                                                                                                                                                                                                                     |
| **(7)**     | **BR-03** | **Processing Rules (Back-end):**<br>❖ Upon receiving the `leaveAuction` event, the system invokes `WebSocketGateway.handleLeaveAuction(socket, auctionId)`.<br>❖ It unsubscribes the client socket from the specified `auctionId` room, ensuring the client no longer receives broadcasts for that auction.                                                                                                                                                           |
| **(7)**     | **BR-04** | **Processing Rules (Automatic Cleanup):**<br>❖ If a client disconnects abruptly (e.g., due to a browser crash or network loss), the system automatically removes the client from all joined rooms via `WebSocketGateway.onDisconnect()`.<br>❖ This optimizes server resources by cleaning up orphaned connections.                                                                                                                                              |
| **(9)**     | **BR-05** | **Displaying Rules (Stop Updates):**<br>❖ The user’s UI no longer receives real-time auction updates.<br>❖ If the user returns to the auction page, they must explicitly rejoin the room by triggering the `3.5.3` use case to resume receiving updates.                                                                                                                                                                                                               |
