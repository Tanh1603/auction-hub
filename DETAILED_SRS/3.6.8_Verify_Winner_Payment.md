# 3.6.8 Verify Winner Payment

## 1. Use Case Description

| Field              | Description                                                                                                                                                                                                                                              |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Verify Winner Payment                                                                                                                                                                                                                                    |
| **Description**    | This use case allows the System to update Payment status in the system. This involves checking the status with the payment gateway (Stripe) and, upon successful verification, updates the relevant payment records and marks the auction as fully paid. |
| **Actor**          | Winner, Admin                                                                                                                                                                                                                                            |
| **Trigger**        | When the Winner is redirected back from Stripe to the application (triggering a client-side call to `POST /auction-finalization/verify-winner-payment`) or a Stripe webhook notifies the backend.                                                        |
| **Pre-condition**  | • Winner's device must be connected to the internet.<br>• A `winning_payment` session was successfully initiated and Payment has been completed on Stripe.                                                                                               |
| **Post-condition** | The Payment record's status is updated to `completed` and the Winner is granted access to the asset transfer process in the system.                                                                                                                      |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Winner" as User
boundary "PaymentVerificationPage" as View
control "FinalizationController" as Controller
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "PaymentRepository" as PaymentRepo
entity "AuctionRepository" as AuctionRepo

User -> View: Completes Payment on Stripe
View -> View: Redirected back to App (with session_id)
View -> Controller: POST /auction-finalization/verify-winner-payment\n{ sessionId }
activate Controller

Controller -> PayService: verifyWinnerPayment(sessionId, userId)
activate PayService

PayService -> PaymentRepo: findPaymentBySessionId(sessionId)
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity (type: winning_payment, status: pending)
deactivate PaymentRepo

alt Payment Record Not Found or Already Completed
    PayService --> Controller: Throw BadRequestException/ConflictException
    Controller --> View: 400/409 Error
    View --> User: Display Error Message
else Pending Payment Found
    PayService -> Stripe: retrieveCheckoutSession(sessionId)
    activate Stripe
    Stripe --> PayService: Session Object (status: 'complete')
    deactivate Stripe

    alt Stripe Session Not Complete
        PayService --> Controller: Throw BadRequestException
        Controller --> View: 400 Error (Payment not complete)
        View --> User: Display Error Message
    else Stripe Session Complete
        PayService -> PaymentRepo: updatePaymentStatus(paymentId, 'completed')
        activate PaymentRepo
        PaymentRepo --> PayService: UpdatedPayment
        deactivate PaymentRepo

        PayService -> AuctionRepo: markAuctionAsPaid(auctionId)
        note right: Update other auction/contract fields
        activate AuctionRepo
        AuctionRepo --> PayService: UpdatedAuction
        deactivate AuctionRepo

        PayService --> Controller: SuccessResponse
        Controller --> View: 200 OK (Payment Verified)
        View --> User: Receive Payment Confirmation
    end
end

deactivate PayService
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Winner|
start
:(1) Complete Payment on Stripe;
:(2) Browser Redirects to Application;

|PaymentService|
:(3) Receive Verification Request (sessionId);

|PaymentRepository|
:(4) Retrieve Payment Record by sessionId;

|PaymentService|
if (Record Exists & Pending?) then (No)
    :(5.1) Return Error (e.g., Invalid session, Already processed);
    |Winner|
    :(5.2) View Error Message;
    stop
endif

|StripeService|
:(6) Query Stripe for Session Status;

|PaymentService|
if (Stripe Session Status == 'complete'?) then (No)
    :(7.1) Return 400 Error\n(Payment still pending);
    |Winner|
    :(7.2) View Error Message;
    stop
else (Yes)
    |PaymentRepository|
    :(8) Update Internal Payment Record Status to 'completed';
    note right: BR-02
    |AuctionRepository|
    :(9) Update Auction (e.g., set `paymentReceivedAt`);
    note right: BR-03
endif

|PaymentService|
:(10) Return Success Confirmation;

|Winner|
:(11) Receive Payment Confirmation;
:(12) Proceed to Asset Transfer Steps;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                            |
| :------------ | :-------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)**   | **BR-01** | **Displaying Rule (Payment Verification Page):**<br>When Winner is redirected back from Stripe, system displays `PaymentVerificationPage`.<br>System shows loading indicator while verifying payment.                                                                                                                                                                  |
| **(4)-(5.1)** | **BR-02** | **Validation Rule (Record Lookup - Back-end):**<br>System retrieves data from the 'PAYMENT' table in the database (Refer to 'PAYMENT' table in 'DB Sheet' file) based on the session ID to find payment record.<br>If record not found or already `completed`:<br>$\rightarrow$ System displays MSG 9 ("Payment verification failed") or returns success (idempotent). |
| **(6)**       | **BR-03** | **Validation Rule (Stripe Confirmation - Back-end):**<br>System queries Stripe API to confirm session status is `complete`.<br>If Stripe session not complete:<br>$\rightarrow$ System displays MSG 9 ("Payment not yet confirmed by gateway") on the View.                                                                                                            |
| **(6)**       | **BR-04** | **Validation Rule (Amount Matching - Back-end):**<br>System verifies `amount_total` from Stripe matches expected final payment amount.<br>If mismatch:<br>$\rightarrow$ System flags for manual intervention and logs discrepancy.                                                                                                                                     |
| **(8)**       | **BR-05** | **Storing Rule (Payment Status):**<br>System updates `PAYMENT` table:<br>- `status = 'completed'`<br>- `completedAt = now()`                                                                                                                                                                                                                                           |
| **(9)**       | **BR-06** | **Storing Rule (Auction Update):**<br>System updates `AUCTION` table:<br>- `paymentReceivedAt = now()`<br>Winner now eligible for asset transfer process.                                                                                                                                                                                                              |
| **(11)-(12)** | **BR-07** | **Displaying Rule (Success Confirmation):**<br>System displays MSG 7 ("Payment verified successfully") on the View.<br>System displays next steps for asset transfer/collection.<br>System shows payment receipt summary.                                                                                                                                              |

```

```
