# 3.6.8 Verify Winner Payment

## 1. Use Case Description

| Field              | Description                                                                                                                                                                                                                                              |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Verify Winner Payment                                                                                                                                                                                                                                    |
| **Description**    | This use case allows the System to update Payment status in the system. This involves checking the status with the payment gateway (Stripe) and, upon successful verification, updates the relevant payment records and marks the auction as fully paid. |
| **Actor**          | Winner, Admin                                                                                                                                                                                                                                            |
| **Trigger**        | When the Winner is redirected back from Stripe to the application (triggering a client-side call to `POST /auction-finalization/verify-winner-payment`) or a Stripe webhook notifies the backend.                                                        |
| **Pre-condition**  | • Winner's device must be connected to the internet.<br>• A `winning_payment` session was successfully initiated and Payment has been completed on Stripe.                                                                                               |
| **Post-condition** | The Payment record's status is updated to `completed` and the Winner is granted access to the asset transfer process in the system.                                                                                                                      |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Winner" as User
boundary "PaymentVerificationPage" as View
control "FinalizationController" as Controller
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "PaymentRepository" as PaymentRepo
entity "AuctionRepository" as AuctionRepo

User -> View: Completes Payment on Stripe
View -> View: Redirected back to App (with session_id)
View -> Controller: POST /auction-finalization/verify-winner-payment\n{ sessionId }
activate Controller

Controller -> PayService: verifyWinnerPayment(sessionId, userId)
activate PayService

PayService -> PaymentRepo: findPaymentBySessionId(sessionId)
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity (type: winning_payment, status: pending)
deactivate PaymentRepo

alt Payment Record Not Found or Already Completed
    PayService --> Controller: Throw BadRequestException/ConflictException
    Controller --> View: 400/409 Error
    View --> User: Display Error Message
else Pending Payment Found
    PayService -> Stripe: retrieveCheckoutSession(sessionId)
    activate Stripe
    Stripe --> PayService: Session Object (status: 'complete')
    deactivate Stripe

    alt Stripe Session Not Complete
        PayService --> Controller: Throw BadRequestException
        Controller --> View: 400 Error (Payment not complete)
        View --> User: Display Error Message
    else Stripe Session Complete
        PayService -> PaymentRepo: updatePaymentStatus(paymentId, 'completed')
        activate PaymentRepo
        PaymentRepo --> PayService: UpdatedPayment
        deactivate PaymentRepo

        PayService -> AuctionRepo: markAuctionAsPaid(auctionId)
        note right: Update other auction/contract fields
        activate AuctionRepo
        AuctionRepo --> PayService: UpdatedAuction
        deactivate AuctionRepo

        PayService --> Controller: SuccessResponse
        Controller --> View: 200 OK (Payment Verified)
        View --> User: Receive Payment Confirmation
    end
end

deactivate PayService
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Winner|
start
:(1) Complete Payment on Stripe;
:(2) Browser Redirects to Application;

|PaymentService|
:(3) Receive Verification Request (sessionId);

|PaymentRepository|
:(4) Retrieve Payment Record by sessionId;

|PaymentService|
if (Record Exists & Pending?) then (No)
    :(5.1) Return Error (e.g., Invalid session, Already processed);
    |Winner|
    :(5.2) View Error Message;
    stop
endif

|StripeService|
:(6) Query Stripe for Session Status;

|PaymentService|
if (Stripe Session Status == 'complete'?) then (No)
    :(7.1) Return 400 Error\n(Payment still pending);
    |Winner|
    :(7.2) View Error Message;
    stop
else (Yes)
    |PaymentRepository|
    :(8) Update Internal Payment Record Status to 'completed';
    note right: BR-02
    |AuctionRepository|
    :(9) Update Auction (e.g., set `paymentReceivedAt`);
    note right: BR-03
endif

|PaymentService|
:(10) Return Success Confirmation;

|Winner|
:(11) Receive Payment Confirmation;
:(12) Proceed to Asset Transfer Steps;
stop
@endumal
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                            |
| :------------ | :-------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)**   | **BR-01** | **Displaying Rules:**<br>❖ The system renders a “PaymentVerificationPage” via `Display_View()` upon the user’s return from Stripe.<br>❖ It displays a loading indicator and a message: "Verifying your winner payment...".                                                                                                                                                                                                 |
| **(4)-(5.1)** | **BR-02** | **Verification Rules (Back-end):**<br>❖ The system calls `PaymentService.verifyWinnerPayment(sessionId, userId)` to verify the payment.<br>❖ It retrieves the `PAYMENT` record using the [sessionId].<br>❖ If the input is not valid:<br>⮚ If the record is not found or the [status] is not 'pending', the system returns a 400 Bad Request.                                                                                                    |
| **(6)**       | **BR-03** | **Payment Gateway Rules:**<br>❖ The system queries Stripe for the session status via `StripeService.retrieveCheckoutSession(sessionId)`.<br>❖ If the input is not valid:<br>⮚ If the Stripe status is not 'complete', the system returns a 400 Bad Request.                                                                                                                                       |
| **(6)**       | **BR-04** | **Financial Rules (Back-end):**<br>❖ The system performs a financial validation via `PaymentService.validateAmount(payment, stripeSession)`.<br>❖ It compares `Stripe.amount_total` with the expected `Payment.amount`.<br>❖ If there is a mismatch, the system logs a warning for manual intervention and returns a 400 Bad Request.                                                                                                            |
| **(8)**       | **BR-05** | **Storing Rules (Back-end):**<br>❖ Upon successful verification, the system updates the `PAYMENT` table by calling `PaymentRepository.updatePaymentStatus()`.<br>❖ It sets the [status] to 'completed' and records the `completedAt` timestamp.                                                                                                                                                                                               |
| **(9)**       | **BR-06** | **Auction Update Rules (Back-end):**<br>❖ The system updates the “AUCTION” table by calling `AuctionRepository.markAuctionAsPaid()`.<br>❖ It sets the [paymentReceivedAt] timestamp to the current time.<br>❖ This action triggers the subsequent asset transfer process.                                                                                                                                                                |
| **(11)-(12)** | **BR-07** | **Displaying Rules (Success):**<br>❖ The system redirects the user to the Asset Transfer Page via `Redirect('AssetTransferPage', { success: true })`.<br>❖ It displays **MSG 7** ("Payment verified successfully.") to the user.<br>❖ The system shows the next steps for asset transfer or collection.                                                                                                                                                                    |
```