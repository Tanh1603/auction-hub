# 3.1.1 Register User in System

## 1. Use Case Description

| Field              | Description                                                                                           |
| ------------------ | ----------------------------------------------------------------------------------------------------- |
| **Name**           | Register User in System                                                                               |
| **Description**    | This use case allows the Guest to create a new User information in the system.                        |
| **Actor**          | Guest                                                                                                 |
| **Trigger**        | When the Guest clicks on the 'Register' button on the RegistrationPage.                               |
| **Pre-condition**  | • Guest's device must be connected to the internet.<br>• Guest is on the RegistrationPage.            |
| **Post-condition** | The User information will be stored into the system and display verification email sent confirmation. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Guest" as User
boundary "RegistrationPage" as View
control "AuthController" as Controller
control "AuthService" as Service
database "SupabaseService" as Supabase
database "UserRepository" as Repo

User -> View: Fill Registration Form\n(email, password, phone, type, etc.)
View -> Controller: POST /auth/register
activate Controller

Controller -> Service: register(RegisterDto)
activate Service

Service -> Service: Validate DTO & Business Rules
note right: Check taxId for business users

alt Validation Failed
    Service --> Controller: Throw Validation Error
    Controller --> View: 400 Bad Request
    View --> User: Display Error Message
else Validation Success
    Service -> Supabase: signUp(email, password)
    activate Supabase
    Supabase --> Service: AuthResponse (User UID)
    deactivate Supabase

    alt Supabase Failed
        Service --> Controller: Throw Auth Error
        Controller --> View: 400 Bad Request
        View --> User: Display Auth Error Message
    else Supabase Success
        Service -> Repo: create(uid, email, role='bidder', ...)
        activate Repo
        Repo --> Service: UserEntity
        deactivate Repo

        alt DB Creation Success
            Service --> Controller: RegistrationSuccessResponse
            Controller --> View: 201 Created
            View --> User: Show Success Message (Check Email)
        else DB Creation Failed
            Service -> Supabase: deleteUser(uid) (Rollback)
            activate Supabase
            Supabase --> Service: Deletion Confirmed
            deactivate Supabase
            Service --> Controller: Throw Internal Server Error
            Controller --> View: 500 Internal Server Error
            View --> User: Display System Error
        end
    end
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Guest|
start
:(1) Fill Registration Form;
:(2) Submit Registration Request;

|AuthService|
:(3) Validate Input Data;
note right: BR-01, BR-03

if (Validation Passed?) then (No)
    :(4.1) Return Validation Error;
    |Guest|
    :(4.2) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(5) Request Account Creation to Supabase;
endif

|SupabaseService|
:(6) Create Auth User;
:(7) Generate UID;

if (Auth Created?) then (No)
    |AuthService|
    :(8.1) Return Auth Error;
    |Guest|
    :(8.2) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(9) Receive Supabase UID;
    :(10) Prepare Local User Data;
    note right: BR-02
    :(11) Save User to Database;
endif

|UserRepository|
:(12) Insert User Record;

if (Insert Success?) then (No)
    |AuthService|
    :(13.1) Rollback Supabase Account;
    :(13.2) Return System Error;
    |Guest|
    :(13.3) View Error Message;
    stop
else (Yes)
    |AuthService|
    :(14) Trigger Verification Email;
    note right: BR-04
    :(15) Return Success Response;
endif

|Guest|
:(16) Receive Confirmation;
:(17) Check Email for Verification;
stop
@enduml
```

## 4. Business Rules

| Activity | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :------- | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**  | **BR-01** | **Displaying Rule:**<br>The system displays a 'RegistrationPage' screen. (Refer to 'RegistrationPage' view in 'View Description' file).<br>The form contains input fields for: email, password, phone, userType, taxId (conditional), and other required registration data.                                                                                                                                                                                                                                  |
| **(1)**  | **BR-02** | **Validation Rule (Front-end):**<br>When user enters information, system uses `Text_change()` method.<br>Checks if input is valid (empty, wrong format).<br>If `isEmpty()` on mandatory fields → display **MSG 1** (Mandatory field required).<br>If wrong email format → display **MSG 4** (Invalid format).<br>If `userType = 'business'` and `taxId` is empty → display **MSG 1**.                                                                                                                        |
| **(2)**  | **BR-03** | **Validation Rule (Back-end/Save):**<br>When user clicks 'Register' button, send data to database via function `register(RegisterDto)`.<br>Check table `USERS` for email uniqueness constraint.<br>If email exists → show **MSG 2** (Conflict - Email already registered).<br>Else, proceed to Supabase account creation.                                                                                                                                                                                    |
| **(12)** | **BR-04** | **Storing Rule:**<br>The input data will be checked by table `USERS` in the database (Refer to 'USERS' table in 'DB Sheet' file) to check if there are any constraints. Else data of the User will be stored as a new record in table `USERS`.<br>Set role = 'bidder', status = 'UNVERIFIED'.<br>If insert fails → call rollback via `deleteUser(uid)` on Supabase, show **MSG 9** (System Error), close view.<br>Else → show **MSG 7** (Success), trigger verification email, display confirmation message. |
| **(16)** | **BR-05** | **Displaying Rule (Confirmation):**<br>The system displays a success confirmation screen instructing user to check their email for verification link.<br>User is redirected or shown the 'Check Email' instruction view.                                                                                                                                                                                                                                                                                     |
