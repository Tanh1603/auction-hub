# 3.6.7 Initiate Winner Payment

## 1. Use Case Description

| Field              | Description                                                                                                                                                                |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Initiate Winner Payment                                                                                                                                                    |
| **Description**    | This use case allows the Winner to create a Payment Session in the system. This generates a payment session (via Stripe) for the calculated balance.                       |
| **Actor**          | Winner (Bidder)                                                                                                                                                            |
| **Trigger**        | When the Winner clicks "Pay Final Amount" on the auction result page, triggering `POST /auction-finalization/submit-winner-payment`.                                       |
| **Pre-condition**  | • Winner's device must be connected to the internet.<br>• Winner is signed in with their account and is the confirmed winning bidder for the auction.                      |
| **Post-condition** | A Payment record of type `winning_payment` is created with status `pending`, a Stripe Checkout Session is created, and the Winner receives the checkout URL in the system. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Winner" as User
boundary "WinnerPaymentPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "AuctionRepository" as AuctionRepo
entity "PaymentRepository" as PaymentRepo

User -> View: Click "Pay Final Amount"
View -> Controller: POST /auction-finalization/submit-winner-payment\n{ auctionId }
activate Controller

Controller -> Service: initiateWinnerPayment(auctionId, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Verify Winner & Payment Status
note right: BR-01, BR-03

Service -> Service: Calculate Remaining Balance
note right: BR-02

Service -> PayService: createPaymentSession(user, auction, 'winning_payment', amount)
activate PayService

PayService -> Stripe: sessions.create(...)
activate Stripe
Stripe --> PayService: Session Object
deactivate Stripe

PayService -> PaymentRepo: create({ type: 'winning_payment', status: 'pending', ... })
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity
deactivate PaymentRepo

PayService --> Service: PaymentUrl
deactivate PayService

Service --> Controller: { url: string }
Controller --> View: 200 OK (Redirect JSON)
View --> User: Redirect to Stripe Checkout
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
' Use diamond style for cleaner conditionals
skinparam conditionStyle diamond

|Winner|
start
:"(1) Request to Pay Final Amount";

|FinalizationService|
:"(2) Authenticate Requestor";
:"(3) Verify Winner Identity";
note right: BR-01

|PaymentRepository|
:"(4) Check Payment History";

|FinalizationService|
' FIX: Quoted the condition string to handle the '?' safely
if ("Already Paid?") then (Yes)
    :"(5.1) Return 400 Bad Request";
    |Winner|
    :"(5.2) View Error Message";
    stop
endif

|FinalizationService|
:"(6) Calculate Outstanding Balance";
note right: BR-02

|StripeService|
:"(7) Initiate Payment Session";
:"(8) Create Session";
:"(9) Return URL";

|PaymentRepository|
:"(10) Record Pending Payment";

|FinalizationService|
:"(11) Return URL";

|Winner|
:"(12) Redirect to Payment Gateway";
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :------------ | :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**       | **BR-01** | **Displaying Rules:**<br>❖ The system renders the “WinnerPaymentPage” screen via `Display_View()`.<br>❖ It displays a [Pay Final Amount] button, which is enabled only if the payment is not yet `completed` and the user is the confirmed winner.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ||
| **(1)**       | **BR-02** | **Validation Rules (Front-end):**<br>❖ When the Winner clicks “Pay Final Amount”, the system triggers a confirmation modal via `Display_Modal('ConfirmationBox')`.<br>❖ It presents **MSG 11** ("Proceed to payment for [Amount]?"), awaiting explicit confirmation before redirecting to the payment gateway.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **(2)-(3)**   | **BR-03** | **Authorization Rules (Back-end):**<br>❖ The system checks the authenticated user's role via `FinalizationService.initiateWinnerPayment()`.<br>❖ If the input is not valid:<br>⮚ It verifies that the authenticated user is indeed the `winningBidderId` in the “AUCTION” table.<br>⮚ If the user is not the winner, the system returns a 403 Forbidden status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **(4)-(5.1)** | **BR-04** | **Idempotency Rules (Back-end):**<br>❖ The system calls `PaymentRepository.findWinningPayment(auctionId, userId)` to check for existing `PAYMENT` records.<br>❖ It looks for a record with [type] as 'winning_payment' and [status] as 'completed'.<br>❖ If such a payment is found, the system returns a 400 Bad Request, displaying **MSG 16** (Payment already completed) to prevent duplicate transactions.                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
| **(6)**       | **BR-05** | **Calculation Rules (Back-end):**<br>❖ The system calculates the outstanding balance by calling `FinalizationService.calculateOutstandingBalance()`.<br>❖ The formula used is: `balance = [finalSalePrice] + [saleFee] - [depositAmountSnapshot]`.<br>❖ The system ensures that the calculated balance is greater than 0 before proceeding.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(7)-(9)**   | **BR-06** | **Payment Gateway Rules:**<br>❖ The system initiates a Stripe Checkout Session via `PaymentService.createPaymentSession(amount, type='winning_payment')`.<br>❖ It calls the Stripe API to create `checkout.sessions.create()` with the calculated amount.<br>❖ The system configures `success_url` and `cancel_url` for redirects after payment completion or cancellation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(10)**      | **BR-07** | **Storing Rules (Back-end):**<br>❖ The system creates a new record in the “PAYMENT” table via `PaymentRepository.create()`.<br>❖ It sets [type] to 'winning_payment', [status] to 'pending', and records the [sessionId] from Stripe and the calculated [amount].                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(12)**      | **BR-08** | **Displaying Rules (Redirect):**<br>❖ The system redirects the user to the Stripe hosted checkout page using `Redirect_External(stripeCheckoutUrl)` to complete the payment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
