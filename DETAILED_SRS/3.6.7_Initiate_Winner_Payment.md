# 3.6.7 Initiate Winner Payment

## 1. Use Case Description

| Field              | Description                                                                                                                                                                |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Initiate Winner Payment                                                                                                                                                    |
| **Description**    | This use case allows the Winner to create a Payment Session in the system. This generates a payment session (via Stripe) for the calculated balance.                       |
| **Actor**          | Winner (Bidder)                                                                                                                                                            |
| **Trigger**        | When the Winner clicks "Pay Final Amount" on the auction result page, triggering `POST /auction-finalization/submit-winner-payment`.                                       |
| **Pre-condition**  | • Winner's device must be connected to the internet.<br>• Winner is signed in with their account and is the confirmed winning bidder for the auction.                      |
| **Post-condition** | A Payment record of type `winning_payment` is created with status `pending`, a Stripe Checkout Session is created, and the Winner receives the checkout URL in the system. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Winner" as User
boundary "WinnerPaymentPage" as View
control "FinalizationController" as Controller
control "FinalizationService" as Service
control "PaymentService" as PayService
entity "StripeService" as Stripe
entity "AuctionRepository" as AuctionRepo
entity "PaymentRepository" as PaymentRepo

User -> View: Click "Pay Final Amount"
View -> Controller: POST /auction-finalization/submit-winner-payment\n{ auctionId }
activate Controller

Controller -> Service: initiateWinnerPayment(auctionId, userId)
activate Service

Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity
deactivate AuctionRepo

Service -> Service: Verify Winner & Payment Status
note right: BR-01, BR-03

Service -> Service: Calculate Remaining Balance
note right: BR-02

Service -> PayService: createPaymentSession(user, auction, 'winning_payment', amount)
activate PayService

PayService -> Stripe: sessions.create(...)
activate Stripe
Stripe --> PayService: Session Object
deactivate Stripe

PayService -> PaymentRepo: create({ type: 'winning_payment', status: 'pending', ... })
activate PaymentRepo
PaymentRepo --> PayService: PaymentEntity
deactivate PaymentRepo

PayService --> Service: PaymentUrl
deactivate PayService

Service --> Controller: { url: string }
Controller --> View: 200 OK (Redirect JSON)
View --> User: Redirect to Stripe Checkout
deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
' Use diamond style for cleaner conditionals
skinparam conditionStyle diamond

|Winner|
start
:"(1) Request to Pay Final Amount";

|FinalizationService|
:"(2) Authenticate Requestor";
:"(3) Verify Winner Identity";
note right: BR-01

|PaymentRepository|
:"(4) Check Payment History";

|FinalizationService|
' FIX: Quoted the condition string to handle the '?' safely
if ("Already Paid?") then (Yes)
    :"(5.1) Return 400 Bad Request";
    |Winner|
    :"(5.2) View Error Message";
    stop
endif

|FinalizationService|
:"(6) Calculate Outstanding Balance";
note right: BR-02

|StripeService|
:"(7) Initiate Payment Session";
:"(8) Create Session";
:"(9) Return URL";

|PaymentRepository|
:"(10) Record Pending Payment";

|FinalizationService|
:"(11) Return URL";

|Winner|
:"(12) Redirect to Payment Gateway";
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                    |
| :------------ | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**       | **BR-01** | **Displaying Rule (Winner Payment Page):**<br>When Winner views payment requirements, system displays "Pay Final Amount" button.<br>Button is enabled only if payment not yet completed.                                                                                                                                       |
| **(1)**       | **BR-02** | **Validation Rule (Confirmation - Front-end):**<br>When Winner clicks "Pay Final Amount", system displays MSG 11 ("Proceed to payment for [amount]?").<br>System waits for confirmation before redirecting.                                                                                                                    |
| **(2)-(3)**   | **BR-03** | **Validation Rule (Winner-Only Access - Back-end):**<br>System verifies authenticated user is the `winningBidderId` in `AUCTION` table.<br>If not the winner:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                                                                |
| **(4)-(5.1)** | **BR-04** | **Validation Rule (Duplicate Prevention - Back-end):**<br>System retrieves data from the 'PAYMENT' table in the database (Refer to 'PAYMENT' table in 'DB Sheet' file) to check for existing completed winning payment.<br>If already paid:<br>$\rightarrow$ System displays MSG 16 ("Payment already completed") on the View. |
| **(6)**       | **BR-05** | **Processing Rule (Balance Calculation):**<br>System calculates outstanding balance:<br>$balance = finalSalePrice + fees - depositAmountSnapshot$<br>This is the amount to charge via Stripe.                                                                                                                                  |
| **(7)-(9)**   | **BR-06** | **Processing Rule (Stripe Session):**<br>System creates Stripe Checkout Session with calculated amount.<br>System includes success/cancel redirect URLs.                                                                                                                                                                       |
| **(10)**      | **BR-07** | **Storing Rule:**<br>System creates record in `PAYMENT` table:<br>- `type = 'winning_payment'`<br>- `status = 'pending'`<br>- `sessionId = [Stripe session ID]`<br>- `amount = [calculated balance]`                                                                                                                           |
| **(12)**      | **BR-08** | **Displaying Rule (Redirect):**<br>System redirects Winner to Stripe Checkout URL.<br>Winner completes payment on Stripe's hosted page.                                                                                                                                                                                        |
