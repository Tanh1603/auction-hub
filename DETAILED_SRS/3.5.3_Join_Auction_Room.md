# 3.5.3 Join Auction Room

## 1. Use Case Description

| Field              | Description                                                                                                           |
| ------------------ | --------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Join Auction Room                                                                                                     |
| **Description**    | This use case allows the User to create a new WebSocket Connection information in the system.                         |
| **Actor**          | User                                                                                                                  |
| **Trigger**        | When the User navigates to the AuctionDetailPage screen.                                                              |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.                         |
| **Post-condition** | The WebSocket Connection information will be stored into the system and display auction updates on AuctionDetailPage. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "AuctionDetailPage" as View
boundary "WebSocketClient" as WSClient
control "WebSocketGateway" as WSGateway
control "AuctionService" as Service
entity "AuctionRepository" as AuctionRepo

User -> View: Navigate to Auction Details
View -> WSClient: Establish WebSocket Connection
WSClient -> WSGateway: Connect (with JWT)
activate WSGateway
WSGateway -> WSGateway: Authenticate Connection (BR-01)

WSClient -> WSGateway: Emit `joinAuction` (auctionId)
WSGateway -> Service: getAuctionState(auctionId)
activate Service
Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity (or null)
deactivate AuctionRepo

alt Auction Not Found
    Service --> WSGateway: Throw NotFoundException
    WSGateway --> WSClient: Emit `error` event
    WSClient --> View: Display Error Message
    View --> User: Inform of Error
else Auction Found
    Service --> WSGateway: CurrentAuctionState
    deactivate Service

    WSGateway -> WSGateway: Add Client to Auction Room
    note right: BR-03
    WSGateway -> WSClient: Emit `auctionState` (CurrentAuctionState)
    note right: BR-04
    WSClient -> View: Update UI with AuctionStateDto
    View --> User: Display Current Auction State
end

deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Load Auction Page;

|WebSocketClient|
:(2) Establish WebSocket Connection;
:(3) Emit "joinAuction" Event;

|WebSocketGateway|
:(4) Receive "joinAuction" Event;
:(5) Authenticate Connection;
note right: BR-01

:(6) Validate Auction ID;
note right: BR-02

if (Auction Valid?) then (No)
    :(7.1) Emit "error" Event to Client;
    |User|
    :(7.2) View Error;
    stop
endif

|AuctionRepository|
:(8) Retrieve Current Auction State;

|WebSocketGateway|
:(9) Subscribe Client to Auction Room;
note right: BR-03

:(10) Emit "auctionState" Event to Client;
note right: BR-04

|User|
:(11) Receive Initial Auction State;
:(12) Display Live Data;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)**       | **BR-01** | **Displaying Rule (Auction Detail Page):**<br>When user navigates to auction details, system displays `AuctionDetailPage`.<br>System initiates WebSocket connection in background.<br>System displays loading state while connecting.                                                                                      |
| **(2)-(3)**   | **BR-02** | **Validation Rule (WebSocket Authentication - Front-end):**<br>System establishes WebSocket connection with JWT token.<br>System emits `joinAuction` event with `auctionId` parameter.                                                                                                                                     |
| **(5)**       | **BR-03** | **Validation Rule (Connection Authentication - Back-end):**<br>System validates JWT token on WebSocket connection.<br>If invalid/expired:<br>$\rightarrow$ System emits `error` event to client with MSG 14 ("Authentication failed").                                                                                     |
| **(6)-(7.1)** | **BR-04** | **Validation Rule (Auction Existence - Back-end):**<br>System retrieves data from the 'AUCTION' table in the database (Refer to 'AUCTION' table in 'DB Sheet' file) based on the auction ID to verify it exists.<br>If not found:<br>$\rightarrow$ System emits `error` event to client with MSG 20 ("Auction not found"). |
| **(9)**       | **BR-05** | **Processing Rule (Room Subscription):**<br>System subscribes client socket to auction-specific room.<br>All future real-time updates for this auction are broadcast to this room.                                                                                                                                         |
| **(10)**      | **BR-06** | **Displaying Rule (Initial State):**<br>System emits `auctionState` event to client with current auction data.<br>Client updates UI to show: current highest bid, time remaining, auction status.<br>System displays live auction interface ready for bidding.                                                             |
| **(5)**       | **BR-07** | **Processing Rule (Role-Based Filtering):**<br>System may filter `auctionState` data based on user role.<br>Guests receive less detail than authenticated bidders.                                                                                                                                                         |
