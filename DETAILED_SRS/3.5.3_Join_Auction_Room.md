# 3.5.3 Join Auction Room

## 1. Use Case Description

| Field              | Description                                                                                                           |
| ------------------ | --------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Join Auction Room                                                                                                     |
| **Description**    | This use case allows the User to create a new WebSocket Connection information in the system.                         |
| **Actor**          | User                                                                                                                  |
| **Trigger**        | When the User navigates to the AuctionDetailPage screen.                                                              |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• User is signed in with their account.                         |
| **Post-condition** | The WebSocket Connection information will be stored into the system and display auction updates on AuctionDetailPage. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "AuctionDetailPage" as View
boundary "WebSocketClient" as WSClient
control "WebSocketGateway" as WSGateway
control "AuctionService" as Service
entity "AuctionRepository" as AuctionRepo

User -> View: Navigate to Auction Details
View -> WSClient: Establish WebSocket Connection
WSClient -> WSGateway: Connect (with JWT)
activate WSGateway
WSGateway -> WSGateway: Authenticate Connection (BR-01)

WSClient -> WSGateway: Emit `joinAuction` (auctionId)
WSGateway -> Service: getAuctionState(auctionId)
activate Service
Service -> AuctionRepo: findById(auctionId)
activate AuctionRepo
AuctionRepo --> Service: AuctionEntity (or null)
deactivate AuctionRepo

alt Auction Not Found
    Service --> WSGateway: Throw NotFoundException
    WSGateway --> WSClient: Emit `error` event
    WSClient --> View: Display Error Message
    View --> User: Inform of Error
else Auction Found
    Service --> WSGateway: CurrentAuctionState
    deactivate Service

    WSGateway -> WSGateway: Add Client to Auction Room
    note right: BR-03
    WSGateway -> WSClient: Emit `auctionState` (CurrentAuctionState)
    note right: BR-04
    WSClient -> View: Update UI with AuctionStateDto
    View --> User: Display Current Auction State
end

deactivate WSGateway
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Load Auction Page;

|WebSocketClient|
:(2) Establish WebSocket Connection;
:(3) Emit "joinAuction" Event;

|WebSocketGateway|
:(4) Receive "joinAuction" Event;
:(5) Authenticate Connection;
note right: BR-01

:(6) Validate Auction ID;
note right: BR-02

if (Auction Valid?) then (No)
    :(7.1) Emit "error" Event to Client;
    |User|
    :(7.2) View Error;
    stop
endif

|AuctionRepository|
:(8) Retrieve Current Auction State;

|WebSocketGateway|
:(9) Subscribe Client to Auction Room;
note right: BR-03

:(10) Emit "auctionState" Event to Client;
note right: BR-04

|User|
:(11) Receive Initial Auction State;
:(12) Display Live Data;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)**       | **BR-01** | **Displaying Rules:**<br>❖ The system displays the “AuctionDetailPage” screen via `Display_View(auctionId)`.<br>❖ It shows a loading indicator for real-time data.<br>❖ A WebSocket connection is implicitly established in the background upon page load.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **(2)-(3)**   | **BR-02** | **Connection Rules (Front-end):**<br>❖ The system establishes a WebSocket connection using the user’s JWT token for authentication via `WebSocketClient.connect(jwt)`.<br>❖ Immediately after connection, it emits a `joinAuction` event with the relevant `auctionId`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **(5)**       | **BR-03** | **Authentication Rules (Back-end):**<br>❖ The system validates the JWT token provided during the WebSocket connection via `WebSocketGateway.onConnect()`.<br>❖ If the input is not valid:<br>⮚ If the token is invalid or expired, the system disconnects the client.<br>⮚ It emits an `error` event to the client with **MSG 14** (Authentication Failed).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(6)-(7.1)** | **BR-04** | **Validation Rules (Back-end):**<br>❖ The system handles the `joinAuction` event via `WebSocketGateway.handleJoinAuction(auctionId)`.<br>❖ It queries the “AUCTION” table by `auctionId` to verify the auction's existence.<br>❖ If the input is not valid:<br>⮚ If the auction is not found, the system emits an `error` event to the client with **MSG 20** (Auction not found).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **(9)**       | **BR-05** | **Processing Rules (Subscription):**<br>❖ The system calls `WebSocketGateway.joinRoom(socket, auctionId)` to add the client socket to a dynamic room.<br>❖ This room is named after the `auctionId`, ensuring all future broadcasts for this specific auction are targeted correctly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **(10)**      | **BR-06** | **Notification Rules (Initial State):**<br>❖ The system sends the current auction state to the joining client by emitting an `auctionState` event via `WebSocketGateway.emitAuctionState(socket, auctionStateDto)`.<br>❖ The client updates its UI with the latest bid, timer, and other relevant information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |