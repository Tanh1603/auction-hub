# 3.4.13 Final Approval (Tier 2)

## 1. Use Case Description

| Field              | Description                                                                                                             |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Final Approval (Tier 2)                                                                                                 |
| **Description**    | This use case allows the Admin to update existing Registration information in the system.                               |
| **Actor**          | Admin                                                                                                                   |
| **Trigger**        | When the Admin clicks on the 'Final Approve' button on the RegistrationApprovalPage.                                    |
| **Pre-condition**  | • Admin's device must be connected to the internet.<br>• Admin is signed in with their account.                         |
| **Post-condition** | The Registration information will be updated in the system and display new record on RegistrationApprovalPage datagrid. |

## 2. Sequence Flow (MVC)

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "Admin" as User
boundary "RegistrationApprovalPage" as View
control "RegistrationController" as Controller
control "RegistrationService" as Service
entity "ParticipantRepository" as ParticipantRepo

User -> View: Verify Payment (Offline/Bank Transfer)
User -> View: Click "Final Approve"
View -> Controller: POST /register-to-bid/admin/final-approval\n{ auctionId, userId }
activate Controller

Controller -> Service: finalApproval(auctionId, userId)
activate Service

Service -> ParticipantRepo: findParticipant(auctionId, userId)
activate ParticipantRepo
ParticipantRepo --> Service: ParticipantEntity
deactivate ParticipantRepo

alt Not Found
    Service --> Controller: Throw NotFoundException
    Controller --> View: 404 Not Found
    View --> User: Display Error Message
else Found
    ' FIX: Combined message onto one line; used \n for visual line breaks
    Service -> ParticipantRepo: updateParticipant({ status: 'FINAL_APPROVED', \nconfirmedAt: now(), depositPaidAt: now() })
    activate ParticipantRepo
    ParticipantRepo --> Service: UpdatedParticipant
    deactivate ParticipantRepo

    Service --> Controller: SuccessResponse
    Controller --> View: 200 OK (Approved)
    View --> User: Display Success Confirmation
end

deactivate Service
deactivate Controller
@enduml
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|Admin|
start
:(1) Verify Deposit Payment (Manual/Bank);
:(2) Select Registration;
:(3) Submit Final Approval;

|RegistrationService|
:(4) Authenticate & Authorize;
note right: BR-01

:(5) Retrieve Participant Record;

|ParticipantRepository|
:(6) Query Participant;

|RegistrationService|
if (Record Found?) then (No)
    :(7.1) Return 404 Not Found;
    |Admin|
    :(7.2) View Error Message;
    stop
endif

|ParticipantRepository|
:(8) Set confirmedAt = Now;
:(9) Set status = FINAL_APPROVED;
:(10) Ensure depositPaidAt is set;
note right: BR-02

|RegistrationService|
:(11) Return Success;

|Admin|
:(12) View Status: Approved;
stop
@enduml
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                             |
| :------------ | :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **(1)-(2)**   | **BR-01** | **Displaying Rule (Registration Approval Page):**<br>When Admin verifies offline/bank payment, system displays `RegistrationApprovalPage`.<br>System displays current registration status (typically `DOCUMENTS_VERIFIED`).<br>System displays "Final Approve" button.                                                                  |
| **(3)**       | **BR-02** | **Validation Rule (Confirmation - Front-end):**<br>When Admin clicks "Final Approve" button, system displays MSG 11 ("Confirm final approval? This will mark deposit as paid.").<br>System waits for confirmation before proceeding.                                                                                                    |
| **(4)**       | **BR-03** | **Validation Rule (Authorization - Back-end):**<br>System checks if requestor role is `admin` or `auctioneer` in `USERS` table.<br>If unauthorized:<br>$\rightarrow$ System displays MSG 5 ("Forbidden") on the View.                                                                                                                   |
| **(6)-(7.1)** | **BR-04** | **Validation Rule (Record Existence - Back-end):**<br>System retrieves data from the 'AUCTION_PARTICIPANT' table in the database (Refer to 'AUCTION_PARTICIPANT' table in 'DB Sheet' file) based on the auction ID and user ID.<br>If record not found:<br>$\rightarrow$ System displays MSG 20 ("Registration not found") on the View. |
| **(7.1)**     | **BR-05** | **Validation Rule (Idempotency - Back-end):**<br>If participant status is already `FINAL_APPROVED`:<br>$\rightarrow$ System returns success without re-processing (idempotent behavior).                                                                                                                                                |
| **(8)-(10)**  | **BR-06** | **Storing Rule:**<br>System saves to `AUCTION_PARTICIPANT` table:<br>- `confirmedAt = now()`<br>- `depositPaidAt = now()` (if not already set)<br>- `status = 'FINAL_APPROVED'`<br>Bidder is now eligible to check in for auction.                                                                                                      |
| **(12)**      | **BR-07** | **Displaying Rule (Success Confirmation):**<br>System displays MSG 7 ("Registration fully approved") on the View.<br>System refreshes registration status showing `FINAL_APPROVED`.                                                                                                                                                     |
