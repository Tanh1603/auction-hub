# 3.7.2 Verify Payment

## 1. Use Case Description

| Field              | Description                                                                                                                                                                                       |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Name**           | Verify Payment                                                                                                                                                                                    |
| **Description**    | This use case allows the System to update Payment status in the system. This involves querying Stripe for the session status and updating the internal Payment record accordingly.                |
| **Actor**          | Bidder, Winner, System (via Webhook)                                                                                                                                                              |
| **Trigger**        | When the User is redirected from Stripe to `GET /payments/verify?session_id=xxx` or a Stripe webhook notification notifies the backend.                                                           |
| **Pre-condition**  | • User's device must be connected to the internet.<br>• A Payment record with a `pending` status and associated `sessionId` exists.                                                               |
| **Post-condition** | The Payment record's status is updated to `completed`, `failed`, or `refunded` based on Stripe's status and dependent system processes are triggered if the payment is `completed` in the system. |

<h2>2. Sequence Flow (MVC)</h2>

```plantuml
@startuml
autonumber
skinparam sequenceMessageAlign center

actor "User" as User
boundary "PaymentVerificationPage" as View
control "PaymentController" as Controller
control "PaymentService" as Service
entity "StripeService" as Stripe
entity "PaymentRepository" as PaymentRepo
control "RegistrationService" as RegService

User -> View: Completes Payment on Stripe
View -> View: Redirected back to App (with session_id)
View -> Controller: GET /payments/verify?session_id=xxx
activate Controller

Controller -> Service: verifyPayment(sessionId, userId)
activate Service

Service -> PaymentRepo: findPaymentBySessionId(sessionId)
activate PaymentRepo
PaymentRepo --> Service: PaymentEntity (status: pending)
deactivate PaymentRepo

alt Payment Not Found or Already Processed
    Service --> Controller: Throw BadRequest/Conflict
    Controller --> View: 400/409 Error
    View --> User: Display Error Message
else Pending Payment Found
    Service -> Stripe: retrieveCheckoutSession(sessionId)
    activate Stripe
    Stripe --> Service: Session Object (status: 'complete'/'open'/'expired')
    deactivate Stripe

    alt Stripe Session Complete
        Service -> PaymentRepo: updatePaymentStatus(paymentId, 'completed')
        activate PaymentRepo
        PaymentRepo --> Service: UpdatedPayment
        deactivate PaymentRepo

        alt Payment Type is Deposit
            Service -> RegService: markDepositPaid(payment.auctionId, payment.userId)
            activate RegService
            RegService --> Service: Success
            deactivate RegService
        end

        Service --> Controller: SuccessResponse
        Controller --> View: 200 OK (Payment Verified)
        View --> User: Display Confirmation
    else Stripe Session Not Complete
        Service -> PaymentRepo: updatePaymentStatus(paymentId, 'failed')
        activate PaymentRepo
        PaymentRepo --> Service: UpdatedPayment
        deactivate PaymentRepo
        Service --> Controller: Throw BadRequestException
        Controller --> View: 400 Error (Payment not complete)
        View --> User: Display Error Message
    end
end

deactivate Service
deactivate Controller
@endumal
```

## 3. Activities Flow (Swimlanes)

```plantuml
@startuml
|User|
start
:(1) Completes Payment;
:(2) Redirected to Application;

|PaymentService|
:(3) Receive Verification Request (sessionId);

|PaymentRepository|
:(4) Retrieve Internal Payment Record;

|PaymentService|
if (Record Exists & Pending?) then (No)
    :(5.1) Return Error (e.g., Invalid session, Already processed);
    |User|
    :(5.2) View Error Message;
    stop
endif

|StripeService|
:(6) Query Stripe for Session Status;

|PaymentService|
if (Stripe Status == 'complete'?) then (Yes)
    :(7.1) Update Internal Payment Record Status to 'completed';
    note right: BR-02
    |RegistrationService|
    :(7.2) Trigger Dependent Processes (e.g., update `AuctionParticipant` for deposit);
    note right: BR-03
    |PaymentService|
    :(8) Return Success;
else (No)
    |PaymentService|
    :(9.1) Update Internal Payment Record Status to 'failed' or 'pending';
    :(9.2) Return Error;
    |User|
    :(9.3) View Error Message;
    stop
endif

|User|
:(10) View Payment Confirmation / Error;
stop
@endumal
```

## 4. Business Rules

| Activity      | BR Code   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| :------------ | :-------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **(1)-(2)**   | **BR-01** | **Displaying Rules:**<br>❖ The system renders a “PaymentVerificationPage” via `Display_View()` upon the user’s return from Stripe.<br>❖ It displays a loading indicator while verifying the payment status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **(4)-(5.1)** | **BR-02** | **Verification Rules (Back-end):**<br>❖ The system calls `PaymentService.verifyPayment(sessionId, userId)` to verify the payment.<br>❖ It retrieves the `PAYMENT` record using the [sessionId].<br>❖ If the input is not valid:<br>⮚ If the record is not found or the [status] is not 'pending', the system returns a 400 Bad Request (Invalid/processed payment).                                                                                                                                                                                                                                                                                                                                                                                 |
| **(6)**       | **BR-03** | **Payment Gateway Rules:**<br>❖ The system queries Stripe for the session status via `StripeService.retrieveCheckoutSession(sessionId)`.<br>❖ If the input is not valid:<br>⮚ If the Stripe status is not 'complete', the system updates the `PAYMENT` record to 'failed' and returns a 400 Bad Request.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(7.1)**     | **BR-04** | **Storing Rules (Back-end):**<br>❖ Upon successful verification, the system calls `PaymentRepository.update()` to update the database.<br>❖ It sets the [status] to 'completed' and records the `completedAt` timestamp.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **(7.2)**     | **BR-05** | **Processing Rules (Dependent Trigger):**<br>❖ The system triggers dependent processes via `PaymentService.triggerDependentProcesses(payment)`.<br>❖ If the [payment.type] is 'deposit', it updates the “AUCTION_PARTICIPANT” table, setting `depositPaidAt` to now and [status] to 'FINAL_APPROVED'.<br>❖ If the [payment.type] is 'winning_payment', it updates the “AUCTION” table, setting `paymentReceivedAt` to now.                                                                                                                                                                                                                                                                                                                                                         |
| **(10)**      | **BR-06** | **Displaying Rules (Success):**<br>❖ The system redirects the user to the appropriate page based on the payment type via `Redirect_To_Appropriate_Page()`.<br>❖ It displays **MSG 7** ("Payment verified successfully.") to the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
                                                                                                                                                                        |