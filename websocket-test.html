<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Auction Testing</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .connection-status {
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        font-weight: bold;
      }
      .connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .input-group {
        margin: 20px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      button {
        background: #4caf50;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .danger {
        background: #f44336;
      }
      .danger:hover {
        background: #da190b;
      }
      .log-container {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 5px;
        height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        margin-top: 20px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid transparent;
      }
      .log-info {
        border-left-color: #4caf50;
      }
      .log-success {
        border-left-color: #2196f3;
        background: rgba(33, 150, 243, 0.1);
      }
      .log-error {
        border-left-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
      }
      .log-warning {
        border-left-color: #ff9800;
      }
      .timestamp {
        color: #888;
        font-size: 12px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .stat-card {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
      .winner-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .winner-card .stat-label {
        color: rgba(255, 255, 255, 0.8);
      }
      .winner-card .stat-value {
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéØ WebSocket Manual Bid & Winner Price Testing</h1>

      <div id="connectionStatus" class="connection-status disconnected">
        ‚ùå Disconnected
      </div>

      <div class="input-group">
        <label>Server URL:</label>
        <input
          type="text"
          id="serverUrl"
          value="http://localhost:3000/bidding"
          placeholder="http://localhost:3000/bidding"
        />
      </div>

      <div class="input-group">
        <label>Auction ID:</label>
        <input type="text" id="auctionId" placeholder="Enter auction ID" />
      </div>

      <div>
        <button onclick="connectSocket()">üîå Connect</button>
        <button onclick="disconnectSocket()" class="danger">
          ‚ùå Disconnect
        </button>
        <button onclick="joinAuction()">üéØ Join Auction</button>
        <button onclick="leaveAuction()">üëã Leave Auction</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Time Remaining</div>
          <div class="stat-value" id="timeRemaining">--:--:--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Bids</div>
          <div class="stat-value" id="totalBids">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Next Minimum Bid</div>
          <div class="stat-value" id="nextMinBid">$0</div>
        </div>
      </div>

      <div class="winner-card" id="winnerCard" style="display: none">
        <div class="stat-label">üèÜ Current Winner</div>
        <div class="stat-value" id="winnerName">--</div>
        <div class="stat-label" style="margin-top: 10px">üí∞ Winning Price</div>
        <div class="stat-value" id="winnerPrice">$0</div>
      </div>

      <h3>üìä Real-time Logs</h3>
      <div class="log-container" id="logContainer"></div>
    </div>

    <script>
      let socket = null;
      let currentAuctionId = null;

      function log(message, type = 'info') {
        const logContainer = document.getElementById('logContainer');
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateStatus(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
          status.className = 'connection-status connected';
          status.textContent = `‚úÖ Connected (Socket ID: ${socket.id})`;
        } else {
          status.className = 'connection-status disconnected';
          status.textContent = '‚ùå Disconnected';
        }
      }

      function updateWinnerDisplay(winningBid) {
        const winnerCard = document.getElementById('winnerCard');
        if (winningBid) {
          winnerCard.style.display = 'block';
          document.getElementById('winnerName').textContent =
            winningBid.bidderName || '--';
          document.getElementById('winnerPrice').textContent = `$${(
            winningBid.amount || 0
          ).toLocaleString()}`;
        } else {
          winnerCard.style.display = 'none';
        }
      }

      function formatTime(ms) {
        const seconds = Math.floor((ms / 1000) % 60);
        const minutes = Math.floor((ms / (1000 * 60)) % 60);
        const hours = Math.floor(ms / (1000 * 60 * 60));
        return `${hours.toString().padStart(2, '0')}:${minutes
          .toString()
          .padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      function connectSocket() {
        const serverUrl = document.getElementById('serverUrl').value;

        if (socket && socket.connected) {
          log('Already connected!', 'warning');
          return;
        }

        log(`Connecting to ${serverUrl}...`, 'info');

        socket = io(serverUrl, {
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: 5,
        });

        socket.on('connect', () => {
          log('‚úÖ Connected to server!', 'success');
          updateStatus(true);
        });

        socket.on('disconnect', (reason) => {
          log(`‚ùå Disconnected: ${reason}`, 'error');
          updateStatus(false);
        });

        socket.on('connect_error', (error) => {
          log(`‚ùå Connection error: ${error.message}`, 'error');
        });

        // Auction state (on join)
        socket.on('auctionState', (data) => {
          log('üìä Received auction state', 'success');
          log(`<strong>Auction:</strong> ${data.name} (${data.code})`, 'info');
          log(`<strong>Status:</strong> ${data.status}`, 'info');
          log(`<strong>Total Bids:</strong> ${data.totalBids}`, 'info');

          document.getElementById('totalBids').textContent = data.totalBids;
          document.getElementById(
            'nextMinBid'
          ).textContent = `$${data.nextMinimumBid.toLocaleString()}`;

          if (data.currentWinningBid) {
            log(
              `üèÜ <strong>Current Winner:</strong> ${
                data.currentWinningBid.bidderName
              } - $${data.currentWinningBid.amount.toLocaleString()}`,
              'success'
            );
            updateWinnerDisplay(data.currentWinningBid);
          } else {
            log('No bids yet', 'info');
          }
        });

        // New bid event
        socket.on('newBid', (data) => {
          log('üí∞ <strong>NEW BID!</strong>', 'success');
          if (data.currentWinningBid) {
            log(`üèÜ Winner: ${data.currentWinningBid.bidderName}`, 'success');
            log(
              `üíµ Amount: $${data.currentWinningBid.amount.toLocaleString()}`,
              'success'
            );
            updateWinnerDisplay(data.currentWinningBid);
          }
          document.getElementById('totalBids').textContent = data.totalBids;
          document.getElementById(
            'nextMinBid'
          ).textContent = `$${data.nextMinimumBid.toLocaleString()}`;
        });

        // Time updates (every second) - NOW INCLUDES WINNER PRICE!
        socket.on('timeUpdate', (data) => {
          const {
            timeRemaining,
            currentWinningBid,
            nextMinimumBid,
            totalBids,
          } = data;

          // Update display
          document.getElementById('timeRemaining').textContent =
            formatTime(timeRemaining);

          // ‚úÖ Winner price is now streamed every second!
          if (currentWinningBid) {
            updateWinnerDisplay(currentWinningBid);
            // Log every 10 seconds to avoid spam
            if (Math.floor(timeRemaining / 1000) % 10 === 0) {
              log(
                `‚è±Ô∏è Time: ${formatTime(timeRemaining)} | üèÜ Winner: ${
                  currentWinningBid.bidderName
                } - $${currentWinningBid.amount.toLocaleString()}`,
                'info'
              );
            }
          }

          if (nextMinimumBid) {
            document.getElementById(
              'nextMinBid'
            ).textContent = `$${nextMinimumBid.toLocaleString()}`;
          }

          if (totalBids !== undefined) {
            document.getElementById('totalBids').textContent = totalBids;
          }

          if (data.hasEnded) {
            log('üèÅ <strong>AUCTION HAS ENDED!</strong>', 'warning');
          }
        });

        // Auction updates
        socket.on('auctionUpdate', (data) => {
          log(
            `üì¢ <strong>Auction Update:</strong> ${JSON.stringify(data)}`,
            'warning'
          );
          if (data.type === 'AUCTION_ENDED') {
            log('üèÅ Auction ended!', 'warning');
          }
          if (data.winningBid) {
            log(
              `üèÜ Final Winner: ${data.winningBid.winnerName} - $${data.winningBid.amount}`,
              'success'
            );
          }
        });

        // Bid denied
        socket.on('bidDenied', (data) => {
          log(`‚õî <strong>Bid Denied:</strong> ${data.deniedReason}`, 'error');
        });

        // Join confirmation
        socket.on('joinedAuction', (data) => {
          log(`‚úÖ Joined auction: ${data.auctionId}`, 'success');
        });

        // Leave confirmation
        socket.on('leftAuction', (data) => {
          log(`üëã Left auction: ${data.auctionId}`, 'info');
        });

        // Error
        socket.on('error', (data) => {
          log(`‚ùå Error: ${data.message}`, 'error');
        });
      }

      function disconnectSocket() {
        if (socket) {
          socket.disconnect();
          log('Disconnected manually', 'info');
          updateStatus(false);
        }
      }

      function joinAuction() {
        const auctionId = document.getElementById('auctionId').value;

        if (!auctionId) {
          log('‚ùå Please enter an auction ID', 'error');
          return;
        }

        if (!socket || !socket.connected) {
          log('‚ùå Not connected to server', 'error');
          return;
        }

        currentAuctionId = auctionId;
        log(`Joining auction: ${auctionId}`, 'info');
        socket.emit('joinAuction', { auctionId });
      }

      function leaveAuction() {
        if (!currentAuctionId) {
          log('‚ùå Not in any auction', 'error');
          return;
        }

        if (!socket || !socket.connected) {
          log('‚ùå Not connected to server', 'error');
          return;
        }

        log(`Leaving auction: ${currentAuctionId}`, 'info');
        socket.emit('leaveAuction', currentAuctionId);
        currentAuctionId = null;
      }

      function clearLogs() {
        document.getElementById('logContainer').innerHTML = '';
        log('Logs cleared', 'info');
      }

      // Auto-connect on load
      window.addEventListener('load', () => {
        log('üéØ WebSocket Testing Tool Ready', 'success');
        log('Instructions:', 'info');
        log('1. Enter auction ID', 'info');
        log('2. Click "Connect"', 'info');
        log('3. Click "Join Auction"', 'info');
        log('4. Watch real-time updates!', 'info');
      });
    </script>
  </body>
</html>
