// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = ".././generated"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  individual
  business
}

enum UserRole {
  bidder
  auctioneer
  admin
  super_admin
}

enum PaymentType {
  deposit
  participation_fee
  winning_payment
  refund
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum PaymentMethod {
  bank_transfer
  e_wallet
  cash
}

model User {
  id              String    @id @db.Uuid
  email           String    @unique @db.VarChar(255)
  phoneNumber     String?   @unique @map("phone_number") @db.VarChar(20)
  fullName        String    @map("full_name") @db.VarChar(255)
  identityNumber  String?   @unique @map("identity_number") @db.VarChar(20)
  userType        UserType  @map("user_type")
  role            UserRole  @default(bidder)
  taxId           String?   @map("tax_id") @db.VarChar(50)
  avatarUrl       String?   @map("avatar_url") @db.VarChar(500)
  isVerified      Boolean   @default(false) @map("is_verified")
  isBanned        Boolean   @default(false) @map("is_banned")
  banReason       String?   @map("ban_reason") @db.Text
  bannedAt        DateTime? @map("banned_at") @db.Timestamptz(6)
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)
  ratingScore     Decimal   @default(5.00) @map("rating_score") @db.Decimal(3, 2)
  totalRatings    Int       @default(0) @map("total_ratings")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  // Note: ownedAuctions relation removed - Auction.propertyOwner is now a JSON field
  participations           AuctionParticipant[]
  deniedBids               AuctionBid[]         @relation("BidDenier")
  contractsAsPropertyOwner Contract[]           @relation("ContractPropertyOwner")
  contractsAsBuyer         Contract[]           @relation("ContractBuyer")
  contractsCreated         Contract[]           @relation("ContractCreator")
  auditLogs                AuctionAuditLog[]    @relation("AuditPerformer")
  payments                 Payment[]
  documentsVerified        AuctionParticipant[] @relation("DocumentVerifier")
  registrationsConfirmed   AuctionParticipant[] @relation("RegistrationConfirmer")

  @@map("users")
}

// AUCTIONS
model Auction {
  id                             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  // propertyOwner                  String        @map("property_owner") @db.Uuid
  propertyOwner                  Json          @map("property_owner") @db.JsonB
  name                           String        @db.VarChar(255)
  code                           String        @unique @db.VarChar(55)
  saleStartAt                    DateTime      @map("sale_start_at") @db.Timestamptz(6)
  saleEndAt                      DateTime      @map("sale_end_at") @db.Timestamptz(6)
  saleFee                        Decimal       @map("sale_fee") @db.Decimal(18, 2)
  viewTime                       String        @map("view_time") @db.VarChar(100)
  depositEndAt                   DateTime      @map("deposit_end_at") @db.Timestamptz(6)
  depositAmountRequired          Decimal       @map("deposit_amount_required") @db.Decimal(18, 2)
  auctionStartAt                 DateTime      @map("auction_start_at") @db.Timestamptz(6)
  auctionEndAt                   DateTime      @map("auction_end_at") @db.Timestamptz(6)
  assetDescription               String        @map("asset_description") @db.Text
  assetAddress                   String        @map("asset_address") @db.VarChar(255)
  validCheckInBeforeStartMinutes Int           @map("valid_check_in_before_start_minutes")
  validCheckInAfterStartMinutes  Int           @map("valid_check_in_after_start_minutes")
  startingPrice                  Decimal       @map("starting_price") @db.Decimal(18, 2)

  reservePrice                   Decimal?      @map("reserve_price") @db.Decimal(18, 2)
  bidIncrement                   Decimal       @map("bid_increment") @db.Decimal(18, 2)
  // isActive                       Boolean       @default(true) @map("is_active")
  assetType                      AssetType     @map("asset_type")
  numberOfFollow                 Int           @default(0) @map("number_of_follow")
  status                         AuctionStatus @default(scheduled)

  // Fees set by admin (validated against policy)
  dossierFee        Decimal?  @map("dossier_fee") @db.Decimal(18, 2)
  depositPercentage Decimal?  @map("deposit_percentage") @db.Decimal(5, 2)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Media stored as JsonB for flexibility
  // images           Json?                   @db.JsonB
  // attachments      Json?                   @db.JsonB

  // Financial summary (moved from AuctionFinancialSummary)
  // These fields store frozen calculation results after auction finalization
  finalSalePrice           Decimal?  @map("final_sale_price") @db.Decimal(18, 2)
  commissionFee            Decimal?  @map("commission_fee") @db.Decimal(18, 2)
  startingPriceSnapshot    Decimal?  @map("starting_price_snapshot") @db.Decimal(18, 2)
  dossierFeeSnapshot       Decimal?  @map("dossier_fee_snapshot") @db.Decimal(18, 2)
  depositAmountSnapshot    Decimal?  @map("deposit_amount_snapshot") @db.Decimal(18, 2)
  totalAuctionCosts        Decimal?  @map("total_auction_costs") @db.Decimal(18, 2)
  totalFeesToPropertyOwner Decimal?  @default(0) @map("total_fees_to_property_owner") @db.Decimal(18, 2)
  netAmountToPropertyOwner Decimal?  @default(0) @map("net_amount_to_property_owner") @db.Decimal(18, 2)
  calculationDetails       Json?     @map("calculation_details")
  financialCalculatedAt    DateTime? @map("financial_calculated_at") @db.Timestamptz(6)
  images                         Json?         @db.JsonB
  attachments                    Json?         @db.JsonB
  assetWardId                    Int           @map("asset_ward_id") @db.Integer
  assetProvinceId                Int           @map("asset_province_id") @db.Integer

  // owner            User                    @relation("AuctionOwner", fields: [propertyOwner], references: [id])
  participants     AuctionParticipant[]
  bids             AuctionBid[]
  contracts        Contract[]
  auditLogs        AuctionAuditLog[]
  relatedFrom      AuctionRelation[]       @relation("AuctionRelationFrom")
  relatedTo        AuctionRelation[]       @relation("AuctionRelationTo")
  costs            AuctionCost?

  assetWard     Location @relation(name: "AuctionWard", fields: [assetWardId], references: [id])
  assetProvince Location @relation(name: "AuctionProvince", fields: [assetProvinceId], references: [id])

  @@map("auctions")
}

model Location {
  id        Int        @id
  name      String
  value     Int
  sortOrder Int        @map("sort_order")
  parentId  Int?
  parent    Location?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children  Location[] @relation("LocationHierarchy")

  wardAuctions     Auction[] @relation("AuctionWard")
  provinceAuctions Auction[] @relation("AuctionProvince")

  @@map("locations")
}

enum AssetType {
  secured_asset
  land_use_rights
  administrative_violation_asset
  state_asset
  enforcement_asset
  other_asset

  @@map("asset_type")
}

enum AuctionStatus {
  scheduled
  live
  awaiting_result
  success
  failed

  @@map("auction_status")
}

model AuctionRelation {
  auctionId        String   @map("auction_id") @db.Uuid
  relatedAuctionId String   @map("related_auction_id") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  auction        Auction @relation("AuctionRelationFrom", fields: [auctionId], references: [id], onDelete: Cascade)
  relatedAuction Auction @relation("AuctionRelationTo", fields: [relatedAuctionId], references: [id], onDelete: Cascade)

  @@id([auctionId, relatedAuctionId])
  @@map("auction_relations")
}

// Auction Costs (Module 4)
// Variable costs for each auction
model AuctionCost {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auctionId         String    @unique @map("auction_id") @db.Uuid

  // Cost categories
  advertisingCost   Decimal?  @default(0) @map("advertising_cost") @db.Decimal(18, 2)
  venueRentalCost   Decimal?  @default(0) @map("venue_rental_cost") @db.Decimal(18, 2)
  appraisalCost     Decimal?  @default(0) @map("appraisal_cost") @db.Decimal(18, 2)
  assetViewingCost  Decimal?  @default(0) @map("asset_viewing_cost") @db.Decimal(18, 2)
  otherCosts        Json?     @map("other_costs") // Array of { description, amount, documentUrl }

  // Total
  totalCosts        Decimal   @default(0) @map("total_costs") @db.Decimal(18, 2)

  // Supporting documents
  documents         Json?     // Array of document URLs

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  auction           Auction   @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@map("auction_costs")
}



// ============================================
// SYSTEM CONFIGURATION
// ============================================
model SystemVariable {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  category    String   @db.VarChar(100)  // "deposit", "commission", "dossier", "general"
  key         String   @db.VarChar(255)  // "deposit.general.min_percentage"
  value       String   @db.Text          // Stored as string, parsed by type
  dataType    String   @default("string") @map("data_type") @db.VarChar(20)  // "number", "boolean", "string", "json"
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  updatedBy   String?  @map("updated_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([category, key])
  @@index([category])
  @@map("system_variables")
}

// ============================================
// PARTICIPANTS
// ============================================
model AuctionParticipant {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String    @map("user_id") @db.Uuid
  auctionId               String    @map("auction_id") @db.Uuid

  // Registration timestamps
  registeredAt            DateTime? @map("registered_at") @db.Timestamptz(6)
  submittedAt             DateTime? @map("submitted_at") @db.Timestamptz(6)

  // Two-tier approval: Tier 1 - Document verification
  documentsVerifiedAt     DateTime? @map("documents_verified_at") @db.Timestamptz(6)
  documentsVerifiedBy     String?   @map("documents_verified_by") @db.Uuid
  documentsRejectedAt     DateTime? @map("documents_rejected_at") @db.Timestamptz(6)
  documentsRejectedReason String?   @map("documents_rejected_reason") @db.Text

  // Documents and media stored as JsonB for flexibility (similar to Auction model)
  documents               Json?     @map("documents") @db.JsonB // Array of document objects: [{ url, publicId, type, sortOrder }]
  media                   Json?     @map("media") @db.JsonB // Array of media objects: [{ url, publicId, sortOrder }]

  // Two-tier approval: Tier 2 - Deposit verification
  depositPaidAt           DateTime? @map("deposit_paid_at") @db.Timestamptz(6)
  depositAmount           Decimal?  @map("deposit_amount") @db.Decimal(18, 2)
  depositPaymentId        String?   @map("deposit_payment_id") @db.Uuid

  // Final approval (after both document and deposit verification)
  confirmedAt             DateTime? @map("confirmed_at") @db.Timestamptz(6)
  confirmedBy             String?   @map("confirmed_by") @db.Uuid

  // Legacy rejection (keeping for backward compatibility)
  rejectedAt              DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectedReason          String?   @map("rejected_reason") @db.VarChar(255)

  // Other states
  checkedInAt             DateTime? @map("checked_in_at") @db.Timestamptz(6)
  withdrawnAt             DateTime? @map("withdrawn_at") @db.Timestamptz(6)
  withdrawalReason        String?   @map("withdrawal_reason") @db.VarChar(500)

  // Disqualification state
  isDisqualified          Boolean   @default(false) @map("is_disqualified")
  disqualifiedAt          DateTime? @map("disqualified_at") @db.Timestamptz(6)
  disqualifiedReason      String?   @map("disqualified_reason") @db.VarChar(500)

  // Refund state
  refundStatus            String?   @map("refund_status") @db.VarChar(50)
  refundRequestedAt       DateTime? @map("refund_requested_at") @db.Timestamptz(6)
  refundProcessedAt       DateTime? @map("refund_processed_at") @db.Timestamptz(6)

  // Relations
  user              User             @relation(fields: [userId], references: [id])
  auction           Auction          @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bids              AuctionBid[]
  autoBidSettings   AutoBidSetting[]
  documentsVerifier User?            @relation("DocumentVerifier", fields: [documentsVerifiedBy], references: [id])
  confirmer         User?            @relation("RegistrationConfirmer", fields: [confirmedBy], references: [id])

  @@unique([auctionId, userId])
  @@map("auction_participants")
}

// ============================================
// BIDDING
// ============================================
model AuctionBid {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auctionId        String    @map("auction_id") @db.Uuid
  participantId    String    @map("participant_id") @db.Uuid
  amount           Decimal   @db.Decimal(18, 2)
  bidAt            DateTime  @map("bid_at") @db.Timestamptz(6)
  bidType          BidType   @default(manual) @map("bid_type")
  isWinningBid     Boolean   @default(false) @map("is_winning_bid")
  isWithdrawn      Boolean   @default(false) @map("is_withdrawn")
  withdrawnAt      DateTime? @map("withdrawn_at") @db.Timestamptz(6)
  withdrawalReason String?   @map("withdrawal_reason") @db.VarChar(255)
  deniedAt         DateTime? @map("denied_at") @db.Timestamptz(6)
  isDenied         Boolean   @default(false) @map("is_denied")
  deniedBy         String?   @map("denied_by") @db.Uuid
  deniedReason     String?   @map("denied_reason") @db.VarChar(255)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  auction     Auction            @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  participant AuctionParticipant @relation(fields: [participantId], references: [id])
  denier      User?              @relation("BidDenier", fields: [deniedBy], references: [id])
  contracts   Contract[]

  @@map("auction_bids")
}

enum BidType {
  manual
  auto

  @@map("bid_type")
}

model AutoBidSetting {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  participantId   String   @map("participant_id") @db.Uuid
  maxAmount       Decimal  @map("max_amount") @db.Decimal(20, 2)
  incrementAmount Decimal  @map("increment_amount") @db.Decimal(20, 2)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  participant AuctionParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@map("auto_bid_settings")
}

// ============================================
// CONTRACTS
// ============================================
model Contract {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auctionId           String         @map("auction_id") @db.Uuid
  winningBidId        String         @map("winning_bid_id") @db.Uuid
  propertyOwnerUserId String?        @map("property_owner_user_id") @db.Uuid
  buyerUserId         String         @map("buyer_user_id") @db.Uuid
  createdBy           String         @map("created_by") @db.Uuid
  price               Decimal        @db.Decimal(18, 2)
  status              ContractStatus
  signedAt            DateTime?      @map("signed_at") @db.Timestamptz(6)
  cancelledAt         DateTime?      @map("cancelled_at") @db.Timestamptz(6)
  docUrl              String?        @map("doc_url") @db.VarChar(1000)
  createdAt           DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  auction       Auction    @relation(fields: [auctionId], references: [id])
  winningBid    AuctionBid @relation(fields: [winningBidId], references: [id])
  propertyOwner User?      @relation("ContractPropertyOwner", fields: [propertyOwnerUserId], references: [id])
  buyer         User       @relation("ContractBuyer", fields: [buyerUserId], references: [id])
  creator       User       @relation("ContractCreator", fields: [createdBy], references: [id])

  @@map("contracts")
}

enum ContractStatus {
  draft
  signed
  cancelled
  completed

  @@map("contract_status")
}

// ============================================
// AUDIT LOGS
// ============================================
model AuctionAuditLog {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auctionId      String         @map("auction_id") @db.Uuid
  performedBy    String         @map("performed_by") @db.Uuid
  action         AuditAction
  previousStatus AuctionStatus? @map("previous_status")
  newStatus      AuctionStatus? @map("new_status")
  reason         String?        @db.Text
  notes          String?        @db.Text
  metadata       Json?
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user    User    @relation("AuditPerformer", fields: [performedBy], references: [id])

  @@map("auction_audit_logs")
}

enum AuditAction {
  STATUS_OVERRIDE
  BID_DENIED
  PARTICIPANT_APPROVED
  PARTICIPANT_REJECTED
  AUCTION_FINALIZED
  CONTRACT_CREATED
  AUCTION_CREATED
  AUCTION_UPDATED
  AUCTION_CANCELLED

  @@map("audit_action")
}

// ============================================
// PAYMENTS
// ============================================
model Payment {
  id             String         @id @default(uuid()) @db.Uuid
  userId         String         @map("user_id") @db.Uuid
  auctionId      String?        @map("auction_id") @db.Uuid
  registrationId String?        @map("registration_id") @db.Uuid
  paymentType    PaymentType    @map("payment_type")
  amount         Decimal        @db.Decimal(20, 2)
  currency       String         @default("VND") @db.VarChar(3)
  status         PaymentStatus  @default(pending)
  paymentMethod  PaymentMethod? @map("payment_method")
  transactionId  String?        @map("transaction_id") @db.VarChar(100)
  bankCode       String?        @map("bank_code") @db.VarChar(50)
  paymentDetails Json?          @map("payment_details")
  paidAt         DateTime?      @map("paid_at") @db.Timestamptz(6)
  refundedAt     DateTime?      @map("refunded_at") @db.Timestamptz(6)
  refundReason   String?        @map("refund_reason") @db.Text
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@map("payments")
}

// ============================================
// ARTICLES
// ============================================
model Article {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        ArticleType
  title       String      @db.VarChar(255)
  description String      @db.Text
  image       Json?       @db.JsonB
  author      String      @db.VarChar(255)
  content     String      @db.Text
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  relatedFrom ArticleRelation[] @relation("ArticleRelationFrom")
  relatedTo   ArticleRelation[] @relation("ArticleRelationTo")

  @@map("articles")
}

model ArticleRelation {
  articleId        String @db.Uuid
  relatedArticleId String @db.Uuid

  article        Article @relation("ArticleRelationFrom", fields: [articleId], references: [id], onDelete: Cascade)
  relatedArticle Article @relation("ArticleRelationTo", fields: [relatedArticleId], references: [id], onDelete: Cascade)

  @@id([articleId, relatedArticleId])
  @@index([articleId])
  @@index([relatedArticleId])
  @@map("article_relations")
}

enum ArticleType {
  news
  auction_notice
  auction_report
  legal_document

  @@map("article_type")
}
